name: Deploy to IPFS

on:
  push:
    branches: [main, develop]
    paths:
      - 'packages/client/**'
      - 'packages/admin/**'
      - 'packages/shared/**'
  pull_request:
    paths:
      - 'packages/client/**'
      - 'packages/admin/**'
      - 'packages/shared/**'
  workflow_dispatch:
    inputs:
      app:
        description: 'App to deploy'
        required: true
        type: choice
        options:
          - both
          - client
          - admin

# Required permissions for PR comments and commit status
permissions:
  contents: read
  pull-requests: write
  statuses: write

jobs:
  deploy:
    name: Deploy ${{ matrix.title }} to IPFS
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - app: client
            title: Client
            build: build:client
            dist: packages/client/dist
            icon: ðŸŒ±
            prod_app_url: https://greengoods.app
            prod_domain: greengoods.app
            prod_dnslink_name: _dnslink
            staging_app_url: https://staging.greengoods.app
            staging_domain: staging.greengoods.app
            staging_dnslink_name: _dnslink.staging

          - app: admin
            title: Admin
            build: build:admin
            dist: packages/admin/dist
            icon: ðŸ› ï¸
            prod_app_url: https://admin.greengoods.app
            prod_domain: admin.greengoods.app
            prod_dnslink_name: _dnslink.admin
            staging_app_url: https://admin-staging.greengoods.app
            staging_domain: admin-staging.greengoods.app
            staging_dnslink_name: _dnslink.admin-staging

    outputs:
      cid: ${{ steps.ipfs.outputs.cid }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Restore Bun cache
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Determine environment
        id: env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "env=production" >> $GITHUB_OUTPUT
            echo "chain_id=42161" >> $GITHUB_OUTPUT
            echo "app_url=${{ matrix.prod_app_url }}" >> $GITHUB_OUTPUT
            echo "domain=${{ matrix.prod_domain }}" >> $GITHUB_OUTPUT
            echo "dnslink_name=${{ matrix.prod_dnslink_name }}" >> $GITHUB_OUTPUT
          else
            echo "env=staging" >> $GITHUB_OUTPUT
            echo "chain_id=84532" >> $GITHUB_OUTPUT
            echo "app_url=${{ matrix.staging_app_url }}" >> $GITHUB_OUTPUT
            echo "domain=${{ matrix.staging_domain }}" >> $GITHUB_OUTPUT
            echo "dnslink_name=${{ matrix.staging_dnslink_name }}" >> $GITHUB_OUTPUT
          fi

      - name: Build ${{ matrix.title }}
        run: bun run ${{ matrix.build }}
        env:
          VITE_USE_HASH_ROUTER: 'true'
          VITE_CHAIN_ID: ${{ steps.env.outputs.chain_id }}
          VITE_WALLETCONNECT_PROJECT_ID: ${{ secrets.VITE_WALLETCONNECT_PROJECT_ID }}
          VITE_PIMLICO_API_KEY: ${{ secrets.VITE_PIMLICO_API_KEY }}
          VITE_ENVIO_INDEXER_URL: ${{ secrets.VITE_ENVIO_INDEXER_URL }}
          VITE_POSTHOG_KEY: ${{ secrets.VITE_POSTHOG_KEY }}
          VITE_POSTHOG_HOST: "https://app.posthog.com"
          VITE_APP_URL: ${{ steps.env.outputs.app_url }}

      - name: Deploy to IPFS
        id: ipfs
        uses: ipshipyard/ipfs-deploy-action@v1
        with:
          path-to-deploy: ${{ matrix.dist }}
          # Primary: Storacha (free, permanent storage)
          storacha-key: ${{ secrets.VITE_STORACHA_KEY }}
          storacha-proof: ${{ secrets.VITE_STORACHA_PROOF }}
          # Optional: Pinata (fast gateway, redundancy - remove if not using)
          pinata-jwt-token: ${{ secrets.PINATA_JWT }}
          # PR features (comments, commit status)
          github-token: ${{ github.token }}

      - name: Validate deployment
        if: steps.ipfs.outputs.cid == ''
        run: |
          echo "âŒ IPFS deployment failed: no CID returned"
          exit 1

      - name: Deployment Summary
        if: steps.ipfs.outputs.cid != ''
        run: |
          echo "## ${{ matrix.icon }} ${{ matrix.title }} deployed to IPFS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ steps.env.outputs.env }}" >> $GITHUB_STEP_SUMMARY
          echo "**Chain ID:** ${{ steps.env.outputs.chain_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**CID:** \`${{ steps.ipfs.outputs.cid }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Update DNSLink" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Set TXT record \`${{ steps.env.outputs.dnslink_name }}\` on \`${{ steps.env.outputs.domain }}\` to:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "dnslink=/ipfs/${{ steps.ipfs.outputs.cid }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ Gateway Links" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [Storacha Gateway](https://${{ steps.ipfs.outputs.cid }}.ipfs.w3s.link)" >> $GITHUB_STEP_SUMMARY
          echo "- [dweb.link](https://${{ steps.ipfs.outputs.cid }}.ipfs.dweb.link)" >> $GITHUB_STEP_SUMMARY
          echo "- [Service Worker Gateway](https://${{ steps.ipfs.outputs.cid }}.ipfs.inbrowser.link)" >> $GITHUB_STEP_SUMMARY
          echo "- [Cloudflare](https://${{ steps.ipfs.outputs.cid }}.ipfs.cf-ipfs.com)" >> $GITHUB_STEP_SUMMARY
