name: Deploy to IPFS

on:
  push:
    branches: [main, develop]
    paths:
      - 'packages/client/**'
      - 'packages/admin/**'
      - 'packages/shared/**'
  pull_request:
    paths:
      - 'packages/client/**'
      - 'packages/admin/**'
      - 'packages/shared/**'
  workflow_dispatch:
    inputs:
      app:
        description: 'App to deploy'
        required: true
        type: choice
        options:
          - both
          - client
          - admin

# Required permissions for PR comments and commit status
permissions:
  contents: read
  pull-requests: write
  statuses: write

jobs:
  deploy:
    name: Deploy ${{ matrix.title }} to IPFS
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - app: client
            title: Client
            build: build:client
            dist: packages/client/dist
            icon: ðŸŒ±
            prod_app_url: https://greengoods.app
            prod_domain: greengoods.app
            prod_dnslink_name: _dnslink
            staging_app_url: https://staging.greengoods.app
            staging_domain: staging.greengoods.app
            staging_dnslink_name: _dnslink.staging

          - app: admin
            title: Admin
            build: build:admin
            dist: packages/admin/dist
            icon: ðŸ› ï¸
            prod_app_url: https://admin.greengoods.app
            prod_domain: admin.greengoods.app
            prod_dnslink_name: _dnslink.admin
            staging_app_url: https://admin-staging.greengoods.app
            staging_domain: admin-staging.greengoods.app
            staging_dnslink_name: _dnslink.admin-staging

    outputs:
      cid: ${{ steps.ipfs.outputs.cid }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Restore Bun cache
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Determine environment
        id: env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "env=production" >> $GITHUB_OUTPUT
            echo "chain_id=42161" >> $GITHUB_OUTPUT
            echo "app_url=${{ matrix.prod_app_url }}" >> $GITHUB_OUTPUT
            echo "domain=${{ matrix.prod_domain }}" >> $GITHUB_OUTPUT
            echo "dnslink_name=${{ matrix.prod_dnslink_name }}" >> $GITHUB_OUTPUT
          else
            echo "env=staging" >> $GITHUB_OUTPUT
            echo "chain_id=84532" >> $GITHUB_OUTPUT
            echo "app_url=${{ matrix.staging_app_url }}" >> $GITHUB_OUTPUT
            echo "domain=${{ matrix.staging_domain }}" >> $GITHUB_OUTPUT
            echo "dnslink_name=${{ matrix.staging_dnslink_name }}" >> $GITHUB_OUTPUT
          fi

      - name: Build ${{ matrix.title }}
        run: bun run ${{ matrix.build }}
        env:
          VITE_USE_HASH_ROUTER: 'true'
          VITE_CHAIN_ID: ${{ steps.env.outputs.chain_id }}
          VITE_WALLETCONNECT_PROJECT_ID: ${{ secrets.VITE_WALLETCONNECT_PROJECT_ID }}
          VITE_PIMLICO_API_KEY: ${{ secrets.VITE_PIMLICO_API_KEY }}
          VITE_ENVIO_INDEXER_URL: ${{ secrets.VITE_ENVIO_INDEXER_URL }}
          VITE_POSTHOG_KEY: ${{ secrets.VITE_POSTHOG_KEY }}
          VITE_POSTHOG_HOST: "https://app.posthog.com"
          VITE_APP_URL: ${{ steps.env.outputs.app_url }}

      - name: Validate Storacha credentials
        env:
          STORACHA_KEY: ${{ secrets.VITE_STORACHA_KEY }}
          STORACHA_PROOF: ${{ secrets.VITE_STORACHA_PROOF }}
        run: |
          # Check that credentials are set
          if [[ -z "$STORACHA_KEY" ]]; then
            echo "::error::VITE_STORACHA_KEY secret is not set"
            exit 1
          fi
          if [[ -z "$STORACHA_PROOF" ]]; then
            echo "::error::VITE_STORACHA_PROOF secret is not set"
            exit 1
          fi
          echo "âœ… Storacha credentials validated"

      # Use the action for CAR creation, CID generation, and optional Pinata upload
      # Storacha upload is handled separately due to CLI migration from w3cli to @storacha/cli
      # The action uses built-in Kubo for CAR creation, so it works even without Pinata
      - name: Create CAR and generate CID
        id: ipfs
        uses: ipshipyard/ipfs-deploy-action@v1.7.0
        with:
          path-to-deploy: ${{ matrix.dist }}
          # Optional: Pinata for fast gateway access and redundancy
          # If PINATA_JWT is not set, the action still works (uses Kubo for CAR/CID)
          pinata-jwt-token: ${{ secrets.PINATA_JWT }}
          # PR features (comments, commit status)
          github-token: ${{ github.token }}

      # Upload to Storacha using the new @storacha/cli
      # The ipfs-deploy-action uses deprecated @web3-storage/w3cli which doesn't
      # support the new CAR-encoded proof format
      - name: Upload to Storacha
        id: storacha
        env:
          STORACHA_PRINCIPAL: ${{ secrets.VITE_STORACHA_KEY }}
          STORACHA_PROOF: ${{ secrets.VITE_STORACHA_PROOF }}
          DIST_PATH: ${{ matrix.dist }}
          EXPECTED_CID: ${{ steps.ipfs.outputs.cid }}
        run: |
          echo "ðŸ“¦ Installing @storacha/cli..."
          npm install -g @storacha/cli

          echo "ðŸ”‘ Adding space from delegation proof..."
          storacha space add "$STORACHA_PROOF"

          echo "ðŸš€ Uploading to Storacha..."
          UPLOAD_OUTPUT=$(storacha up "$DIST_PATH" 2>&1)
          echo "$UPLOAD_OUTPUT"

          # Extract CID from output (storacha up outputs the root CID)
          STORACHA_CID=$(echo "$UPLOAD_OUTPUT" | grep -oE 'bafy[a-zA-Z0-9]+' | head -1)

          if [[ -z "$STORACHA_CID" ]]; then
            echo "::error::Failed to extract CID from Storacha upload"
            exit 1
          fi

          echo "storacha_cid=$STORACHA_CID" >> $GITHUB_OUTPUT

          # Verify CID matches (content-addressed, so should be identical)
          if [[ -n "$EXPECTED_CID" && "$STORACHA_CID" != "$EXPECTED_CID" ]]; then
            echo "::warning::Storacha CID ($STORACHA_CID) differs from Kubo CID ($EXPECTED_CID)"
          fi

          echo "âœ… Storacha upload complete: $STORACHA_CID"

      - name: Validate deployment
        if: steps.ipfs.outputs.cid == ''
        run: |
          echo "âŒ IPFS deployment failed: no CID returned"
          exit 1

      - name: Deployment Summary
        if: steps.ipfs.outputs.cid != ''
        env:
          CID: ${{ steps.ipfs.outputs.cid }}
          STORACHA_CID: ${{ steps.storacha.outputs.storacha_cid }}
          ENV_NAME: ${{ steps.env.outputs.env }}
          CHAIN_ID: ${{ steps.env.outputs.chain_id }}
          DOMAIN: ${{ steps.env.outputs.domain }}
          DNSLINK_NAME: ${{ steps.env.outputs.dnslink_name }}
        run: |
          echo "## ${{ matrix.icon }} ${{ matrix.title }} deployed to IPFS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | $ENV_NAME |" >> $GITHUB_STEP_SUMMARY
          echo "| **Chain ID** | $CHAIN_ID |" >> $GITHUB_STEP_SUMMARY
          echo "| **CID** | \`$CID\` |" >> $GITHUB_STEP_SUMMARY
          if [[ -n "$STORACHA_CID" ]]; then
            echo "| **Storacha CID** | \`$STORACHA_CID\` |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Automated Steps Completed" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Built ${{ matrix.title }} app" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Created CAR file and generated CID" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Uploaded to Storacha (permanent storage)" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Uploaded to Pinata (if configured)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Manual Step: Update DNSLink" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To make \`$DOMAIN\` serve this deployment, update your DNS:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Record Type | Name | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| TXT | \`$DNSLINK_NAME\` | \`dnslink=/ipfs/$CID\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ Gateway Links (available immediately)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [Storacha Gateway](https://$CID.ipfs.w3s.link)" >> $GITHUB_STEP_SUMMARY
          echo "- [dweb.link](https://$CID.ipfs.dweb.link)" >> $GITHUB_STEP_SUMMARY
          echo "- [Service Worker Gateway](https://$CID.ipfs.inbrowser.link)" >> $GITHUB_STEP_SUMMARY
          echo "- [Cloudflare](https://$CID.ipfs.cf-ipfs.com)" >> $GITHUB_STEP_SUMMARY
