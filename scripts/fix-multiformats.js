#!/usr/bin/env node
/**
 * Fix for multiformats/basics import issue
 *
 * This script is run automatically after npm/yarn/bun install to ensure
 * compatibility with older dependencies that still use multiformats/basics
 * which doesn't exist in multiformats v13+
 *
 * Works with:
 * - Local development
 * - GitHub Actions
 * - Vercel deployments
 */

import fs from "fs";
import path from "path";
import { fileURLToPath } from "url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Create multiformats/basics.js compatibility shim
function createMultiformatsBasicsShim() {
  const multiformatsPath = path.join(__dirname, "..", "node_modules", "multiformats");
  const basicsShimPath = path.join(multiformatsPath, "basics.js");
  const packageJsonPath = path.join(multiformatsPath, "package.json");

  // Check if multiformats is installed
  if (!fs.existsSync(multiformatsPath)) {
    console.log("‚è≠Ô∏è  Multiformats not found, skipping fix (might be in CI cache)");
    return;
  }

  // Create the basics.js shim
  const shimContent = `// Compatibility shim for multiformats/basics
// This file provides the old import path for compatibility with older dependencies
// Auto-generated by scripts/fix-multiformats.js - DO NOT EDIT
export * from './dist/src/basics.js';
`;

  fs.writeFileSync(basicsShimPath, shimContent, "utf8");
  console.log("‚úÖ Created multiformats/basics.js compatibility shim");

  // Also patch package.json to add the export
  if (fs.existsSync(packageJsonPath)) {
    try {
      const packageJson = JSON.parse(fs.readFileSync(packageJsonPath, "utf8"));

      // Add basics export if not present
      if (packageJson.exports && typeof packageJson.exports === "object") {
        let needsPatch = false;
        if (!packageJson.exports["./basics"]) {
          packageJson.exports["./basics"] = {
            types: "./dist/src/basics.d.ts",
            import: "./basics.js",
          };
          needsPatch = true;
        }

        // Also ensure the dist/src/basics.js path is available
        if (!packageJson.exports["./dist/src/basics.js"]) {
          packageJson.exports["./dist/src/basics.js"] = {
            types: "./dist/src/basics.d.ts",
            import: "./dist/src/basics.js",
          };
          needsPatch = true;
        }

        if (needsPatch) {
          fs.writeFileSync(packageJsonPath, JSON.stringify(packageJson, null, 2), "utf8");
          console.log("‚úÖ Patched multiformats/package.json to add basics exports");
        }
      }
    } catch (err) {
      console.log("‚ö†Ô∏è  Could not patch package.json, but basics.js shim was created:", err.message);
    }
  }
}

// Patch uint8arrays to use correct import path
function patchUint8arrays() {
  const uint8arraysPath = path.join(__dirname, "..", "node_modules", "uint8arrays");

  if (!fs.existsSync(uint8arraysPath)) {
    console.log("‚è≠Ô∏è  uint8arrays not found, skipping patch");
    return;
  }

  // Patch TypeScript source
  const tsBasesPath = path.join(uint8arraysPath, "src", "util", "bases.ts");
  if (fs.existsSync(tsBasesPath)) {
    let content = fs.readFileSync(tsBasesPath, "utf8");
    if (content.includes("from 'multiformats/basics'")) {
      content = content.replace(
        "import { bases } from 'multiformats/basics'",
        "import { bases } from 'multiformats/dist/src/basics.js'"
      );
      fs.writeFileSync(tsBasesPath, content, "utf8");
      console.log("‚úÖ Patched uint8arrays/src/util/bases.ts");
    }
  }

  // Patch JavaScript dist
  const jsBasesPath = path.join(uint8arraysPath, "dist", "src", "util", "bases.js");
  if (fs.existsSync(jsBasesPath)) {
    let content = fs.readFileSync(jsBasesPath, "utf8");
    if (content.includes("multiformats/basics")) {
      content = content
        .replace(/from ["']multiformats\/basics["']/g, 'from "multiformats/dist/src/basics.js"')
        .replace(/require\(["']multiformats\/basics["']\)/g, 'require("multiformats/dist/src/basics.js")');
      fs.writeFileSync(jsBasesPath, content, "utf8");
      console.log("‚úÖ Patched uint8arrays/dist/src/util/bases.js");
    }
  }
}

// Patch @walletconnect/utils if needed
function patchWalletConnect() {
  // Find all @walletconnect packages
  const walletConnectBase = path.join(__dirname, "..", "node_modules", "@walletconnect");

  if (!fs.existsSync(walletConnectBase)) {
    console.log("‚è≠Ô∏è  @walletconnect not found, skipping patch");
    return;
  }

  // Look for any files that might import multiformats/basics
  const findAndPatchFiles = (dir) => {
    const files = fs.readdirSync(dir);

    files.forEach((file) => {
      const filePath = path.join(dir, file);
      const stat = fs.statSync(filePath);

      if (stat.isDirectory() && !file.startsWith(".") && file !== "node_modules") {
        findAndPatchFiles(filePath);
      } else if (file.endsWith(".js") || file.endsWith(".mjs") || file.endsWith(".cjs")) {
        try {
          let content = fs.readFileSync(filePath, "utf8");
          if (content.includes("multiformats/basics")) {
            const originalContent = content;
            content = content
              .replace(/from ["']multiformats\/basics["']/g, 'from "multiformats/dist/src/basics.js"')
              .replace(/require\(["']multiformats\/basics["']\)/g, 'require("multiformats/dist/src/basics.js")');

            if (content !== originalContent) {
              fs.writeFileSync(filePath, content, "utf8");
              console.log(`‚úÖ Patched ${filePath.replace(walletConnectBase, "@walletconnect")}`);
            }
          }
        } catch (err) {
          // Ignore read errors (might be binary files)
        }
      }
    });
  };

  findAndPatchFiles(walletConnectBase);
}

// Main execution
function main() {
  console.log("üîß Applying multiformats compatibility fixes...");

  // Skip in CI if node_modules is cached and already patched
  const basicsPath = path.join(__dirname, "..", "node_modules", "multiformats", "basics.js");
  if (fs.existsSync(basicsPath) && process.env.CI) {
    console.log("‚úÖ Multiformats already patched (found basics.js), skipping...");
    return;
  }

  try {
    createMultiformatsBasicsShim();
    patchUint8arrays();
    patchWalletConnect();
    console.log("‚úÖ All multiformats compatibility fixes applied successfully!");
  } catch (error) {
    console.error("‚ùå Error applying multiformats fixes:", error);
    // Don't fail the install process
    process.exit(0);
  }
}

// Run the fix
main();
