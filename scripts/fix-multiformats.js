#!/usr/bin/env node
/**
 * Fix for multiformats/basics import issue
 *
 * This script is run automatically after npm/yarn/bun install to ensure
 * compatibility with older dependencies that still use multiformats/basics
 * which doesn't exist in multiformats v13+
 *
 * Works with:
 * - Local development
 * - GitHub Actions
 * - Vercel deployments
 */

import fs from "fs";
import path from "path";
import { fileURLToPath } from "url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Create multiformats/basics.js compatibility shim
function createMultiformatsBasicsShim() {
  const multiformatsPath = path.join(__dirname, "..", "node_modules", "multiformats");
  const basicsShimPath = path.join(multiformatsPath, "basics.js");
  const packageJsonPath = path.join(multiformatsPath, "package.json");

  // Check if multiformats is installed
  if (!fs.existsSync(multiformatsPath)) {
    console.log("‚è≠Ô∏è  Multiformats not found, skipping fix (might be in CI cache)");
    return;
  }

  // Create the basics.js shim
  const shimContent = `// Compatibility shim for multiformats/basics
// This file provides the old import path for compatibility with older dependencies
// Auto-generated by scripts/fix-multiformats.js - DO NOT EDIT
export * from './dist/src/basics.js';
`;

  fs.writeFileSync(basicsShimPath, shimContent, "utf8");
  console.log("‚úÖ Created multiformats/basics.js compatibility shim");

  // Also patch package.json to add the export
  if (fs.existsSync(packageJsonPath)) {
    try {
      const packageJson = JSON.parse(fs.readFileSync(packageJsonPath, "utf8"));

      // Add basics export if not present
      if (packageJson.exports && typeof packageJson.exports === "object") {
        let needsPatch = false;
        if (!packageJson.exports["./basics"]) {
          packageJson.exports["./basics"] = {
            types: "./dist/src/basics.d.ts",
            import: "./basics.js",
          };
          needsPatch = true;
        }

        // Also ensure the dist/src/basics.js path is available
        if (!packageJson.exports["./dist/src/basics.js"]) {
          packageJson.exports["./dist/src/basics.js"] = {
            types: "./dist/src/basics.d.ts",
            import: "./dist/src/basics.js",
          };
          needsPatch = true;
        }

        if (needsPatch) {
          fs.writeFileSync(packageJsonPath, JSON.stringify(packageJson, null, 2), "utf8");
          console.log("‚úÖ Patched multiformats/package.json to add basics exports");
        }
      }
    } catch (err) {
      console.log("‚ö†Ô∏è  Could not patch package.json, but basics.js shim was created:", err.message);
    }
  }
}

// Patch uint8arrays to use correct import path
function patchUint8arrays() {
  const uint8arraysPath = path.join(__dirname, "..", "node_modules", "uint8arrays");

  if (!fs.existsSync(uint8arraysPath)) {
    console.log("‚è≠Ô∏è  uint8arrays not found, skipping patch");
    return;
  }

  // Patch TypeScript source
  const tsBasesPath = path.join(uint8arraysPath, "src", "util", "bases.ts");
  if (fs.existsSync(tsBasesPath)) {
    let content = fs.readFileSync(tsBasesPath, "utf8");
    if (content.includes("from 'multiformats/basics'")) {
      content = content.replace(
        "import { bases } from 'multiformats/basics'",
        "import { bases } from 'multiformats/dist/src/basics.js'"
      );
      fs.writeFileSync(tsBasesPath, content, "utf8");
      console.log("‚úÖ Patched uint8arrays/src/util/bases.ts");
    }
  }

  // Patch JavaScript dist
  const jsBasesPath = path.join(uint8arraysPath, "dist", "src", "util", "bases.js");
  if (fs.existsSync(jsBasesPath)) {
    let content = fs.readFileSync(jsBasesPath, "utf8");
    if (content.includes("multiformats/basics")) {
      content = content
        .replace(/from ["']multiformats\/basics["']/g, 'from "multiformats/dist/src/basics.js"')
        .replace(/require\(["']multiformats\/basics["']\)/g, 'require("multiformats/dist/src/basics.js")');
      fs.writeFileSync(jsBasesPath, content, "utf8");
      console.log("‚úÖ Patched uint8arrays/dist/src/util/bases.js");
    }
  }
}

// Patch @walletconnect/utils if needed
function patchWalletConnect() {
  // Find all @walletconnect packages
  const walletConnectBase = path.join(__dirname, "..", "node_modules", "@walletconnect");

  if (!fs.existsSync(walletConnectBase)) {
    console.log("‚è≠Ô∏è  @walletconnect not found, skipping patch");
    return;
  }

  // Look for any files that might import multiformats/basics
  const findAndPatchFiles = (dir) => {
    const files = fs.readdirSync(dir);

    files.forEach((file) => {
      const filePath = path.join(dir, file);
      const stat = fs.statSync(filePath);

      if (stat.isDirectory() && !file.startsWith(".") && file !== "node_modules") {
        findAndPatchFiles(filePath);
      } else if (file.endsWith(".js") || file.endsWith(".mjs") || file.endsWith(".cjs")) {
        try {
          let content = fs.readFileSync(filePath, "utf8");
          if (content.includes("multiformats/basics")) {
            const originalContent = content;
            content = content
              .replace(/from ["']multiformats\/basics["']/g, 'from "multiformats/dist/src/basics.js"')
              .replace(/require\(["']multiformats\/basics["']\)/g, 'require("multiformats/dist/src/basics.js")');

            if (content !== originalContent) {
              fs.writeFileSync(filePath, content, "utf8");
              console.log(`‚úÖ Patched ${filePath.replace(walletConnectBase, "@walletconnect")}`);
            }
          }
        } catch (err) {
          // Ignore read errors (might be binary files)
        }
      }
    });
  };

  findAndPatchFiles(walletConnectBase);
}

/**
 * Fix Bun's module resolution for cached packages with symlinks.
 *
 * Bun caches packages in .bun/ with symlinks, but module resolution from
 * within .bun/ doesn't follow symlinks correctly. This function replaces
 * symlinks with real copies for packages that need them.
 *
 * Known problematic packages:
 * - EAS SDK requires multiformats
 * - @walletconnect/utils requires uint8arrays
 */
function fixBunCacheSymlinks() {
  const nodeModules = path.join(__dirname, "..", "node_modules");
  const bunCache = path.join(nodeModules, ".bun");

  if (!fs.existsSync(bunCache)) {
    console.log("‚è≠Ô∏è  .bun cache not found, skipping symlink fixes");
    return;
  }

  console.log("üîç Scanning .bun cache for symlink resolution issues...");

  const bunDirs = fs.readdirSync(bunCache);

  // Map of package patterns to their required dependencies that need symlink fixes
  const problematicPackages = [
    {
      pattern: "@ethereum-attestation-service+eas-sdk@",
      deps: ["multiformats"],
    },
    {
      pattern: "@walletconnect+utils@",
      deps: ["uint8arrays", "multiformats"],
    },
    {
      pattern: "@walletconnect+sign-client@",
      deps: ["uint8arrays", "multiformats"],
    },
    {
      pattern: "@walletconnect+core@",
      deps: ["uint8arrays", "multiformats"],
    },
  ];

  // Find source packages in cache (to copy from)
  const packageSources = {};
  for (const dir of bunDirs) {
    // Parse package name from dir (format: package-name@version+hash or @scope+package@version+hash)
    const match = dir.match(/^(@[^+]+\+)?([^@]+)@/);
    if (match) {
      const pkgName = match[1] ? match[1].replace("+", "/") + match[2] : match[2];
      packageSources[pkgName] = path.join(bunCache, dir, "node_modules", pkgName.replace("/", path.sep));
    }
  }

  let fixCount = 0;

  for (const { pattern, deps } of problematicPackages) {
    const matchingDirs = bunDirs.filter(d => d.startsWith(pattern));

    for (const pkgDir of matchingDirs) {
      const pkgNodeModules = path.join(bunCache, pkgDir, "node_modules");

      if (!fs.existsSync(pkgNodeModules)) continue;

      for (const depName of deps) {
        const depPath = path.join(pkgNodeModules, depName);
        const sourcePath = packageSources[depName];

        if (!sourcePath || !fs.existsSync(sourcePath)) {
          continue;
        }

        try {
          const stats = fs.lstatSync(depPath);
          if (stats.isSymbolicLink()) {
            // Replace symlink with real copy
            fs.unlinkSync(depPath);
            copyDirSync(sourcePath, depPath);
            console.log(`‚úÖ Fixed ${pattern}... ‚Üí ${depName}`);
            fixCount++;

            // Patch ESM-only packages to add require export
            patchPackageExports(depPath);
          }
        } catch (err) {
          if (err.code === "ENOENT") {
            // Dependency not linked, might be okay
          } else {
            console.log(`‚ö†Ô∏è  Error fixing ${depName} in ${pkgDir}: ${err.message}`);
          }
        }
      }
    }
  }

  if (fixCount > 0) {
    console.log(`‚úÖ Fixed ${fixCount} symlink(s) in .bun cache`);
  } else {
    console.log("‚úÖ No symlink fixes needed in .bun cache");
  }
}

/**
 * Patch package.json exports to add require field if missing (for ESM-only packages)
 */
function patchPackageExports(pkgPath) {
  const packageJsonPath = path.join(pkgPath, "package.json");
  if (!fs.existsSync(packageJsonPath)) return;

  try {
    const packageJson = JSON.parse(fs.readFileSync(packageJsonPath, "utf8"));

    if (packageJson.exports && packageJson.exports["."]) {
      const mainExport = packageJson.exports["."];
      if (mainExport.import && !mainExport.require) {
        // Add require pointing to same file (Bun handles ESM/CJS interop)
        mainExport.require = mainExport.import;
        fs.writeFileSync(packageJsonPath, JSON.stringify(packageJson, null, 2), "utf8");
      }
    }
  } catch (err) {
    console.log(`‚ö†Ô∏è  Could not patch package.json exports: ${err.message}`);
  }
}

/**
 * Recursively copy a directory
 */
function copyDirSync(src, dest) {
  fs.mkdirSync(dest, { recursive: true });
  const entries = fs.readdirSync(src, { withFileTypes: true });

  for (const entry of entries) {
    const srcPath = path.join(src, entry.name);
    const destPath = path.join(dest, entry.name);

    if (entry.isDirectory()) {
      copyDirSync(srcPath, destPath);
    } else {
      fs.copyFileSync(srcPath, destPath);
    }
  }
}

// Main execution
function main() {
  console.log("üîß Applying multiformats compatibility fixes...");

  // Skip in CI if node_modules is cached and already patched
  const basicsPath = path.join(__dirname, "..", "node_modules", "multiformats", "basics.js");
  if (fs.existsSync(basicsPath) && process.env.CI) {
    console.log("‚úÖ Multiformats already patched (found basics.js), skipping...");
    return;
  }

  try {
    createMultiformatsBasicsShim();
    patchUint8arrays();
    patchWalletConnect();
    fixBunCacheSymlinks();
    console.log("‚úÖ All multiformats compatibility fixes applied successfully!");
  } catch (error) {
    console.error("‚ùå Error applying multiformats fixes:", error);
    // Don't fail the install process
    process.exit(0);
  }
}

// Run the fix
main();
