<!-- 76d0f101-edb2-4c50-97e3-cc08c0337083 3fb3e65f-2369-42fc-adab-30e1ee4c488d -->
# P0-P1 Test Coverage Plan

This plan addresses critical test gaps with ~15-20 new test files using a balanced approach: unit tests for hooks/modules, integration tests for critical flows.

## Phase 1: Cleanup Broken Tests

Delete excluded/broken tests from client package that will be rewritten:

**Files to delete from `packages/client/src/__tests__/`:**

- Delete any files matching patterns in vitest.config.ts exclusions (lines 44-57)
- These include: `hooks/useOffline.test.tsx`, `hooks/useOfflineSync.test.tsx`, `hooks/useConflictResolver.test.tsx`, `hooks/useJobQueueSimplified.test.tsx`, `components/OfflineIndicator.enhanced.test.tsx`, `integration/offline-workflow.test.ts`, `modules/job-processing-simplified.test.ts`, `modules/job-queue-simplified.test.ts`, `providers/app.test.tsx`

**Update vitest.config.ts:**

- Remove exclusion entries for deleted files (lines 44-57 in [`packages/client/vitest.config.ts`](packages/client/vitest.config.ts))

**Files to delete/rewrite in shared:**

- [`packages/shared/src/__tests__/modules/eas.test.ts`](packages/shared/src/__tests__/modules/eas.test.ts) - No assertions, just console.log
- [`packages/shared/src/__tests__/modules/greengoods.test.ts`](packages/shared/src/__tests__/modules/greengoods.test.ts) - No assertions, just console.log
- [`packages/shared/src/__tests__/hooks/useRole.simple.test.ts`](packages/shared/src/__tests__/hooks/useRole.simple.test.ts) - Tests mock objects, not actual hook

---

## Phase 2: Test Infrastructure Setup

### 2.1 Create shared test utilities

**Create `packages/shared/src/__tests__/test-utils/index.ts`:**

- Export `renderHookWithProviders` wrapper (QueryClient, IntlProvider)
- Export `createMockSmartAccountClient` factory
- Export `createMockAuthContext` factory
- Export `createMockWork`, `createMockGarden`, `createMockAction` data factories

**Create `packages/shared/src/__tests__/test-utils/mock-factories.ts`:**

```typescript
// Work draft factory
export const createMockWorkDraft = (overrides?: Partial<WorkDraft>): WorkDraft => ({
  actionUID: 1,
  title: "Test Work",
  feedback: "Test feedback",
  plantSelection: ["Rose", "Tulip"],
  plantCount: 5,
  media: [],
  ...overrides,
});

// Smart account client factory
export const createMockSmartAccountClient = () => ({
  account: { address: "0xTestSmartAccount" },
  sendTransaction: vi.fn().mockResolvedValue("0xTxHash"),
  chain: { id: 84532 },
});
```

### 2.2 Add vitest config for shared package

**Create `packages/shared/vitest.config.ts`:**

- Mirror client config structure
- Setup fake-indexeddb, jsdom environment
- Configure coverage thresholds (60% initial target)

---

## Phase 3: P0 Critical Tests

### 3.1 Passkey Module Tests (Security Critical)

**Create `packages/shared/src/__tests__/modules/passkey.test.ts`:**

Test coverage for [`packages/shared/src/modules/auth/passkey.ts`](packages/shared/src/modules/auth/passkey.ts):

| Test Case | What it validates |

|-----------|------------------|

| `registerPasskeySession` creates credential and persists | WebAuthn flow works |

| `restorePasskeySession` returns null when no stored credential | Edge case handling |

| `restorePasskeySession` restores valid credential | Session recovery |

| `clearStoredCredential` removes from localStorage | Cleanup works |

| `authenticatePasskey` throws when no stored credential | Error handling |

| `authenticatePasskey` handles NotAllowedError | User cancellation |

| `base64UrlDecode` correctly decodes standard input | Encoding utility |

**Mocking strategy:**

- Mock `viem/account-abstraction`: `createWebAuthnCredential`, `toWebAuthnAccount`
- Mock `permissionless`: `createSmartAccountClient`, `toKernelSmartAccount`
- Mock `window.navigator.credentials.get/create`
- Mock localStorage

### 3.2 Work Mutation Hook Tests

**Create `packages/shared/src/__tests__/hooks/useWorkMutation.test.ts`:**

Test coverage for [`packages/shared/src/hooks/work/useWorkMutation.ts`](packages/shared/src/hooks/work/useWorkMutation.ts):

| Test Case | What it validates |

|-----------|------------------|

| Wallet mode online: calls `submitWorkDirectly` | Direct submission path |

| Wallet mode offline: queues via `submitWorkToQueue` | Offline fallback |

| Passkey mode: queues and processes inline when online | Job queue integration |

| Passkey mode offline: queues without processing | Deferred processing |

| `onSuccess` shows toast and opens dashboard | UX feedback |

| `onError` shows parsed error message | Error handling |

| Returns offline hash for queued work | Optimistic updates |

**Mocking strategy:**

- Mock `@tanstack/react-query` mutation
- Mock `submitWorkDirectly`, `submitWorkToQueue`
- Mock `jobQueue.processJob`
- Mock `navigator.onLine`
- Mock toast service

### 3.3 Work Provider Integration Tests

**Create `packages/shared/src/__tests__/providers/WorkProvider.test.tsx`:**

Test coverage for [`packages/shared/src/providers/work.tsx`](packages/shared/src/providers/work.tsx):

| Test Case | What it validates |

|-----------|------------------|

| Provides work context to children | Context setup |

| Filters gardens to user's memberships | Garden filtering |

| `uploadWork` validates context before submission | Validation gate |

| `uploadWork` calls mutation with correct payload | Data flow |

| Form state updates propagate correctly | State management |

| Handles missing gardenAddress/actionUID gracefully | Edge cases |

**Mocking strategy:**

- Wrap with QueryClientProvider, IntlProvider
- Mock `useUser` to return test auth state
- Mock `useActions`, `useGardens` queries
- Mock `useWorkMutation` return value

### 3.4 Work Approval Hook Tests

**Create `packages/shared/src/__tests__/hooks/useWorkApproval.test.ts`:**

Test coverage for [`packages/shared/src/hooks/work/useWorkApproval.ts`](packages/shared/src/hooks/work/useWorkApproval.ts):

| Test Case | What it validates |

|-----------|------------------|

| `approve` submits with correct payload | Approval flow |

| `reject` submits with feedback | Rejection flow |

| Handles empty feedback correctly | Edge case |

| Shows toast on success/error | UX feedback |

| Queues approval for passkey mode | Auth branching |

---

## Phase 4: P1 High Priority Tests

### 4.1 Garden Join Hooks Tests

**Create `packages/shared/src/__tests__/hooks/useJoinGarden.test.ts`:**

| Test Case | What it validates |

|-----------|------------------|

| Joins garden with valid invite code | Happy path |

| Shows error for invalid invite | Validation |

| Handles already-member case | Idempotency |

**Create `packages/shared/src/__tests__/hooks/useAutoJoinRootGarden.test.ts`:**

| Test Case | What it validates |

|-----------|------------------|

| Auto-joins root garden for new passkey users | Onboarding flow |

| Skips join if already gardener | Idempotency |

| Shows appropriate loading states | UX |

| Handles join failure gracefully | Error recovery |

### 4.2 Client Work View Integration Tests

**Create `packages/client/src/__tests__/views/Garden.integration.test.tsx`:**

Integration test for work submission flow through [`packages/client/src/views/Garden/index.tsx`](packages/client/src/views/Garden/index.tsx):

| Test Case | What it validates |

|-----------|------------------|

| Renders garden selection when no garden selected | Initial state |

| Shows action selection after garden chosen | Flow progression |

| Media step accepts images and shows previews | File handling |

| Review step displays all entered data | Data display |

| Submit triggers work mutation | End-to-end flow |

| Shows loading state during submission | UX feedback |

| Navigates to dashboard on success | Post-submit flow |

**Mocking strategy:**

- Mock WorkProvider context
- Mock router navigation
- Use `@testing-library/user-event` for interactions
- Mock file input for image upload

---

## Phase 5: Strengthen Weak Tests

### 5.1 Rewrite EAS Module Tests

**Rewrite `packages/shared/src/__tests__/modules/eas.module.test.ts`:**

| Test Case | What it validates |

|-----------|------------------|

| `getGardenAssessments` returns parsed assessments | Data fetching |

| `getWorks` filters by garden and chain | Query params |

| `getWorkApprovals` links to parent works | Relational data |

| Handles GraphQL errors gracefully | Error handling |

| Returns empty array for no results | Edge case |

### 5.2 Rewrite Greengoods Module Tests

**Rewrite `packages/shared/src/__tests__/modules/greengoods.module.test.ts`:**

| Test Case | What it validates |

|-----------|------------------|

| `getGardens` returns parsed garden list | Data fetching |

| `getActions` filters by chain ID | Query params |

| Handles indexer unavailable | Error handling |

---

## Test File Summary

| Phase | File | Tests | Priority |

|-------|------|-------|----------|

| 2.1 | `shared/__tests__/test-utils/index.ts` | Utilities | Setup |

| 2.1 | `shared/__tests__/test-utils/mock-factories.ts` | Factories | Setup |

| 3.1 | `shared/__tests__/modules/passkey.test.ts` | 7 | P0 |

| 3.2 | `shared/__tests__/hooks/useWorkMutation.test.ts` | 7 | P0 |

| 3.3 | `shared/__tests__/providers/WorkProvider.test.tsx` | 6 | P0 |

| 3.4 | `shared/__tests__/hooks/useWorkApproval.test.ts` | 5 | P0 |

| 4.1 | `shared/__tests__/hooks/useJoinGarden.test.ts` | 3 | P1 |

| 4.1 | `shared/__tests__/hooks/useAutoJoinRootGarden.test.ts` | 4 | P1 |

| 4.2 | `client/__tests__/views/Garden.integration.test.tsx` | 7 | P1 |

| 5.1 | `shared/__tests__/modules/eas.module.test.ts` (rewrite) | 5 | P1 |

| 5.2 | `shared/__tests__/modules/greengoods.module.test.ts` (rewrite) | 3 | P1 |

**Total: ~47 new test cases across 11 files**

---

## Success Criteria

1. All new tests pass with `bun test`
2. No excluded tests in vitest.config.ts
3. Coverage for critical paths:

   - Auth flow: 80%+
   - Work submission: 80%+
   - Work approval: 70%+
   - Garden join: 70%+

4. No console.log-only tests remaining

### To-dos

- [ ] Delete broken/excluded test files and update vitest.config.ts
- [ ] Create shared test utilities and mock factories
- [ ] Write passkey module unit tests (7 test cases)
- [ ] Write useWorkMutation hook tests (7 test cases)
- [ ] Write WorkProvider integration tests (6 test cases)
- [ ] Write useWorkApproval hook tests (5 test cases)
- [ ] Write useJoinGarden and useAutoJoinRootGarden tests (7 test cases)
- [ ] Write client Garden view integration tests (7 test cases)
- [ ] Rewrite EAS and Greengoods module tests with assertions (8 test cases)