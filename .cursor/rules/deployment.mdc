---
description: Contract deployment patterns and conventions for Green Goods
globs:
  - packages/contracts/script/**
  - packages/contracts/deployments/**
alwaysApply: false
---

# Deployment Patterns

This rule covers Green Goods contract deployment workflows for safe, consistent deployments across networks.

## Quick Reference

**Deploy new contracts:**
```bash
bun deploy:testnet       # Base Sepolia
bun deploy:arbitrum      # Arbitrum mainnet
bun deploy:celo          # Celo mainnet
```

**Upgrade existing contracts:**
```bash
bun upgrade:testnet
bun upgrade:arbitrum
bun upgrade:celo
```

**Check status:**
```bash
bun status               # All networks
bun status baseSepolia   # Specific network
```

## MANDATORY: Use deploy.ts

**✅ ALWAYS:**
```bash
bun deploy:testnet
bun script/deploy.ts core --network baseSepolia --broadcast
```

**❌ NEVER:**
```bash
forge script script/Deploy.s.sol --broadcast --rpc-url $RPC
```

**Why deploy.ts is required:**
- Loads root `.env` correctly (from `../../../.env`)
- Uses Foundry keystore for secure key management
- Handles schema deployment and verification
- Auto-updates Envio indexer configuration
- Provides dry-run validation

## Deployment Flags

```bash
# Dry run (simulation only)
bun script/deploy.ts core --network baseSepolia

# Deploy for real
bun script/deploy.ts core --network baseSepolia --broadcast

# Update schemas only
bun script/deploy.ts core --network baseSepolia --broadcast --update-schemas

# Force fresh deployment
bun script/deploy.ts core --network baseSepolia --broadcast --force
```

## What Gets Deployed

**Core contracts:**
- DeploymentRegistry — Tracks protocol deployments
- GardenToken — ERC721 for garden NFTs
- GardenAccount — Token-bound account implementation
- ActionRegistry — Garden action registry
- GardenerRegistry — Gardener profiles

**Resolvers:**
- WorkResolver — Work submission attestations
- WorkApprovalResolver — Work approval attestations
- AssessmentResolver — Assessment attestations
- GreenGoodsResolver — Central integration fan-out

**Integration modules:**
- OctantModule — Octant vault integration
- UnlockModule — Unlock badge integration
- HatsModule — Hats protocol integration

**EAS schemas:**
- Work schema
- Work Approval schema
- Garden Assessment schema

**Initial data:**
- Root garden ("Green Goods Community Garden")
- Core actions (Planting, Identify Plant, Litter Cleanup)

## Environment Variables

Required in root `.env`:
```bash
FOUNDRY_KEYSTORE_ACCOUNT=green-goods-deployer
BASE_SEPOLIA_RPC_URL=https://...
ARBITRUM_RPC_URL=https://...
CELO_RPC_URL=https://...
ETHERSCAN_API_KEY=...  # Optional, for verification
```

## Deployment Artifacts

After deployment:
```
packages/contracts/deployments/
├── 84532-latest.json   # Base Sepolia
├── 42161-latest.json   # Arbitrum
├── 42220-latest.json   # Celo
└── networks.json       # Network configuration
```

**Using artifacts:**
```typescript
import deployment from '../../../contracts/deployments/84532-latest.json';

const gardenToken = deployment.gardenToken;
const workSchemaUID = deployment.schemas.workSchemaUID;
```

## Pre-Deployment Checklist

**All deployments:**
- [ ] Tests passing: `bun --filter contracts test`
- [ ] Build succeeds: `bun --filter contracts build`
- [ ] Dry run successful: `bun deploy:dry:testnet`
- [ ] Deployer funded: `cast balance $(cast wallet address green-goods-deployer)`
- [ ] RPC accessible: `cast chain-id --rpc-url $RPC_URL`

**Mainnet additional:**
- [ ] Security audit completed
- [ ] Multisig ownership configured
- [ ] 100% test pass rate
- [ ] Gas analysis: `bun --filter contracts test:gas`

## Production Readiness

Quick assessment before mainnet:

| Check | Testnet | Mainnet |
|-------|---------|---------|
| Test pass rate | ≥80% | 100% |
| Security audit | Internal | External required |
| Gas benchmarks | Reviewed | Optimized |
| Multisig | Optional | Required |

**Blocking issues:**
- Test pass rate below threshold
- Missing schema UIDs in deployment JSON
- Compiler errors/warnings
- Insufficient deployer balance

## Post-Deployment

```bash
# Verify on block explorer (auto-runs with --broadcast)
cast call $GARDEN_TOKEN "owner()" --rpc-url $RPC

# Update dependent packages (auto-runs for Envio)
cd packages/indexer && bun codegen
cd packages/client && bun build
```

## Reference Files

- Deploy CLI: `packages/contracts/script/deploy.ts`
- Deploy logic: `packages/contracts/script/deploy/core.ts`
- Forge script: `packages/contracts/script/Deploy.s.sol`
- Upgrade script: `packages/contracts/script/upgrade.ts`
- Network config: `packages/contracts/deployments/networks.json`
