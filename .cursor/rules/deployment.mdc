---
description: Contract deployment patterns and conventions for Green Goods
globs:
  - packages/contracts/script/**
  - packages/contracts/deployments/**
alwaysApply: false
---

# Deployment Patterns & Conventions

This rule covers Green Goods contract deployment workflows, ensuring safe and consistent deployments across networks.

## Deploy vs Upgrade Decision Matrix

### When to Deploy (New Addresses)

Use `bun deploy:*` when:
- Setting up a new network
- First-time deployment
- Testing locally or on fork
- Want completely fresh state

**Commands:**
```bash
bun deploy:local      # Anvil localhost
bun deploy:testnet    # Base Sepolia
bun deploy:celo       # Celo mainnet
bun deploy:arbitrum   # Arbitrum mainnet
```

### When to Upgrade (Same Addresses)

Use `bun upgrade:*` when:
- Fixing bugs in production contracts
- Adding features to existing contracts
- Maintaining addresses for existing integrations
- Upgrading UUPS proxies

**Commands:**
```bash
bun upgrade:testnet
bun upgrade:celo
bun upgrade:arbitrum
```

## MANDATORY: Use deploy.js Wrapper

**✅ ALWAYS:**
```bash
bun deploy:testnet
node script/deploy.js core --network baseSepolia --broadcast
```

**❌ NEVER:**
```bash
forge script script/Deploy.s.sol --broadcast --rpc-url $RPC
```

### Why deploy.js is Required

1. **Environment Loading**: Properly loads root `.env` file
2. **Deterministic Addresses**: Ensures same deployer key across chains
3. **Schema Deployment**: Handles EAS schema registration
4. **Error Recovery**: Implements retry logic and validation
5. **Verification**: Automatic Etherscan verification
6. **Integration**: Updates indexer config automatically

### deploy.js Usage

```bash
# Dry run (simulation, no broadcast)
node script/deploy.js core --network baseSepolia

# Deploy with broadcast
node script/deploy.js core --network baseSepolia --broadcast

# Update schemas only (skip contracts if deployed)
node script/deploy.js core --network baseSepolia --broadcast --update-schemas

# Force fresh deployment (ignore existing)
node script/deploy.js core --network baseSepolia --broadcast --force

# Skip schema deployment
node script/deploy.js core --network baseSepolia --broadcast --skip-schemas
```

## Root .env Loading Pattern

The deploy.js script **always** loads the root `.env`:

```javascript
// packages/contracts/script/deploy.js
dotenv.config({ path: path.resolve(__dirname, '../../../.env') });
```

**Never** use package-specific .env files for deployment.

### Required Environment Variables

```bash
# Root .env (correct location)
FOUNDRY_KEYSTORE_ACCOUNT=green-goods-deployer
BASE_SEPOLIA_RPC_URL=https://...
CELO_RPC_URL=https://...
ARBITRUM_RPC_URL=https://...
ETHERSCAN_API_KEY=...  # Optional but recommended
```

### Loading in Forge Scripts

If you need environment variables in Solidity scripts:

```solidity
// Deploy.s.sol
string memory privateKey = vm.envString("PRIVATE_KEY");  // ❌ Won't work

// Correct: Use Foundry keystore
vm.startBroadcast();  // Uses FOUNDRY_KEYSTORE_ACCOUNT from .env
```

## Deployment Profiles

deploy.js supports multiple profiles:

### Available Profiles

```javascript
const profiles = {
  production: { /* mainnet settings */ },
  testing: { /* testnet settings */ },
  update: { /* schema updates */ },
  hotfix: { /* emergency fixes */ },
  optimized: { /* gas optimizations */ }
};
```

### Using Profiles

```bash
# Use specific profile
node script/deploy.js core --network celo --profile production --broadcast

# Default profile (production for mainnet, testing for testnet)
bun deploy:celo
```

## Deployment Artifacts

### Generated Files

After deployment, these files are updated:

```
packages/contracts/deployments/
├── 84532-latest.json       # Base Sepolia
├── 42161-latest.json       # Arbitrum
├── 42220-latest.json       # Celo
└── networks.json           # Network configs
```

### Artifact Structure

```json
{
  "network": "baseSepolia",
  "chainId": 84532,
  "deploymentRegistry": "0x...",
  "gardenToken": "0x...",
  "actionRegistry": "0x...",
  "workResolver": "0x...",
  "workApprovalResolver": "0x...",
  "assessmentResolver": "0x...",
  "schemas": {
    "workSchemaUID": "0x...",
    "workApprovalSchemaUID": "0x...",
    "gardenAssessmentSchemaUID": "0x..."
  },
  "rootGarden": {
    "address": "0x...",
    "tokenId": 1
  }
}
```

### Using Artifacts in Frontend

```typescript
// Client
import deployment from '../../../contracts/deployments/84532-latest.json';

const gardenToken = deployment.gardenToken;
const workSchemaUID = deployment.schemas.workSchemaUID;
```

## Pre-Deployment Checklist

Before running `--broadcast`:

- [ ] Tests passing: `bun --filter contracts test`
- [ ] Code formatted: `bun --filter contracts format`
- [ ] Gas analyzed: `forge test --gas-report`
- [ ] Dry run successful: `node script/deploy.js core --network <net>`
- [ ] Deployer funded: `cast balance $ADDRESS --rpc-url $RPC`
- [ ] RPC accessible: `cast chain-id --rpc-url $RPC`
- [ ] Keystore configured: `cast wallet list` shows deployer account

### Testnet Requirements

- ≥80% test pass rate acceptable
- Internal security review sufficient
- Can iterate and fix issues quickly

### Mainnet Requirements

- 100% test pass rate required
- External security audit mandatory
- Multisig ownership configured
- Rollback plan documented
- Monitoring configured

## Post-Deployment Verification

After deployment completes:

```bash
# Verify contract ownership
cast call $GARDEN_TOKEN "owner()" --rpc-url $RPC

# Verify schema registration
cast call $EAS "getSchema(bytes32)" $SCHEMA_UID --rpc-url $RPC

# Verify on block explorer
# Check deployment artifact for verification URLs

# Update dependent packages
cd packages/indexer && bun codegen
cd packages/client && bun build
```

## Deployment Troubleshooting

### Common Issues

**Issue: "Keystore not found"**
```bash
# Solution
cast wallet import green-goods-deployer --interactive
```

**Issue: "RPC connection failed"**
```bash
# Verify RPC
curl -X POST $BASE_SEPOLIA_RPC_URL \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","method":"eth_chainId","id":1}'

# Check environment variable
echo $BASE_SEPOLIA_RPC_URL
```

**Issue: "Insufficient funds"**
```bash
# Check balance
cast balance $(cast wallet address green-goods-deployer) --rpc-url $RPC

# Fund deployer
# Get testnet ETH from faucet or send from another wallet
```

**Issue: "Schema deployment failed"**
```bash
# Deploy with schema skip, then retry schemas
node script/deploy.js core --network baseSepolia --broadcast --skip-schemas
node script/deploy.js core --network baseSepolia --broadcast --update-schemas
```

## Network Configuration

### networks.json Structure

```json
{
  "networks": {
    "baseSepolia": {
      "chainId": 84532,
      "rpcUrl": "${BASE_SEPOLIA_RPC_URL}",
      "blockExplorer": "https://sepolia.basescan.org",
      "contracts": {
        "eas": "0x...",
        "easSchemaRegistry": "0x..."
      }
    }
  }
}
```

### Adding New Network

1. Add configuration to `deployments/networks.json`
2. Add RPC URL to root `.env`
3. Add npm script to `package.json`:
   ```json
   {
     "scripts": {
       "deploy:newnetwork": "node script/deploy.js core --network newNetwork --broadcast"
     }
   }
   ```
4. Test with dry run first
5. Document in `docs/DEPLOYMENT.md`

## Deterministic Deployment

Green Goods uses deterministic addresses via consistent deployer:

**Why it matters:**
- Same contracts get same addresses across chains
- Easier multi-chain integration
- Predictable address calculation

**How it works:**
- Uses same deployer key (from keystore) on all networks
- Uses CREATE2 for some contracts
- Documented in deployment artifacts

### Verify Deterministic Deployment

```bash
# Address should match across networks
cast call $GARDEN_TOKEN_CELO "owner()" --rpc-url $CELO_RPC
cast call $GARDEN_TOKEN_ARB "owner()" --rpc-url $ARB_RPC
# Should be same owner address
```

## Emergency Procedures

### Deployment Rollback

If deployment fails mid-process:

1. Check `packages/contracts/broadcast/` for partial transactions
2. Review deployment log for error
3. Fix issue in contracts
4. Re-run with `--force` to redeploy from scratch

**⚠️ Warning:** Rollback on mainnet requires multisig approval

### Schema Recovery

If schemas deploy but contracts fail:

```bash
# Continue deployment, skip schema step
node script/deploy.js core --network <net> --broadcast --skip-schemas
```

Schemas are immutable once deployed — no need to redeploy.

## MCP Tool Integration

Use GitHub MCP for deployment workflow:

```bash
# Create deployment PR
@github: Create PR for "Base Sepolia Deployment" with deployment checklist

# Track deployment issues
@github: Create issue "Investigate schema deployment timeout on Celo"

# Document deployment
@github: Add comment to issue #123 with deployment artifact JSON
```

## Reference Files

- Deploy script: `packages/contracts/script/deploy.js`
- Upgrade script: `packages/contracts/script/upgrade.js`
- Deployment guide: `docs/DEPLOYMENT.md`
- Upgrade guide: `docs/UPGRADES.md`
- Network config: `packages/contracts/deployments/networks.json`
- Deployment artifacts: `packages/contracts/deployments/*-latest.json`
