---
description: Code quality standards, testing expectations, and tooling conventions for Green Goods
globs:
alwaysApply: true
---

# Code Quality & Testing Standards

## Tooling Stack

### Biome (Formatting)

Fast formatter (35x faster than Prettier). Linting disabled at root — use oxlint.

```bash
bun format              # Format all files
bun format:check        # Check without writing
```

**Config:** `/biome.json` — 100 char line width, double quotes, ES5 trailing commas.

### oxlint (Linting)

Rust-based linter (~30ms on entire codebase).

```bash
bun lint                # Lint all packages
```

**Catches:** Unused variables, import issues, TypeScript errors, common mistakes.

### Combined Workflow

```bash
# Pre-commit (automatic via lint-staged)
bun format && bun lint

# Full validation
bun format && bun lint && bun test
```

## Conventional Commits

```
<type>(<scope>): <description>
```

**Types:** `feat`, `fix`, `docs`, `style`, `refactor`, `test`, `chore`

**Scopes:** `client`, `admin`, `shared`, `contracts`, `indexer`, `agent`, or feature areas (`offline`, `auth`, `deployment`)

**Examples:**
```bash
feat(client): add offline work submission queue
fix(contracts): fix storage gap in GardenToken upgrade
test(shared): add job queue integration tests
```

## Testing Standards

### Coverage Targets

| Package | Critical Paths | Overall | Notes |
|---------|---------------|---------|-------|
| Client | 80%+ | 70%+ | 100% for auth/encryption |
| Admin | 70%+ | 70%+ | 100% for access control |
| Shared | 80%+ | 70%+ | Core logic, all hooks |
| Contracts | 100% (mainnet) | 80% (testnet) | Gas tests required |

### Test Organization

**TypeScript packages (Vitest):**
```
src/__tests__/
├── components/      # Component tests
├── hooks/           # Hook tests
├── modules/         # Service layer tests
└── integration/     # Multi-component flows
```

**Contracts (Foundry):**
```
test/
├── {Contract}.t.sol     # Unit tests
├── E2EWorkflow.t.sol    # Integration tests
└── helpers/             # Test utilities
```

### Test Naming

```typescript
// TypeScript: describe('[Module]') + it('[behavior]')
describe('JobQueue', () => {
  it('retries failed jobs with exponential backoff', async () => {});
});
```

```solidity
// Solidity: test[ContractName]_[scenario]
function testGardenToken_revertsOnUnauthorizedMint() public {}
```

## Code Style

### TypeScript Strictness

All packages use strict mode. **Never use `any`** — use `unknown` for untrusted data.

### Import Organization (Auto-sorted by Biome)

```typescript
// 1. External deps  2. Internal (@/ alias)  3. Relative  4. Types
import { useQuery } from '@tanstack/react-query';
import { Button } from '@/components/Button';
import { helper } from './helper';
import type { Work } from '@/types';
```

### File Naming

- Components: `ComponentName.tsx`
- Hooks: `useFeatureName.ts`
- Tests: `*.test.ts(x)`
- Directories: lowercase (`hooks/auth/`, `modules/job-queue/`)

### Solidity

```bash
cd packages/contracts && forge fmt     # Format
cd packages/contracts && bun run lint  # Lint (solhint)
```

Use custom errors over require strings. Always include storage gaps in upgradeable contracts.

## Documentation Standards

**Required JSDoc for:** Exported functions, complex algorithms, public APIs.

```typescript
/**
 * Merges online and offline work submissions, deduplicating by content hash.
 * Online works take precedence within a 5-minute time window.
 */
export async function mergeWorks(online: Work[], offline: Job[]): Promise<Work[]>
```

## Pre-merge Requirements

- [ ] All tests passing (`bun test`)
- [ ] No lint errors (`bun lint`)
- [ ] Build succeeds (`bun build`)
- [ ] Conventional commit format
- [ ] README updated if needed

## Agent Validation Protocol

**MANDATORY:** Run validation after ANY code modification before reporting completion.

### Package-Specific Commands

**Client:**
```bash
cd packages/client && bun run build && bun run lint && bun run test
```

**Admin:**
```bash
cd packages/admin && bun run build && bun run lint && bun run test
```

**Shared:**
```bash
cd packages/shared && npx tsc --noEmit && bun run lint && bun run test
```

**Contracts:**
```bash
cd packages/contracts && bun run build && bun run lint && bun run test
```

**Indexer:**
```bash
cd packages/indexer && bun run build && bun run lint && bun run test
```

**Agent:**
```bash
cd packages/agent && bun run build && bun run test
```

### Validation by Task Type

| Task | Required |
|------|----------|
| New feature | `build` + `lint` + `test` |
| Bug fix | `build` + `lint` + affected tests |
| Refactor | `build` + `lint` + `test` |
| Type changes | `build` + `lint` |
| Config change | `build` |
| Docs only | `bun format` |

### Cross-Package Changes

Validate ALL affected packages. Example for shared → client:

```bash
cd packages/shared && npx tsc --noEmit && bun run lint && bun run test
cd packages/client && bun run build && bun run lint && bun run test
```

### Quick Validation (Minimum)

```bash
cd packages/{package} && bun run build && bun run lint
```

### On Failure

1. **Do NOT** report task complete
2. Read error output
3. Fix all errors
4. Re-run validation
5. Repeat until all pass

## Reference Documents

- Biome config: `/biome.json`
- Package rules: `packages/*/.cursor/rules/*.mdc`
- Architecture: `/docs/ARCHITECTURE.md`
