---
description: Deployment patterns — deploy.ts CLI, verification, Envio integration
globs:
  - packages/contracts/script/deploy.ts
  - packages/contracts/script/deploy/**
  - packages/contracts/script/upgrade.ts
  - packages/contracts/script/**/*.s.sol
alwaysApply: false
---

# Deployment Patterns

Green Goods contracts use a TypeScript-based deployment CLI. This rule documents the deployment system.

## Visual Reference

See [Deployment Flow](docs/developer/architecture/diagrams.md#deployment-flow) for the complete deploy.ts execution sequence.

## MANDATORY: Use deploy.ts

**✅ ALWAYS:**
```bash
bun deploy:testnet
bun script/deploy.ts core --network baseSepolia --broadcast
```

**❌ NEVER:**
```bash
forge script script/Deploy.s.sol --broadcast
```

**Why:**
- Loads root `.env` correctly
- Uses Foundry keystore (not raw private keys)
- Auto-updates Envio indexer config
- Handles verification automatically

## CLI Commands

```bash
# Core contracts
bun script/deploy.ts core --network <network> [--broadcast]

# Garden from config
bun script/deploy.ts garden config/my-garden.json --network <network> [--broadcast]

# Actions from config
bun script/deploy.ts actions config/my-actions.json --network <network> [--broadcast]

# Check deployment status
bun script/deploy.ts status [network]

# Start Anvil fork
bun script/deploy.ts fork <network>
```

## Deployment Flags

| Flag | Description |
|------|-------------|
| `--network, -n` | Target network (default: localhost) |
| `--broadcast, -b` | Actually broadcast transactions |
| `--update-schemas` | Only update EAS schemas |
| `--force` | Force fresh deployment |
| `--dry-run` | Validate without deploying |

## What Gets Deployed

**Core deployment includes:**

1. **Infrastructure:**
   - DeploymentRegistry
   - GardenToken (ERC721)
   - GardenAccount (TBA implementation)

2. **Registries:**
   - ActionRegistry
   - GardenerRegistry

3. **Resolvers:**
   - WorkResolver
   - WorkApprovalResolver
   - AssessmentResolver
   - GreenGoodsResolver (central fan-out)

4. **Integration Modules:**
   - OctantModule (yield vaults)
   - UnlockModule (work badges)
   - HatsModule (roles)

5. **EAS Schemas:**
   - Work schema
   - Work Approval schema
   - Garden Assessment schema

6. **Initial Data:**
   - Root garden (tokenId: 1)
   - Core actions (Planting, Identify, Cleanup)

## Modular Architecture

The deployment system is organized as:

```
script/
├── deploy.ts              # Entry point (backward compat)
├── deploy/
│   ├── cli.ts            # CLI parser and router
│   ├── core.ts           # Core contract deployment
│   ├── gardens.ts        # Garden deployment
│   ├── actions.ts        # Action deployment
│   └── anvil.ts          # Anvil management
├── utils/
│   ├── cli-parser.ts     # Argument parsing
│   ├── network.ts        # Network configuration
│   ├── envio-integration.ts  # Auto-update indexer
│   └── validation.ts     # Config validation
├── Deploy.s.sol          # Forge deployment script
└── Upgrade.s.sol         # Forge upgrade script
```

## Post-Deployment

### Verification (automatic)
Contracts are auto-verified on broadcast for all networks except localhost.

### Envio Integration (automatic)
After successful deployment, the CLI auto-updates:
- `packages/indexer/config.yaml` with new addresses
- Runs codegen if needed

### Manual verification
```bash
cast call $GARDEN_TOKEN "owner()" --rpc-url $RPC
cast call $EAS "getSchema(bytes32)" $SCHEMA_UID --rpc-url $RPC
```

## Reference Files

- CLI entry: `script/deploy.ts`
- Core deployer: `script/deploy/core.ts`
- Forge script: `script/Deploy.s.sol`
- Root deployment rule: `.cursor/rules/deployment-patterns.mdc`
