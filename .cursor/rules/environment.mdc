---
description: Environment variable conventions and configuration management for Green Goods
globs:
  - "**/.env*"
  - "**/config.ts"
  - "**/config/**"
alwaysApply: false
---

# Environment Variables & Configuration

Green Goods uses a **single root `.env` file** for all packages. This rule documents mandatory patterns.

## Agent Instructions

**The `.env` file is NOT accessible** (in `.gitignore`).

- **✅ DO:** Update `.env.example` with new variables (include setup instructions and links)
- **✅ DO:** Document variable purpose in `.env.example` comments
- **❌ DON'T:** Try to read `.env` directly — check config files or `.env.example` instead
- **❌ DON'T:** Include actual secrets in `.env.example`

## Critical Rule: Root .env Only

**All packages use the root `.env` at project root.** Never create package-specific `.env` files.

```bash
# ✅ Correct
/green-goods/.env

# ❌ Wrong
/green-goods/packages/client/.env
/green-goods/packages/admin/.env
```

**How packages load .env:**
- **Client/Admin (Vite):** Auto-loads root `.env`, access via `import.meta.env.VITE_*`
- **Contracts (deploy.js):** Explicitly loads `dotenv.config({ path: '../../../.env' })`
- **Agent (Node.js):** Loads via dotenv from project root

## Variable Categories

### Required Variables

| Variable | Purpose | Get From |
|----------|---------|----------|
| `VITE_CHAIN_ID` | Target chain (84532=Base Sepolia, 42161=Arbitrum, 42220=Celo) | Choose based on deployment |
| `VITE_PIMLICO_API_KEY` | Passkey smart accounts | [pimlico.io](https://pimlico.io) |
| `VITE_WALLETCONNECT_PROJECT_ID` | Wallet connection | [cloud.reown.com](https://cloud.reown.com) |
| `VITE_STORACHA_KEY` | IPFS uploads (private key) | [storacha.network](https://docs.storacha.network) |
| `VITE_STORACHA_PROOF` | IPFS uploads (delegation) | `storacha delegation create` |

### Deployment Variables

| Variable | Purpose |
|----------|---------|
| `FOUNDRY_KEYSTORE_ACCOUNT` | Foundry keystore account name for deployment |
| `ETHERSCAN_API_KEY` | Block explorer verification |
| `{NETWORK}_RPC_URL` | RPC URLs (e.g., `BASE_SEPOLIA_RPC_URL`, `ARBITRUM_RPC_URL`) |

### Development Flags

| Variable | Purpose |
|----------|---------|
| `VITE_DESKTOP_DEV=true` | Bypass PWA install prompts |
| `VITE_DEBUG_MODE=true` | Skip media requirements, verbose logs |
| `VITE_ENABLE_SW_DEV=true` | Enable service worker in dev |
| `VITE_ENVIO_INDEXER_URL` | Override indexer endpoint (default: localhost:8080) |

### Analytics (Optional)

| Variable | Purpose |
|----------|---------|
| `VITE_POSTHOG_KEY` | Client PWA analytics |
| `VITE_POSTHOG_ADMIN_KEY` | Admin dashboard analytics |
| `VITE_POSTHOG_HOST` | PostHog host URL |

### Agent Package

| Variable | Purpose |
|----------|---------|
| `TELEGRAM_BOT_TOKEN` | Telegram bot token from @BotFather |
| `ENCRYPTION_SECRET` | 64-char base64 secret for key encryption |
| `BOT_MODE` | `polling` (dev) or `webhook` (production) |
| `WEBHOOK_URL` | Public HTTPS URL for webhooks |

## Variable Naming

- **`VITE_*`** — Exposed to browser (client-side)
- **No prefix** — Server-side only (deployment scripts, agent)

```bash
VITE_CHAIN_ID=84532                    # Client-side (visible in browser)
FOUNDRY_KEYSTORE_ACCOUNT=deployer      # Server-side only
```

## Chain Configuration

**Apps are single-chain.** Chain is determined by `VITE_CHAIN_ID` at build time — no runtime switching.

```typescript
// ✅ Correct: Read from env via shared config
import { DEFAULT_CHAIN_ID } from '@green-goods/shared';

// ❌ Wrong: Never read chain from wallet
const { chainId } = useAccount();
```

**Multi-chain deployment:** Build separate app instances per chain:

```bash
VITE_CHAIN_ID=42161 bun --filter client build  # Arbitrum
VITE_CHAIN_ID=42220 bun --filter client build  # Celo
```

## Configuration Files

**Shared config (source of truth):**
```
packages/shared/src/config/blockchain.ts  # getDefaultChain(), DEFAULT_CHAIN_ID
packages/shared/src/config/chains.ts      # Chain definitions
packages/contracts/deployments/*.json     # Contract addresses per chain
packages/contracts/deployments/networks.json # Network metadata
```

**Package configs re-export from shared:**
```typescript
// packages/admin/src/config.ts
export { DEFAULT_CHAIN_ID, getNetworkConfig } from '@green-goods/shared';
```

## Configuration Precedence

1. Hardcoded defaults in code
2. `deployments/networks.json` values
3. Root `.env` file
4. Shell environment variables (last wins)

## Anti-Patterns

```typescript
// ❌ Hardcoded addresses
const GARDEN_TOKEN = '0x1234...';

// ✅ Import from deployment artifacts
import deployment from '../../../contracts/deployments/84532-latest.json';
const GARDEN_TOKEN = deployment.gardenToken;

// ❌ Runtime chain switching
const { switchChain } = useSwitchChain();
await switchChain({ chainId: 42161 });

// ✅ Single chain from environment
import { DEFAULT_CHAIN_ID } from '@green-goods/shared';
```

## Reference Files

- **Template:** `/.env.example` (agents should update this)
- **Shared config:** `packages/shared/src/config/blockchain.ts`
- **Network metadata:** `packages/contracts/deployments/networks.json`
- **Deployment artifacts:** `packages/contracts/deployments/{chainId}-latest.json`
