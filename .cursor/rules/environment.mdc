---
description: Environment variable conventions and configuration management for Green Goods
globs:
  - "**/.env*"
  - "**/config.ts"
  - "**/config/**"
alwaysApply: false
---

# Environment Variables & Configuration

Green Goods uses a **single root `.env` file** for all environment variables across all packages. This rule documents mandatory patterns and conventions.

## ⚠️ IMPORTANT FOR AGENTS

**The `.env` file is NOT accessible** (in `.gitignore` for security).

When documenting or adding environment variables:
- **✅ DO:** Update `.env.example` with new variables and descriptions
- **✅ DO:** Document variable purpose and how to obtain values
- **❌ DON'T:** Try to read or modify `.env` directly
- **❌ DON'T:** Include actual API keys or secrets in `.env.example`

**Example Agent Workflow:**
```bash
# When adding a new environment variable:
# 1. Add to .env.example with placeholder
# 2. Document where to get the real value
# 3. Update this rule file if it's a new category
```

## CRITICAL RULE: Root .env Only

**✅ ALWAYS:** Use root `.env` file at `/Users/afo/Code/greenpill/green-goods/.env`

**❌ NEVER:** Create package-specific `.env` files

### Why Root .env Only?

1. **Consistency**: All packages use same configuration
2. **Deployment**: Deployment scripts load root .env
3. **Simplicity**: Single source of truth
4. **Security**: One file to manage secrets

### How Packages Load .env

**Client/Admin (Vite):**
```typescript
// Vite automatically loads root .env
// Access via import.meta.env.VITE_*
const chainId = import.meta.env.VITE_CHAIN_ID;
```

**Contracts (deploy.js):**
```javascript
// deploy.js explicitly loads root .env
dotenv.config({ path: path.resolve(__dirname, '../../../.env') });
```

**Indexer (Envio):**
```bash
# Envio Docker Compose inherits from root .env
# Configured in generated/docker-compose.yaml
```

## Environment Variable Categories

### 1. Blockchain Configuration

```bash
# Chain selection (REQUIRED for client/admin)
VITE_CHAIN_ID=84532  # 84532=Base Sepolia, 42161=Arbitrum, 42220=Celo

# RPC URLs (REQUIRED for all packages)
BASE_SEPOLIA_RPC_URL=https://sepolia.base.org
ARBITRUM_RPC_URL=https://arb1.arbitrum.io/rpc
CELO_RPC_URL=https://forno.celo.org

# Alternative RPC with Alchemy
ALCHEMY_API_KEY=your-key-here
# Automatically constructs: https://base-sepolia.g.alchemy.com/v2/${ALCHEMY_API_KEY}
```

### 2. Authentication & Services

```bash
# Pimlico (account abstraction, sponsorship)
VITE_PIMLICO_API_KEY=your-pimlico-key

# WalletConnect (multi-wallet support)
VITE_WALLETCONNECT_PROJECT_ID=your-wc-project-id

# Storacha (IPFS uploads - primary)
VITE_STORACHA_KEY=your-storacha-private-key
VITE_STORACHA_PROOF=your-storacha-delegation-proof

# PostHog (analytics)
VITE_POSTHOG_KEY=phc_...
VITE_POSTHOG_HOST=https://us.i.posthog.com
```

### 3. Deployment Configuration

```bash
# Foundry keystore account name (REQUIRED for deployment)
FOUNDRY_KEYSTORE_ACCOUNT=green-goods-deployer

# Block explorer verification (OPTIONAL but recommended)
ETHERSCAN_API_KEY=your-etherscan-key

# Deployment options
SCHEMA_DEPLOYMENT_MAX_RETRIES=3
SCHEMA_DEPLOYMENT_SKIP_ON_FAILURE=false
```

### 4. Development Flags

```bash
# Desktop development (bypass PWA install checks)
VITE_DESKTOP_DEV=true

# Service worker in dev mode
VITE_ENABLE_SW_DEV=true

# Mock PWA installed state
VITE_MOCK_PWA_INSTALLED=true

# PostHog debug mode
VITE_POSTHOG_DEBUG=true

# Job queue debug logging
VITE_QUEUE_DEBUG=true
```

### 5. Indexer Configuration

```bash
# Envio indexer GraphQL endpoint
VITE_ENVIO_INDEXER_URL=http://localhost:8080/v1/graphql

# Production override
VITE_ENVIO_INDEXER_URL=https://indexer.greengoods.app/v1/graphql
```

## Variable Naming Conventions

### Prefixes

**`VITE_`** — Client-side variables (exposed to browser):
```bash
VITE_CHAIN_ID=84532
VITE_PIMLICO_API_KEY=...
```

**No prefix** — Server-side/deployment only:
```bash
FOUNDRY_KEYSTORE_ACCOUNT=green-goods-deployer
PRIVATE_KEY=0x...  # If using raw key (not recommended)
```

### Naming Pattern

```bash
# Pattern: [PREFIX_][SERVICE_][RESOURCE]_[DESCRIPTOR]
VITE_PIMLICO_API_KEY           # Client, Pimlico service, API key
BASE_SEPOLIA_RPC_URL           # Server, Base Sepolia network, RPC URL
VITE_POSTHOG_HOST       # Client, PostHog, public host
```

## Configuration Files

### Client Config (`packages/client/src/config/blockchain.ts`)

```typescript
// Load from environment
export function getDefaultChain(): Chain {
  const chainId = import.meta.env.VITE_CHAIN_ID;
  
  switch (chainId) {
    case "42161": return arbitrum;
    case "84532": return baseSepolia;
    case "42220": return celo;
    default: return baseSepolia;
  }
}

// Export constant derived from env
export const DEFAULT_CHAIN_ID = getDefaultChain().id;
```

### Admin Config (`packages/admin/src/config.ts`)

```typescript
// Admin allowlist
export const ADMIN_ADDRESSES = [
  '0x2aa64E6d80390F5C017F0313cB908051BE2FD35e',
  '0x04D60647836bcA09c37B379550038BdaaFD82503'
];

// Load chain from env
export function getDefaultChain() {
  const chainId = import.meta.env.VITE_DEFAULT_CHAIN_ID;
  // ... same pattern as client
}
```

### Contracts Config (`packages/contracts/deployments/networks.json`)

```json
{
  "networks": {
    "baseSepolia": {
      "chainId": 84532,
      "rpcUrl": "${BASE_SEPOLIA_RPC_URL}",
      "contracts": {
        "eas": "0x4200000000000000000000000000000000000021",
        "easSchemaRegistry": "0x4200000000000000000000000000000000000020"
      }
    }
  }
}
```

**Note:** Environment variables use `${VAR}` template syntax in JSON.

## Secrets Management

### What Goes in .env

**✅ Include:**
- API keys (Pimlico, Storacha, Alchemy, PostHog)
- RPC URLs with auth tokens
- Keystore account names
- Service configuration

**❌ Never Include:**
- Private keys in plaintext (use Foundry keystore)
- Secrets in git (add `.env` to `.gitignore`)
- Production secrets in `.env.example`

### .env.example Pattern (Agent-Editable)

**THIS IS THE FILE AGENTS SHOULD UPDATE** when adding new environment variables.

```bash
# Root .env.example (template for users)
# Location: /Users/afo/Code/greenpill/green-goods/.env.example

# Blockchain Configuration (REQUIRED)
VITE_CHAIN_ID=84532
FOUNDRY_KEYSTORE_ACCOUNT=your-deployer-account-name

# RPC URLs (REQUIRED)
BASE_SEPOLIA_RPC_URL=https://sepolia.base.org
# Get Alchemy key from: https://dashboard.alchemy.com
ALCHEMY_API_KEY=your-alchemy-api-key

# Account Abstraction (REQUIRED for gasless transactions)
# Get from: https://dashboard.pimlico.io
VITE_PIMLICO_API_KEY=get-from-pimlico-dashboard

# IPFS Storage via Storacha (REQUIRED for media uploads)
# Get from: https://console.storacha.network
# Generate: npm i -g @web3-storage/w3cli && w3 login && w3 space create green-goods
VITE_STORACHA_KEY=get-from-storacha-console
VITE_STORACHA_PROOF=get-from-storacha-console

# Analytics (OPTIONAL)
# Get from: https://posthog.com
VITE_POSTHOG_KEY=get-from-posthog-dashboard
VITE_POSTHOG_HOST=https://us.i.posthog.com

# Never include actual values - always use placeholders with instructions
# VITE_PIMLICO_API_KEY=pk_real_key_here ❌ WRONG
# VITE_PIMLICO_API_KEY=get-from-pimlico-dashboard ✅ CORRECT
```

**Agent Guidelines for .env.example:**
1. Always add descriptive comments above each variable
2. Include links to where users can obtain the value
3. Mark variables as REQUIRED or OPTIONAL
4. Group related variables together
5. Never include actual API keys or secrets

## Configuration Precedence

Values loaded in this order (last wins):

1. Hardcoded defaults in code
2. `deployments/networks.json` values
3. Root `.env` file
4. Environment variables from shell

### Example Precedence

```typescript
// 1. Hardcoded default
const indexerUrl = 'http://localhost:8080/v1/graphql';

// 2. Override from .env if present
const fromEnv = import.meta.env.VITE_ENVIO_INDEXER_URL;
const finalUrl = fromEnv || indexerUrl;
```

## Chain-Specific Configuration

### Single-Chain Apps

Client and Admin are **single-chain** applications:

```typescript
// Correct: Read from env, no runtime switching
import { DEFAULT_CHAIN_ID } from '@/config/blockchain';

function useCurrentChain() {
  return useMemo(() => DEFAULT_CHAIN_ID, []);
}

// Wrong: Don't read from wallet
function useCurrentChain() {
  const { chainId } = useAccount();  // ❌ Never do this
  return chainId;
}
```

### Why No Chain Switching?

- Data consistency: Indexer, contracts, and UI must align on chain
- Schema differences: Each chain may have different schemas
- UX simplicity: Users deploy app per chain, not switch chains
- State management: Avoids complex multi-chain state

### Deploying Multi-Chain

To support multiple chains:

1. Deploy separate app instances per chain
2. Use different `.env` files per deployment
3. Each instance points to chain-specific indexer

```bash
# Example: Deploy client for Celo
VITE_CHAIN_ID=42220 bun --filter client build
# Deploy to celo.greengoods.app

# Deploy client for Arbitrum
VITE_CHAIN_ID=42161 bun --filter client build  
# Deploy to arbitrum.greengoods.app
```

## Development vs Production

### Development Overrides

```bash
# Development .env additions
VITE_DESKTOP_DEV=true              # Skip PWA install prompts
VITE_ENABLE_SW_DEV=true            # Enable service worker in dev
VITE_QUEUE_DEBUG=true              # Debug job queue
VITE_POSTHOG_DEBUG=true            # Debug analytics

# Local endpoints
VITE_ENVIO_INDEXER_URL=http://localhost:8080/v1/graphql
```

### Production .env

```bash
# Production .env (minimal, secure)
VITE_CHAIN_ID=42161
VITE_PIMLICO_API_KEY=pk_...
VITE_STORACHA_KEY=...
VITE_STORACHA_PROOF=...
VITE_WALLETCONNECT_PROJECT_ID=...
VITE_POSTHOG_KEY=phc_...
VITE_ENVIO_INDEXER_URL=https://indexer.greengoods.app/v1/graphql

# No debug flags
# No dev flags
# No local URLs
```

## Security Best Practices

### API Key Rotation

When rotating keys:

1. Update root `.env`
2. Redeploy all affected packages
3. Verify all services work with new keys
4. Revoke old keys after validation

### Secret Scanning

**Protected:**
- Root `.env` in `.gitignore`
- Never commit secrets
- Use keystore for private keys

**CI/CD:**
- Set secrets as environment variables
- Never log sensitive values
- Use secret management services

## Validation Commands

**Note:** Agents cannot run these commands since `.env` is not accessible. These are for human developers.

```bash
# Verify .env loaded correctly (human developers only)
node -e "require('dotenv').config(); console.log(process.env.FOUNDRY_KEYSTORE_ACCOUNT)"

# Check variable accessibility from client
cd packages/client && node -e "console.log(process.env.VITE_CHAIN_ID)"

# Validate RPC connectivity
cast chain-id --rpc-url $BASE_SEPOLIA_RPC_URL
```

**For Agents:**
- Read configuration from source files (e.g., `config/blockchain.ts`)
- Check `.env.example` for variable requirements
- Update `.env.example` when adding new variables
- Document what values are needed and where to obtain them

## Anti-Patterns

### ❌ Package-Specific .env Files

```bash
# WRONG
packages/client/.env
packages/admin/.env
packages/contracts/.env
```

### ❌ Hardcoded Configuration

```typescript
// Wrong
const GARDEN_TOKEN = '0x1234...';
const CHAIN_ID = 84532;

// Correct
import deployment from '../../../contracts/deployments/84532-latest.json';
const GARDEN_TOKEN = deployment.gardenToken;

import { DEFAULT_CHAIN_ID } from '@/config/blockchain';
const chainId = DEFAULT_CHAIN_ID;
```

### ❌ Runtime Chain Switching

```typescript
// Wrong
const { switchChain } = useSwitchChain();
await switchChain({ chainId: 42161 });

// Correct
// Deploy separate app per chain, no switching
```

## Agent Workflow for Environment Variables

### When Adding a New Service Integration

**Example: Adding a new third-party API**

1. **Update `.env.example`:**
```bash
# Add to /Users/afo/Code/greenpill/green-goods/.env.example

# New Service Name (REQUIRED/OPTIONAL)
# Get from: https://dashboard.newservice.com
VITE_NEWSERVICE_API_KEY=get-from-newservice-dashboard
VITE_NEWSERVICE_API_URL=https://api.newservice.com
```

2. **Update this rule file** to document the new category if needed

3. **Update config files** to read the new variable:
```typescript
// packages/client/src/config/newservice.ts
export const NEWSERVICE_API_KEY = import.meta.env.VITE_NEWSERVICE_API_KEY;
export const NEWSERVICE_API_URL = import.meta.env.VITE_NEWSERVICE_API_URL;
```

4. **Inform the user** they need to:
   - Copy `.env.example` to `.env` (if first time)
   - Add actual API key value to `.env`
   - Restart dev server to load new variables

### When Documenting Existing Variables

**Don't attempt to read `.env`** — instead:

1. Check `.env.example` for documented variables
2. Look at config files (e.g., `config/blockchain.ts`) to see how they're used
3. Search codebase for `import.meta.env.VITE_*` or `process.env.*` usage

### Example: Finding What Variables Are Used

```typescript
// Search for: import.meta.env
// In: packages/client/src/config/blockchain.ts

export const DEFAULT_CHAIN_ID = import.meta.env.VITE_CHAIN_ID || "84532";
// This tells you VITE_CHAIN_ID is used and defaults to "84532"
```

## Reference Documents

- **Root .env template:** `/.env.example` ← **AGENTS SHOULD EDIT THIS**
- Client config: `packages/client/src/config/blockchain.ts`
- Admin config: `packages/admin/src/config.ts`
- Network config: `packages/contracts/deployments/networks.json`
- Deployment guide: `docs/DEPLOYMENT.md`
- Environment setup: `docs/ENVIRONMENT_SETUP.md`
