---
description: Green Goods monorepo structure and cross-package conventions
globs:
alwaysApply: true
---

# Monorepo Structure & Conventions

Green Goods is a bun monorepo with 6 packages. This rule provides guidance on cross-package patterns and when to share vs duplicate code.

## Package Architecture

```
packages/
├── client/       # React PWA (offline-first, gardener/operator app)
├── admin/        # Admin dashboard (garden/contract management)
├── shared/       # Common code (hooks, providers, stores, modules)
├── indexer/      # Envio GraphQL (blockchain data indexer)
├── contracts/    # Solidity (EAS integration, TBA accounts)
└── agent/        # Agent for garden interactions
```

## Cross-Package Dependencies

### Import Patterns

**✅ Allowed Cross-Package Imports:**

```typescript
// Client/Admin importing from shared package
import { useAuth, useRole, queryKeys } from '@green-goods/shared';
import { AppProvider, JobQueueProvider } from '@green-goods/shared';
import { workToasts, approvalToasts, mediaResourceManager } from '@green-goods/shared';
import { formatDate, formatDateTime } from '@green-goods/shared';
import type { Garden, Work } from '@green-goods/shared';

// Client/Admin importing contract artifacts
import deployment from '../../../contracts/deployments/84532-latest.json';
import networks from '../../../contracts/deployments/networks.json';
import GardenABI from '../../../contracts/out/Garden.sol/Garden.json';
```

**❌ Forbidden Cross-Package Imports:**

```typescript
// Don't import source code directly across packages
import { someUtil } from '../../client/src/utils/helper';

// Don't import from other package internals
import { SomeComponent } from '../../admin/src/components/Foo';

// Don't deep-import from shared (breaks encapsulation)
import { useAuth } from '@green-goods/shared/src/hooks/auth/useAuth';
```

### When to Share vs Duplicate

**Share via `@green-goods/shared`:**
- React hooks (auth, garden, work, blockchain)
- React providers (Auth, JobQueue, Work, App)
- Zustand stores (admin, UI, workFlow)
- Core modules (job-queue, data, work, auth)
- Toast presets and utilities (workToasts, approvalToasts, queueToasts, validationToasts, walletProgressToasts)
- Date/time utilities (formatDate, formatDateTime, toDateTimeLocalValue, fromDateTimeLocalValue)
- Media resource manager (mediaResourceManager)
- TypeScript types and utilities
- i18n translations

**Share via `contracts/deployments/`:**
- Contract addresses
- Network configurations
- ABI files
- Deployment metadata

**Keep in each package:**
- UI components (client/admin have different UX patterns)
- Route configurations
- Package-specific views
- Package-specific configuration

**Why:** The shared package provides common logic while keeping UI concerns separate.

## Hook Boundary (CRITICAL)

**ALL hooks live in `@green-goods/shared`.** Client and admin packages MUST NOT define hooks.

```typescript
// ✅ Correct — import from shared
import { useAuth, useWorks, useRole } from "@green-goods/shared";

// ❌ Wrong — no hooks in client/admin
// packages/client/src/hooks/useLocalHook.ts
export function useLocalHook() { ... }
```

If you need new hook functionality:
1. Create in `packages/shared/src/hooks/{domain}/`
2. Export from `packages/shared/src/hooks/index.ts`
3. Re-export from `packages/shared/src/index.ts`
4. Import in client/admin from `@green-goods/shared`

See `packages/shared/.cursor/rules/hook-architecture.mdc` for full hook documentation.

## Workspace Commands

### Running Commands

```bash
# Run in specific package
bun --filter client dev
bun --filter contracts test

# Run in all packages
bun -r test
bun -r build

# From package directory
cd packages/client && bun dev
```

### Package Scripts

Each package has consistent npm scripts:
- `dev`: Start development server
- `build`: Production build
- `test`: Run tests
- `lint`: Run linters
- `format`: Format code

## Dependency Management

### Adding Dependencies

```bash
# Add to specific package
bun --filter client add viem

# Add to root (workspace tools)
bun add -w -D vitest

# Add to all packages
bun -r add lodash
```

### Version Alignment

Keep these dependencies aligned across client/admin:
- react, react-dom
- typescript
- vite
- @tanstack/react-query
- viem

**Check alignment:**
```bash
bun list react --depth=0 -r
```

## Testing Across Packages

### Integration Testing

When features span packages:

1. **Client ↔ Contracts:** Test via E2E (Playwright)
2. **Indexer ↔ Contracts:** Test event processing in indexer tests
3. **Admin ↔ Contracts:** Test transaction flows in admin integration tests

### Test Data Sharing

**✅ Do:**
- Use deployed contract addresses from deployment JSON
- Reference same test wallets across packages
- Share test network configurations

**❌ Don't:**
- Import test utilities from other packages
- Couple test suites across packages
- Share mock data structures

## Build Order

Packages have build dependencies:

1. **contracts** (must build first — generates ABIs)
2. **shared** (needs deployment artifacts, provides hooks/modules)
3. **indexer** (needs contract ABIs)
4. **client** (needs shared package and deployment artifacts)
5. **admin** (needs shared package and deployment artifacts)
6. **agent** (needs shared package)

**Build all in order:**
```bash
bun build
```

bun handles dependency graph automatically.

## Code Ownership

### File Locations by Concern

**Shared Logic (`@green-goods/shared`):**
- Hooks: `packages/shared/src/hooks/`
- Providers: `packages/shared/src/providers/`
- Stores: `packages/shared/src/stores/`
- Modules: `packages/shared/src/modules/`
- Types: `packages/shared/src/types/`

**Blockchain logic:**
- Solidity: `packages/contracts/src/`
- TypeScript wrappers: `packages/shared/src/modules/data/`

**UI Components:**
- Client: `packages/client/src/components/`
- Admin: `packages/admin/src/components/`
- **Never share** between client/admin (different UX patterns)

**Data Fetching:**
- GraphQL clients: `packages/shared/src/modules/data/`
- Indexer schema: `packages/indexer/schema.graphql`

**Configuration:**
- Deployment artifacts: `packages/contracts/deployments/`
- Shared config: `packages/shared/src/config/`
- Package-specific: Each package's `src/config.ts`

## TypeScript Configuration

All packages inherit from root `tsconfig.json`:

```json
{
  "compilerOptions": {
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "resolveJsonModule": true
  }
}
```

### Path Aliases

Each package configures its own aliases:

**Client/Admin:**
```typescript
// Use @ prefix for src/
import { Button } from '@/components/UI/Button';
import { useAuth } from '@/hooks/auth/useAuth';
```

**Contracts:**
```solidity
// Use foundry remappings
import {ERC721} from "@openzeppelin/contracts/token/ERC721/ERC721.sol";
```

## Common Anti-Patterns

### ❌ Don't Create Package-Specific .env Files

```bash
# Wrong
packages/client/.env
packages/admin/.env

# Correct
.env  # Root only
```

### ❌ Don't Duplicate Contract Addresses

```typescript
// Wrong
const GARDEN_TOKEN = '0x123...';

// Correct
import deployment from '../../../contracts/deployments/84532-latest.json';
const GARDEN_TOKEN = deployment.gardenToken;
```

### ❌ Don't Import Across Frontend Packages

```typescript
// Wrong - direct cross-package import
import { useRole } from '../../admin/src/hooks/useRole';

// Correct - use shared package
import { useRole } from '@green-goods/shared';
```

### ❌ Don't Skip Build Order

```bash
# Wrong
cd packages/client && bun build  # Might fail if contracts not built

# Correct
bun build  # From root, handles order
```

## MCP Integration for Monorepo

### Using GitHub MCP

```bash
# Query cross-package issues
@github: List all open issues tagged "client" or "contracts"

# Create issues with context
@github: Create issue "Add garden invite system" with labels: feature, client, contracts

# PR management
@github: List PRs that modify both client and contracts packages
```

### Using Filesystem MCP

```bash
# Cross-package searches
@filesystem: Find all files importing from '../../../contracts/deployments'

# Bulk operations
@filesystem: List all TypeScript files in client and admin that use viem
```

## Migration Checklist

When moving logic between packages:

- [ ] Update imports to use deployment artifacts (not hardcoded)
- [ ] Ensure no source code imports across packages
- [ ] Update both package tests
- [ ] Update relevant README files
- [ ] Check for duplicate type definitions
- [ ] Validate build still works with `bun build`

## Reference Documents

- Root README: `/README.md`
- Architecture: `/docs/ARCHITECTURE.md`
- Package READMEs: `packages/*/README.md`
- Agent rules: `.cursor/rules/*.mdc`, `packages/*/.cursor/rules/*.mdc`
