---
description: Indexer development workflow â€” codegen, Docker, reset procedures, troubleshooting
alwaysApply: false
---
# Indexer Development Workflow

## Prerequisites

**Docker Desktop must be running.** The indexer runs in Docker containers.

```bash
# Start Docker Desktop (macOS)
open -a Docker
# Wait 30 seconds for it to fully start
docker ps  # Verify it's working
```

## Common Commands

```bash
# Start indexer (checks Docker, stops existing, sets up ReScript, starts)
bun dev

# Stop indexer
bun stop

# Reset state completely (for Docker/database issues)
bun reset

# Regenerate after schema/config changes
bun codegen

# Setup ReScript dependencies only (run after codegen)
bun run setup-generated

# Start without automatic setup (assumes already setup)
bun run dev:manual
```

## When to Run Codegen

- After changing `schema.graphql`
- After updating `config.yaml`
- After adding new contract events
- When generated types are missing

**Important:** After running `bun codegen`, also run `bun run setup-generated` to rebuild ReScript.

## When to Reset

- Docker overlay filesystem errors
- Database schema migrations
- "Failed to mount" or "no such file or directory" errors
- Starting fresh after testing
- Resolving persistent Docker issues

## Troubleshooting

### "Docker is not running" Error

```bash
open -a Docker
# Wait 30 seconds
docker ps  # Verify it's working
bun dev
```

### Docker Overlay/Mount Errors

Symptoms: `failed to mount /var/lib/docker/rootfs/stargz`, `no such file or directory`

```bash
# Quick fix
bun reset

# Or manual cleanup
docker compose down -v
docker ps -a --filter "name=generated-envio" --format "{{.ID}}" | xargs docker rm -f
docker volume ls --filter "name=generated" --format "{{.Name}}" | xargs docker volume rm
rm -rf generated/persisted_state.envio.json .envio
docker system prune -f
```

Then restart Docker Desktop and run `bun dev`.

### ReScript Compilation Errors

Symptom: `Cannot find module 'rescript-envsafe/src/EnvSafe.res.js'`

The `bun dev` command handles this automatically. If issues persist:

```bash
bun reset
bun run setup-generated
bun run dev:manual
```

Or manually:

```bash
cd generated
pnpm install
pnpm run build
cd ..
bun run dev:manual
```

**Why:** ReScript needs dependencies installed locally in `generated/` folder. bun's workspace hoisting puts dependencies at root, but Envio uses pnpm for proper resolution.

### Port Conflicts

```bash
# Port 8080 (GraphQL Playground)
lsof -i :8080
kill -9 <PID>

# Port 9898 (HyperSync)
lsof -i :9898
kill -9 <PID>
```

Or use `bun stop` which kills both ports.

### Database Connection Issues

1. Ensure Docker Desktop is running
2. Check container health: `docker compose ps`
3. View logs: `docker compose logs -f`
4. If unhealthy, reset: `bun reset`

## Daily Workflow

```bash
# Morning: Start Docker Desktop once
open -a Docker

# Then any time you need the indexer:
bun dev

# Stop when done:
bun stop
# or just Ctrl+C
```

## GraphQL Playground

- **URL:** http://localhost:8080
- **Password:** `testing`
- **Health check:** http://localhost:8080/healthz

## Reference

- AGENTS.md: `packages/indexer/AGENTS.md`
- README: `packages/indexer/README.md`
- Envio docs: https://docs.envio.dev
