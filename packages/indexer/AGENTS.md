# Green Goods Indexer — Envio GraphQL

The indexer exposes Green Goods blockchain data via GraphQL using Envio.

## Quick Reference

**Prerequisites:** Ensure Docker Desktop is running (`open -a Docker`)  
**Start:** `bun dev` (checks Docker, stops existing instances, sets up ReScript, starts indexer)  
**Stop:** `bun stop`  
**GraphQL Playground:** http://localhost:8080 (password: `testing`)  
**Codegen:** `bun codegen` (then run `bun run setup-generated`)  
**Reset:** `bun reset` or `./reset-indexer.sh`  
**Setup Only:** `bun run setup-generated`

**If "Docker not running" error:** Run `open -a Docker`, wait 30 seconds, then `bun dev`

## Architecture

```
packages/indexer/
├── config.yaml          # Envio configuration (defines contracts + ABIs)
├── schema.graphql       # GraphQL schema (entities)
├── src/
│   └── EventHandlers.ts # Event processing logic
├── queries/
│   └── OptimizedQueries.ts # Reusable GraphQL queries
├── generated/           # Auto-generated by Envio (includes ABIs)
├── reset-indexer.sh     # Reset script for Docker cleanup
└── setup-and-start.sh   # Setup script
```

**Note:** Contract ABIs are defined inline in `config.yaml` and auto-generated in `generated/`. No separate `abis/` folder is needed.

## Entity Conventions

### Always Include chainId

**MANDATORY:** All entities must include `chainId` field:

```graphql
type Garden @entity {
  id: ID!
  chainId: Int!           # ← Required for multi-chain
  tokenAddress: String!
  tokenID: BigInt!
  name: String!
  description: String!
  # ...
}
```

**Why:** Green Goods supports multiple chains. Without chainId, frontend can't filter data correctly.

### Composite IDs

Use `chainId-identifier` pattern:

```typescript
// EventHandlers.ts
const gardenId = `${chainId}-${tokenId}`;

Garden.set({
  id: gardenId,
  chainId: chainId,
  tokenAddress: event.srcAddress,
  tokenID: event.params.tokenId,
  // ...
});
```

## Event Handler Patterns

### GardenCreated Handler

```typescript
GardenToken.GardenCreated.handler(async ({ event, context }) => {
  const chainId = event.chainId;
  const tokenId = event.params.tokenId.toString();
  const gardenId = `${chainId}-${tokenId}`;
  
  // Fetch metadata from contract
  const metadata = await context.GardenToken.tokenMetadata(event.params.tokenId);
  
  // Parse metadata
  const { name, description, location, bannerImage, gardeners, operators } = parseMetadata(metadata);
  
  // Create Garden entity
  context.Garden.set({
    id: gardenId,
    chainId: chainId,
    tokenAddress: event.srcAddress,
    tokenID: event.params.tokenId,
    name: name,
    description: description,
    location: location,
    bannerImage: bannerImage,
    gardeners: gardeners || [],
    operators: operators || [],
    createdAt: event.block.timestamp,
  });
});
```

### ActionRegistered Handler

```typescript
ActionRegistry.ActionRegistered.handler(async ({ event, context }) => {
  const chainId = event.chainId;
  const actionUID = event.params.actionUID.toString();
  const actionId = `${chainId}-${actionUID}`;
  
  context.Action.set({
    id: actionId,
    chainId: chainId,
    ownerAddress: event.params.owner,
    startTime: event.params.startTime,
    endTime: event.params.endTime,
    title: event.params.title,
    instructions: event.params.instructions,
    capitals: event.params.capitals,
    media: event.params.media,
    createdAt: event.block.timestamp,
  });
});
```

## Error Handling

### Graceful Degradation

```typescript
try {
  const metadata = await context.GardenToken.tokenMetadata(tokenId);
  const parsed = JSON.parse(metadata);
  
  context.Garden.set({
    id: gardenId,
    name: parsed.name || 'Unnamed Garden',
    description: parsed.description || '',
    // ... with fallbacks
  });
} catch (error) {
  console.error(`[GardenCreated] Failed to fetch metadata for ${gardenId}:`, error);
  
  // Create garden with minimal data
  context.Garden.set({
    id: gardenId,
    chainId: chainId,
    name: 'Garden (Loading...)',
    description: '',
    // ...
  });
}
```

## Development Workflow

### Codegen Trigger

Run codegen after:
- Changing `schema.graphql`
- Updating `config.yaml`
- Adding new events

```bash
bun codegen
bun run setup-generated  # Rebuild ReScript after codegen
```

### Docker Management

```bash
# Start indexer
bun dev

# Stop containers
docker compose down

# Reset completely
bun reset

# View logs
docker compose logs -f envio
```

### ReScript Compilation

ReScript dependencies are automatically installed when running `bun dev`.

If you encounter ReScript errors manually run:

```bash
bun run setup-generated
```

Or manually:

```bash
cd generated
pnpm install
pnpm run build
cd ..
```

## Troubleshooting

### Docker Overlay Errors

```bash
# Quick fix
bun reset

# Or manual cleanup
docker compose down -v
docker ps -a --filter "name=generated-envio" --format "{{.ID}}" | xargs docker rm -f
docker volume ls --filter "name=generated" --format "{{.Name}}" | xargs docker volume rm
rm -rf generated/persisted_state.envio.json .envio
```

### Port 8080 in Use

```bash
# Find process
lsof -i :8080

# Kill process
kill -9 <PID>
```

## GraphQL Query Patterns

### Frontend Usage

```typescript
// Client/Admin fetches from indexer via shared package
import { greenGoodsIndexer, graphql } from '@green-goods/shared';

const QUERY = graphql(`
  query Gardens($chainId: Int!) {
    Garden(where: {chainId: {_eq: $chainId}}) {
      id
      name
      location
      gardeners
    }
  }
`);

const { data } = await greenGoodsIndexer.query(QUERY, { chainId: 84532 }).toPromise();
```

## Reference Documentation

- Envio docs: https://docs.envio.dev
- Indexer README: `/packages/indexer/README.md`
- Root guide: `/AGENTS.md`

