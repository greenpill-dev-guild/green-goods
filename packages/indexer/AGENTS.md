# Green Goods Indexer — Envio GraphQL

The indexer exposes Green Goods blockchain data via GraphQL using Envio.

## Quick Reference

**Prerequisites:** Ensure Docker Desktop is running (`open -a Docker`)  
**Start:** `bun dev` (checks Docker, stops existing instances, sets up ReScript, starts indexer)  
**Stop:** `bun stop`  
**GraphQL Playground:** http://localhost:8080 (password: `testing`)  
**Codegen:** `bun codegen` (then run `bun run setup-generated`)  
**Reset:** `bun reset` or `./reset-indexer.sh`  
**Setup Only:** `bun run setup-generated`

**If "Docker not running" error:** Run `open -a Docker`, wait 30 seconds, then `bun dev`

## Architecture

```
packages/indexer/
├── config.yaml          # Envio configuration (defines contracts + ABIs)
├── schema.graphql       # GraphQL schema (entities)
├── src/
│   └── EventHandlers.ts # Event processing logic
├── queries/
│   └── OptimizedQueries.ts # Reusable GraphQL queries
├── generated/           # Auto-generated by Envio (includes ABIs)
├── reset-indexer.sh     # Reset script for Docker cleanup
└── setup-and-start.sh   # Setup script
```

**Note:** Contract ABIs are defined inline in `config.yaml` and auto-generated in `generated/`. No separate `abis/` folder is needed.

## Entity Conventions

### Always Include chainId

**MANDATORY:** All entities must include `chainId` field:

```graphql
type Garden @entity {
  id: ID!
  chainId: Int!           # ← Required for multi-chain
  tokenAddress: String!
  tokenID: BigInt!
  name: String!
  description: String!
  # ...
}
```

**Why:** Green Goods supports multiple chains. Without chainId, frontend can't filter data correctly.

### Composite IDs

Use `chainId-identifier` pattern:

```typescript
// EventHandlers.ts
const gardenId = `${chainId}-${tokenId}`;

Garden.set({
  id: gardenId,
  chainId: chainId,
  tokenAddress: event.srcAddress,
  tokenID: event.params.tokenId,
  // ...
});
```

## Event Handler Patterns

### GardenCreated Handler

```typescript
GardenToken.GardenCreated.handler(async ({ event, context }) => {
  const chainId = event.chainId;
  const tokenId = event.params.tokenId.toString();
  const gardenId = `${chainId}-${tokenId}`;
  
  // Fetch metadata from contract
  const metadata = await context.GardenToken.tokenMetadata(event.params.tokenId);
  
  // Parse metadata
  const { name, description, location, bannerImage, gardeners, operators } = parseMetadata(metadata);
  
  // Create Garden entity
  context.Garden.set({
    id: gardenId,
    chainId: chainId,
    tokenAddress: event.srcAddress,
    tokenID: event.params.tokenId,
    name: name,
    description: description,
    location: location,
    bannerImage: bannerImage,
    gardeners: gardeners || [],
    operators: operators || [],
    createdAt: event.block.timestamp,
  });
});
```

### ActionRegistered Handler

```typescript
ActionRegistry.ActionRegistered.handler(async ({ event, context }) => {
  const chainId = event.chainId;
  const actionUID = event.params.actionUID.toString();
  const actionId = `${chainId}-${actionUID}`;
  
  context.Action.set({
    id: actionId,
    chainId: chainId,
    ownerAddress: event.params.owner,
    startTime: event.params.startTime,
    endTime: event.params.endTime,
    title: event.params.title,
    instructions: event.params.instructions,
    capitals: event.params.capitals,
    media: event.params.media,
    createdAt: event.block.timestamp,
  });
});
```

## Error Handling

### Graceful Degradation

```typescript
try {
  const metadata = await context.GardenToken.tokenMetadata(tokenId);
  const parsed = JSON.parse(metadata);
  
  context.Garden.set({
    id: gardenId,
    name: parsed.name || 'Unnamed Garden',
    description: parsed.description || '',
    // ... with fallbacks
  });
} catch (error) {
  console.error(`[GardenCreated] Failed to fetch metadata for ${gardenId}:`, error);
  
  // Create garden with minimal data
  context.Garden.set({
    id: gardenId,
    chainId: chainId,
    name: 'Garden (Loading...)',
    description: '',
    // ...
  });
}
```

## Development Workflow

### Codegen Trigger

Run codegen after:
- Changing `schema.graphql`
- Updating `config.yaml`
- Adding new events

```bash
bun codegen
bun run setup-generated  # Rebuild ReScript after codegen
```

### Docker Management

```bash
# Start indexer
bun dev

# Stop containers
docker compose down

# Reset completely
bun reset

# View logs
docker compose logs -f envio
```

### ReScript Compilation

ReScript dependencies are automatically installed when running `bun dev`.

If you encounter ReScript errors manually run:

```bash
bun run setup-generated
```

Or manually:

```bash
cd generated
pnpm install
pnpm run build
cd ..
```

## Troubleshooting

### Docker Overlay Errors

```bash
# Quick fix
bun reset

# Or manual cleanup
docker compose down -v
docker ps -a --filter "name=generated-envio" --format "{{.ID}}" | xargs docker rm -f
docker volume ls --filter "name=generated" --format "{{.Name}}" | xargs docker volume rm
rm -rf generated/persisted_state.envio.json .envio
```

### Port 8080 in Use

```bash
# Find process
lsof -i :8080

# Kill process
kill -9 <PID>
```

## Testing

### Test Commands

```bash
# Run tests (auto-bootstraps if generated/ doesn't exist)
bun test

# Explicit full setup + test
bun run test:full

# Setup generated files only (without running tests)
bun run test:setup
```

### Test Setup

Tests require the `generated/` folder which contains Envio's test helpers:

1. `bun run codegen` — Generates TypeScript types and test helpers from `config.yaml` and `schema.graphql`
2. `bun run setup-generated` — Installs pnpm dependencies and builds ReScript in `generated/`

The `pretest` script automatically runs setup if `generated/src` doesn't exist.

### Test Coverage

Tests cover key event handler logic:

**Capital Mapping (10 tests)**
- All 8 capital types (SOCIAL, MATERIAL, FINANCIAL, LIVING, INTELLECTUAL, EXPERIENTIAL, SPIRITUAL, CULTURAL)
- UNKNOWN fallback for invalid values
- Multiple capitals in single action

**Multi-Chain ID Collision Prevention (3 tests)**
- Same actionUID on different chains creates separate entities
- Same gardener address on different chains creates separate entities
- Chain-prefixed IDs: `${chainId}-${identifier}`

**Bidirectional Gardener ↔ Garden Updates (4 tests)**
- GardenerAdded updates both Garden.gardeners and Gardener.gardens
- GardenerRemoved updates both entities
- Existing gardener added to second garden preserves firstGarden

**Create If Not Exists Pattern (4 tests)**
- NameUpdated creates minimal garden if not exists
- DescriptionUpdated, LocationUpdated, BannerImageUpdated same pattern

**Action/Garden CRUD (8+ tests)**
- ActionRegistered creates action with all fields
- Update handlers preserve other fields
- Operator add/remove
- OpenJoining toggle
- GAP project integration

### Writing New Tests

```typescript
import { TestHelpers, ActionRegistry, GardenToken, GardenAccount } from "generated";
const { MockDb, Addresses } = TestHelpers;

it("example test", async () => {
  // 1. Create mock database
  let mockDb = MockDb.createMockDb();
  
  // 2. Optionally pre-seed entities
  mockDb = mockDb.entities.Garden.set({
    id: "0x123...",
    chainId: 42161,
    // ... fields
  });
  
  // 3. Create mock event
  const mockEvent = GardenAccount.GardenerAdded.createMockEvent({
    updater: "0x...",
    gardener: "0x...",
    mockEventData: {
      chainId: 42161,
      block: { timestamp: 12345 },
      srcAddress: "0x123...", // Contract address (garden)
    },
  });
  
  // 4. Process event
  const result = await GardenAccount.GardenerAdded.processEvent({
    event: mockEvent,
    mockDb,
  });
  
  // 5. Assert results
  const garden = result.entities.Garden.get("0x123...");
  assert.ok(garden.gardeners.includes("0x..."));
});
```

## GraphQL Query Patterns

### Frontend Usage

```typescript
// Client/Admin fetches from indexer via shared package
import { greenGoodsIndexer, graphql } from '@green-goods/shared';

const QUERY = graphql(`
  query Gardens($chainId: Int!) {
    Garden(where: {chainId: {_eq: $chainId}}) {
      id
      name
      location
      gardeners
    }
  }
`);

const { data } = await greenGoodsIndexer.query(QUERY, { chainId: 84532 }).toPromise();
```

## Reference Documentation

- Envio docs: https://docs.envio.dev
- Indexer README: `/packages/indexer/README.md`
- Root guide: `/AGENTS.md`

