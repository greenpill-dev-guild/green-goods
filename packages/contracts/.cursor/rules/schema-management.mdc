---
description: EAS schema management — IMMUTABLE schemas.json, versioning, deployment
globs:
  - config/schemas.json
  - script/*Schema*.sol
  - script/deploy.js
alwaysApply: false
---

# Schema Management — CRITICAL RULES

## IMMUTABILITY RULE (CRITICAL)

**⛔ NEVER MODIFY:** `config/schemas.json`

This file defines **production EAS schemas** deployed on-chain. Modifying it:
- Creates duplicate schemas with wrong metadata
- Breaks indexer queries
- Confuses users on EAS explorers
- Makes historical attestations unfindable

**If you need test schemas:** Create `schemas.test.json` instead.

## schemas.json Structure

```json
{
  "gardenAssessment": {
    "name": "Green Goods Assessment v3",
    "description": "Garden assessment attestation for Green Goods protocol",
    "fields": [
      { "name": "version", "type": "uint8" },
      { "name": "soilMoisturePercentage", "type": "uint32" },
      // ...
    ]
  },
  "work": {
    "name": "Green Goods Work Submission",
    "description": "Work submission attestation",
    "fields": [
      { "name": "actionUID", "type": "uint256" },
      { "name": "title", "type": "string" },
      { "name": "feedback", "type": "string" },
      { "name": "metadata", "type": "string" },
      { "name": "media", "type": "string[]" }
    ]
  },
  "workApproval": {
    "name": "Green Goods Work Approval",
    "description": "Work approval attestation",
    "fields": [
      { "name": "actionUID", "type": "uint256" },
      { "name": "workUID", "type": "bytes32" },
      { "name": "approved", "type": "bool" },
      { "name": "feedback", "type": "string" }
    ]
  }
}
```

## Schema Deployment

### Automatic Deployment

Schemas deploy automatically with core contracts:

```bash
bun deploy:testnet
# Deploys contracts + schemas

node script/deploy.js core --network baseSepolia --broadcast
# Includes schema deployment
```

### Schema-Only Update

```bash
# Update schema names/descriptions only (doesn't create new UIDs)
node script/deploy.js core --network baseSepolia --broadcast --update-schemas
```

**Use when:** Fixing schema name typo or description without changing fields.

### Skip Schemas

```bash
# Deploy contracts without schemas (if schemas already exist)
node script/deploy.js core --network baseSepolia --broadcast --skip-schemas
```

## Schema Versioning Strategy

### Adding New Fields (Non-Breaking)

**Don't modify schemas.json.** Instead:

1. Create new schema version in separate file
2. Deploy new schema to get new UID
3. Update encoders to support both versions
4. Frontend decodes based on schema UID

### Schema Evolution Example

```typescript
// utils/eas/encoders.ts

// V1 encoding (old schema)
function encodeWorkDataV1(data: WorkDraft) {
  return encodeAbiParameters([
    { name: 'actionUID', type: 'uint256' },
    { name: 'feedback', type: 'string' },
    { name: 'media', type: 'string[]' },
  ], [data.actionUID, data.feedback, data.media]);
}

// V2 encoding (new schema with title field)
function encodeWorkDataV2(data: WorkDraft) {
  return encodeAbiParameters([
    { name: 'actionUID', type: 'uint256' },
    { name: 'title', type: 'string' },     // New field
    { name: 'feedback', type: 'string' },
    { name: 'media', type: 'string[]' },
  ], [data.actionUID, data.title, data.feedback, data.media]);
}

// Use V2 for new attestations
export function encodeWorkData(data: WorkDraft) {
  return encodeWorkDataV2(data);
}
```

## Test Schemas

For testing, create separate schema configuration:

```json
// config/schemas.test.json
{
  "workTest": {
    "name": "Green Goods Work Test",
    "description": "Test schema for work submissions",
    "fields": [
      { "name": "actionUID", "type": "uint256" },
      { "name": "testField", "type": "string" }
    ]
  }
}
```

## Anti-Patterns

### ❌ Never Modify Production Schemas

```json
// ❌ WRONG - Don't edit config/schemas.json
{
  "work": {
    "fields": [
      { "name": "newField", "type": "string" }  // ❌ Creates duplicate schema
    ]
  }
}
```

### ❌ Never Hardcode Schema UIDs

```typescript
// Wrong
const WORK_SCHEMA_UID = '0x123...';

// Correct - load from deployment
import deployment from '../deployments/84532-latest.json';
const WORK_SCHEMA_UID = deployment.schemas.workSchemaUID;
```

## Reference Files

- Schemas: `config/schemas.json` (READ ONLY)
- Deployment script: `script/deploy.js`
- Schema utilities: `script/utils/`
- Encoders: Frontend uses these (client/admin)
- Deployment artifacts: `deployments/*-latest.json`
