---
description: UUPS upgrade patterns â€” storage gaps, safety checklist, upgrade testing
globs:
  - src/**/*.sol
  - script/upgrade.ts
  - script/Upgrade.s.sol
alwaysApply: false
---

# UUPS Upgrade Patterns

Green Goods contracts use UUPS (Universal Upgradeable Proxy Standard).

## Storage Gap Requirement

**MANDATORY:** All upgradeable contracts must have `__gap`:

```solidity
// Example: GreenGoodsResolver
contract GreenGoodsResolver is OwnableUpgradeable, UUPSUpgradeable {
    mapping(bytes32 => bool) private _enabledModules;      // slot 1
    mapping(address => bool) public authorizedCallers;     // slot 2
    OctantModule public octantModule;                       // slot 3
    UnlockModule public unlockModule;                       // slot 4

    uint256[46] private __gap;  // 50 - 4 = 46 slots reserved
}

// Example: Module (OctantModule)
contract OctantModule is OwnableUpgradeable, UUPSUpgradeable {
    IOctantFactory public octantFactory;                    // slot 1
    address public defaultAsset;                            // slot 2
    address public router;                                  // slot 3
    mapping(address => address) public gardenVaults;        // slot 4
    uint256 public defaultProfitUnlockTime;                 // slot 5

    uint256[45] private __gap;  // 50 - 5 = 45 slots
}
```

### Calculating Gap Size
```
Gap size = 50 - (number of state variables)
```

## Upgrade vs Deploy

| Scenario | Command |
|----------|---------|
| New network setup | `bun deploy:testnet` |
| Bug fix in production | `bun upgrade:testnet` |
| Add features | `bun upgrade:testnet` |
| Fresh state needed | `bun deploy:testnet --force` |

## Upgrade Commands

```bash
# Dry run
bun upgrade:dry:testnet
bun script/upgrade.ts all --network baseSepolia

# Execute
bun upgrade:testnet
bun script/upgrade.ts all --network baseSepolia --broadcast

# Verify after upgrade
cast call $CONTRACT "implementation()" --rpc-url $RPC
```

## Upgrade Safety Checklist

Before upgrading:
- [ ] Storage gap present and correctly sized
- [ ] No storage variable reordering
- [ ] No storage variable type changes
- [ ] New variables added at end only
- [ ] Upgrade test passes
- [ ] No breaking changes to public API

## Upgradeable Contracts

| Contract | Storage Slots | Gap |
|----------|---------------|-----|
| GardenToken | 2 | 48 |
| GardenAccount | varies | varies |
| GreenGoodsResolver | 4 | 46 |
| OctantModule | 5 | 45 |
| UnlockModule | 4 | 46 |
| WorkResolver | 1 | 49 |
| WorkApprovalResolver | 2 | 48 |
| AssessmentResolver | 1 | 49 |

## UUPS Implementation Pattern

```solidity
// Required imports
import {OwnableUpgradeable} from "@openzeppelin/contracts-upgradeable/access/OwnableUpgradeable.sol";
import {UUPSUpgradeable} from "@openzeppelin/contracts/proxy/utils/UUPSUpgradeable.sol";

contract MyModule is OwnableUpgradeable, UUPSUpgradeable {
    // Disable initializers in constructor
    /// @custom:oz-upgrades-unsafe-allow constructor
    constructor() {
        _disableInitializers();
    }

    // Initialize instead of constructor
    function initialize(address _owner) external initializer {
        __Ownable_init();
        _transferOwnership(_owner);
    }

    // Authorize upgrades (owner only)
    function _authorizeUpgrade(address) internal override onlyOwner {}
}
```

## Reference

- Upgrade script: `script/upgrade.ts`
- Upgrade Forge script: `script/Upgrade.s.sol`
- Root deployment rule: `/.cursor/rules/deployment.mdc`
