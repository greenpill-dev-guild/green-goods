---
description: Gas optimization patterns — via-ir, storage packing, event strategies
globs:
  - src/**/*.sol
alwaysApply: false
---

# Gas Optimization Patterns

Green Goods contracts optimize for gas efficiency while maintaining readability and safety.

## Compiler Optimization

### via-ir Flag

**Enabled in foundry.toml:**

```toml
[profile.default]
via_ir = true
optimizer = true
optimizer_runs = 200
```

**Benefits:**
- Better optimization
- Smaller bytecode
- Lower deployment costs
- More efficient runtime

## Storage Packing

### Pack Variables

```solidity
// ✅ Optimized - packed into 1 slot
uint128 public startTime;
uint128 public endTime;

// ❌ Wasteful - uses 2 slots
uint256 public startTime;
uint256 public endTime;
```

### Struct Packing

```solidity
struct WorkData {
    address gardener;      // 20 bytes
    uint32 timestamp;      // 4 bytes
    uint96 actionUID;      // 12 bytes
    // Total: 32 bytes (1 slot)
}
```

## Event vs Storage Trade-off

```solidity
// ✅ Use events for historical data
event WorkSubmitted(uint256 indexed actionUID, address indexed gardener, string ipfsHash);

// ❌ Don't store if only needed for history
mapping(uint256 => string) public workHistory;  // Expensive
```

## Reference Files

- Foundry config: `foundry.toml`
- Gas report: Run `forge test --gas-report`
