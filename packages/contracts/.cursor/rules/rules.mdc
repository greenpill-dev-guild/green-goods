---
description: Contracts — Solidity style, safety, gas, events, and testing with Foundry.
globs:
  - "packages/contracts/src/**/*.sol"
  - "packages/contracts/script/**/*"
  - "packages/contracts/test/**/*"
alwaysApply: false
---

# Contracts Rules

Main rules for Green Goods Solidity contracts. See specialized rules for:
- `deployment-patterns.mdc` — Deployment CLI and commands
- `schema-management.mdc` — EAS schema immutability (CRITICAL)
- `uups-upgrades.mdc` — Storage gaps and upgrade safety

## Custom Errors (MANDATORY)

```solidity
// ✅ Define at contract top
error ZeroAddress(string paramName);
error UnauthorizedCaller(address caller);

// ✅ Use instead of require
if (addr == address(0)) revert ZeroAddress("tokenAddress");

// ❌ Don't use require with strings
require(addr != address(0), "Zero address");
```

## Empty Blocks

```solidity
// ✅ Justify with solhint disable
function _authorizeUpgrade(address) internal override onlyOwner {
    // solhint-disable-line no-empty-blocks
}
```

## Code Style

- SPDX header; pinned `pragma solidity ^0.8.25`
- OpenZeppelin contracts where possible
- Checks-Effects-Interactions pattern
- ReentrancyGuard if funds move
- Prefer `calldata` for external args

## Events

```solidity
// ✅ Index addresses and IDs for filtering
event WorkSubmitted(uint256 indexed actionUID, address indexed gardener, string ipfsHash);
event ModuleExecutionSuccess(bytes32 indexed moduleId, address indexed garden, bytes32 indexed uid);
```

---

## Gas Optimization

### Compiler Settings

```toml
# foundry.toml
[profile.default]
via_ir = true        # Required for GardenAccount
optimizer = true
optimizer_runs = 200
```

### Storage Packing

```solidity
// ✅ Pack into 1 slot
uint128 public startTime;
uint128 public endTime;

// ❌ Wastes 2 slots
uint256 public startTime;
uint256 public endTime;
```

### Module Isolation

```solidity
// Non-blocking module calls
try octantModule.onWorkApproved(garden, name) returns (address vault) {
    emit ModuleExecutionSuccess(MODULE_OCTANT, garden, workUID);
} catch {
    emit ModuleExecutionFailed(MODULE_OCTANT, garden, workUID);
}
```

---

## Testing

### Naming Convention

```solidity
// Pattern: test[Contract]_[scenario]
function testGardenToken_mintsNewGarden() public {}
function testGardenToken_revertsOnUnauthorized() public {}

// Prefixes
test_         // Happy path
testRevert_   // Failure cases
testFuzz_     // Fuzz tests
testE2E_      // Multi-contract flows
```

### Test Structure

```solidity
contract GardenTokenTest is Test {
    GardenToken public gardenToken;
    
    function setUp() public {
        gardenToken = new GardenToken();
        gardenToken.initialize();
    }
    
    function testGardenToken_mintsNewGarden() public {
        uint256 tokenId = gardenToken.mintGarden(address(this), "ipfs://...");
        assertEq(gardenToken.ownerOf(tokenId), address(this));
    }
    
    function testRevert_unauthorized() public {
        vm.prank(address(0x1));
        vm.expectRevert(abi.encodeWithSelector(UnauthorizedCaller.selector, address(0x1)));
        gardenToken.mintGarden(address(this), "");
    }
}
```

### Commands

```bash
bun test              # Run all (excludes E2E)
bun test:gas          # With gas report
bun test:e2e          # Integration tests
bun lint              # Format + solhint
```

### Gas Benchmarks

| Function | Target |
|----------|--------|
| mintGarden | <500k |
| registerAction | <200k |
| Work attest | <150k |
| Work approval | <100k |

### Coverage

- **Testnet:** ≥80% pass rate
- **Mainnet:** 100% pass rate required
