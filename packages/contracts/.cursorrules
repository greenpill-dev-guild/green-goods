# Green Goods Contracts - Production Readiness Rules

## Purpose
This file provides rules for AI agents to assess production readiness of Green Goods smart contracts before deployment to testnets or mainnet.

## Deployment Readiness Assessment Protocol

When asked about production readiness for Base Sepolia or any network, execute these checks in order:

### 1. Test Coverage Check

**Command to run:**
```bash
cd packages/contracts && pnpm test
```

**Requirements:**
- **Testnet (Base Sepolia):** >= 80% pass rate acceptable
- **Mainnet:** 100% tests must pass
- **Review:** Check `TEST_FIXES_SUMMARY.md` for known issues

**Red flags:**
- Test pass rate < 80%
- Critical test failures in core contracts
- Skipped tests without justification

### 2. Security Audit Status

**Mainnet requirements (BLOCKING):**
- External security audit REQUIRED
- No critical or high severity issues unresolved
- All medium severity issues addressed or accepted with documentation

**Testnet requirements:**
- Internal security review acceptable
- No obvious vulnerabilities in access control
- Reentrancy protection verified

**Check for:**
```bash
grep -r "TODO\|FIXME\|HACK\|XXX" packages/contracts/src/
```
- Expected result: Zero matches in production code

### 3. Deployment Validation

**Files to check:**
- `deployments/{chainId}-latest.json` - must exist for target network
- All contract addresses must be non-zero
- All schema UIDs must be present and non-zero

**Command to verify:**
```bash
cat packages/contracts/deployments/84532-latest.json | jq
```

**Required fields:**
- deploymentRegistry
- gardenToken
- actionRegistry
- workResolver
- workApprovalResolver
- assessmentResolver
- schemas.assessmentSchemaUID
- schemas.workSchemaUID
- schemas.workApprovalSchemaUID

### 4. Network Configuration

**Command to run:**
```bash
cd packages/contracts && pnpm network:verify
```

**Verifies:**
- RPC connectivity to target network
- Chain ID matches configuration
- EAS contracts present
- Environment variables set

**Required env vars:**
- `BASE_SEPOLIA_RPC_URL` (for Base Sepolia)
- `FOUNDRY_KEYSTORE_ACCOUNT`
- `ETHERSCAN_API_KEY` (optional but recommended)

### 5. Gas Analysis

**Command to run:**
```bash
cd packages/contracts && forge test --gas-report
```

**Target benchmarks:**
- mintGarden: < 500,000 gas
- registerAction: < 200,000 gas
- Work submission: < 150,000 gas
- Work approval: < 100,000 gas

**Red flags:**
- Any function exceeding block gas limit (30M)
- Significant gas regression from previous version

### 6. Build and Compilation

**Command to run:**
```bash
cd packages/contracts && pnpm build
```

**Requirements:**
- Clean compilation with no errors
- No warnings (acceptable: minor optimizer warnings)
- Uses Solidity 0.8.25
- `via_ir` optimization enabled

## Production Deployment Workflow

### For Base Sepolia (Testnet)

**Pre-flight checks:**
```bash
cd packages/contracts
pnpm test                    # All tests pass
pnpm network:verify          # Network config valid
pnpm deploy:dryrun          # Simulation successful
```

**Deployment:**
```bash
pnpm deploy:testnet
```

**Post-deployment verification:**
```bash
# Check contract ownership
cast call $GARDEN_TOKEN "owner()" --rpc-url $BASE_SEPOLIA_RPC_URL

# Verify contract on explorer
forge verify-contract --chain-id 84532 $CONTRACT_ADDRESS src/Contract.sol:Contract
```

**Acceptance criteria:**
- All contracts deployed successfully
- All contracts verified on Basescan
- Basic operations tested (mint, register, submit, approve)
- No errors in 24-hour monitoring period

### For Mainnet

**Additional requirements (BLOCKING):**
- External security audit completed
- All audit findings resolved or accepted
- Multisig ownership configured
- Comprehensive testing on testnet (minimum 2 weeks)
- Incident response plan documented
- Rollback procedures tested

**Deployment:**
```bash
# Only after ALL mainnet requirements met
pnpm deploy:base  # or deploy:celo, deploy:arbitrum
```

## Red Flags (BLOCK DEPLOYMENT)

These issues MUST be resolved before deployment:

1. **Test pass rate < 80%**
   - Action: Fix failing tests or document why they're acceptable

2. **Compiler errors or warnings**
   - Action: Resolve all errors, review warnings

3. **Missing schema UIDs in deployment file**
   - Action: Redeploy schemas or update deployment file

4. **RPC connectivity failure**
   - Action: Fix RPC endpoint, check network status

5. **Insufficient deployer balance**
   - Action: Fund deployer wallet (minimum 0.1 ETH for testnet)

6. **No security audit (mainnet only)**
   - Action: Complete external audit before mainnet deployment

7. **Unresolved critical/high severity findings**
   - Action: Fix all critical and high severity issues

8. **Storage layout conflicts in upgrades**
   - Action: Fix storage gaps, review upgrade safety

## Green Lights (READY TO DEPLOY)

All these conditions must be true:

- ✅ All tests passing (or >= 80% for testnet)
- ✅ Gas optimized and within limits
- ✅ Network config verified
- ✅ Deployer wallet funded
- ✅ Documentation complete
- ✅ Rollback plan documented
- ✅ No red flags present
- ✅ Security review completed (external for mainnet, internal for testnet)

## Assessment Template

When asked "Are contracts ready for production?", respond with:

```markdown
# Production Readiness Assessment for [Network]

## Test Coverage
- Tests passing: X/Y (Z%)
- Status: ✅ Ready / ⚠️ Warning / ❌ Not Ready
- Notes: [any issues]

## Security Audit
- Status: [Completed/In Progress/Not Started]
- Findings: [Critical: X, High: Y, Medium: Z]
- Status: ✅ Ready / ⚠️ Warning / ❌ Not Ready

## Deployment Validation
- Deployment file exists: [Yes/No]
- All addresses present: [Yes/No]
- Schema UIDs present: [Yes/No]
- Status: ✅ Ready / ⚠️ Warning / ❌ Not Ready

## Network Configuration
- RPC connectivity: [Yes/No]
- Chain ID correct: [Yes/No]
- EAS contracts verified: [Yes/No]
- Status: ✅ Ready / ⚠️ Warning / ❌ Not Ready

## Gas Analysis
- Gas report generated: [Yes/No]
- All functions within limits: [Yes/No]
- Status: ✅ Ready / ⚠️ Warning / ❌ Not Ready

## Overall Assessment
**Verdict:** ✅ READY / ⚠️ READY WITH CAVEATS / ❌ NOT READY

**Recommendation:** [Deploy/Fix issues/Complete audit/etc.]

**Next Steps:**
1. [Step 1]
2. [Step 2]
3. [Step 3]
```

## Reference Files

- **Production checklist:** `/docs/PRODUCTION_READINESS.md`
- **Test summary:** `/packages/contracts/TEST_FIXES_SUMMARY.md`
- **Deployment guide:** `/docs/DEPLOYMENT.md`
- **Upgrade guide:** `/docs/UPGRADES.md`
- **Network config:** `/packages/contracts/deployments/networks.json`
- **Test files:** `/packages/contracts/test/`

## Testing Protocol

### Unit Tests
Location: `packages/contracts/test/`

Key test suites:
- `ActionRegistry.t.sol` - 8 tests for action management
- `GardenToken.t.sol` - Token minting and management
- `GardenAccount.t.sol` - 47 tests for garden accounts
- `DeploymentRegistry.t.sol` - 13 tests for registry
- `WorkResolver.t.sol` - Work submission validation
- `WorkApprovalResolver.t.sol` - Approval validation
- `AssessmentResolver.t.sol` - Assessment validation

### Integration Tests
- `Integration.t.sol` - Multi-contract workflows
- `E2EWorkflow.t.sol` - End-to-end protocol tests
- `UpgradeSafety.t.sol` - UUPS upgrade testing

### Expected Pass Rate
- **Current:** 65% (26/40 tests)
- **Target for testnet:** 80%
- **Target for mainnet:** 100%

## Common Issues and Solutions

### Issue: "DeploymentTest failing"
**Cause:** Requires actual deployment files
**Solution:** Run `pnpm deploy:local` first or mock file operations

### Issue: "Resolver tests commented out"
**Cause:** Tests need EAS integration
**Solution:** Use E2EWorkflow.t.sol for comprehensive testing instead

### Issue: "Gas limit exceeded"
**Cause:** Complex operations or inefficient code
**Solution:** Review gas report, optimize code, use batch operations

### Issue: "RPC timeout"
**Cause:** Network congestion or rate limiting
**Solution:** Use alternative RPC or add retry logic

## Version History

- **v1.0 (2025-10-09):** Initial production readiness rules
- Current test coverage: 65% (26/40 tests)
- E2E tests: 7 comprehensive workflows
- Upgrade tests: 7 UUPS safety tests

## Notes for AI Agents

1. **Always be conservative:** When in doubt, recommend more testing
2. **Mainnet is critical:** Never recommend mainnet deployment without external audit
3. **Document assumptions:** If checks can't be run, state assumptions clearly
4. **Provide actionable steps:** Always include specific commands and next steps
5. **Reference this file:** When assessing readiness, cite specific sections of this file
6. **Check recent changes:** Review git history for recent contract changes
7. **Consider context:** Testnet deployments have lower requirements than mainnet

## Emergency Contacts

When critical issues are found:
1. Document the issue clearly
2. Assess severity (Critical/High/Medium/Low)
3. Recommend immediate actions
4. Reference rollback procedures in `/docs/PRODUCTION_READINESS.md`
5. Suggest monitoring approach

## Continuous Improvement

This file should be updated when:
- New test suites are added
- Security audit is completed
- Gas benchmarks change
- New deployment targets are added
- Production incidents occur

Last updated: 2025-10-09

