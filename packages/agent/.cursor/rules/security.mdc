---
description: Agent security patterns — encryption, rate limiting, input validation
globs:
  - src/services/crypto.ts
  - src/services/rate-limiter.ts
alwaysApply: false
---

# Agent Security Patterns

Security best practices for the Green Goods agent.

## Threat Model

| Vector | Mitigation | Status |
|--------|------------|--------|
| Key compromise | AES-256-GCM encryption | ✅ |
| DoS/spam | Sliding window rate limiting | ✅ |
| Injection | Input validation | ✅ |
| MITM | TLS + webhook verification | ✅ |

## Private Key Encryption

**Never store plaintext keys.**

```typescript
import { prepareKeyForStorage, getPrivateKey } from './services/crypto';

// Encrypt before storage
const encrypted = prepareKeyForStorage(privateKey);

// Decrypt for use
const { privateKey } = getPrivateKey(user.privateKey);
```

**Algorithm:** AES-256-GCM with PBKDF2 (100k iterations)
**Format:** `{salt}:{iv}:{ciphertext+tag}`

**Secret requirements:**
- 32+ characters
- Generate: `openssl rand -base64 48`
- Store in `ENCRYPTION_SECRET` env var

## Rate Limiting

```typescript
import { rateLimiter } from './services/rate-limiter';

const result = rateLimiter.check(userId, 'submission');
if (!result.allowed) {
  return textResponse(`Rate limit: ${result.message}`);
}
```

**Limits:**

| Action | Limit | Window |
|--------|-------|--------|
| messages | 10 | 1 min |
| voice | 3 | 1 min |
| submissions | 5 | 5 min |
| commands | 20 | 1 min |
| approvals | 30 | 1 min |

## Input Validation

**Always validate addresses:**

```typescript
import { isValidAddress } from './services/crypto';

if (!isValidAddress(address)) {
  return { response: { text: 'Invalid address' } };
}
```

**Validation:**
- Starts with `0x`
- 42 chars (0x + 40 hex)
- Valid hex characters

## Webhook Security

**Production must verify signatures:**

```typescript
const signature = request.headers['x-telegram-bot-api-secret-token'];
if (signature !== process.env.TELEGRAM_WEBHOOK_SECRET) {
  return reply.code(403).send({ error: 'Invalid signature' });
}
```

**Requirements:**
- HTTPS only (no HTTP webhooks)
- Set `TELEGRAM_WEBHOOK_SECRET`
- Verify on every request

## Error Handling

**Never expose sensitive data:**

```typescript
// ✅ Correct - generic message
catch (error) {
  console.error('Decrypt error:', error);
  return { response: { text: 'Request failed. Please try again.' } };
}

// ❌ Wrong - leaks details
catch (error) {
  return { response: { text: `Error: ${error.message}` } };
}
```

## Checklist

### Development
- [ ] No hardcoded secrets
- [ ] All input validated
- [ ] Keys encrypted
- [ ] Rate limits on all handlers
- [ ] Safe error messages

### Deployment
- [ ] `ENCRYPTION_SECRET` 32+ chars
- [ ] `TELEGRAM_WEBHOOK_SECRET` set
- [ ] TLS enabled
- [ ] Webhook verification enabled
