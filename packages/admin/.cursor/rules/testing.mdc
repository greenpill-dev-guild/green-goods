---
description: Admin-specific testing patterns
globs:
  - "packages/admin/src/__tests__/**"
alwaysApply: false
---

# Admin Testing

Admin-specific test patterns. Common patterns are in `shared/.cursor/rules/testing-patterns.mdc`.

## Test Structure

```
src/__tests__/
├── components/      # Component unit tests
├── views/           # View tests
├── routes/          # Route guard tests
├── integration/     # Multi-component flows
├── workflows/       # XState workflow tests
├── utils/           # Test utilities
└── setup.ts
```

## Coverage Targets

| Area | Target |
|------|--------|
| **Access control** | 100% |
| **Critical paths** | 70%+ |
| **Overall** | 70%+ |

## Role-Based Testing

```typescript
import { renderWithProviders } from "./utils/renderWithProviders";

describe("Gardens View", () => {
  it("shows all gardens for deployer", async () => {
    const { screen } = renderWithProviders(<Gardens />, {
      userRole: "deployer",
    });
    
    await waitFor(() => {
      expect(screen.getByText("All Gardens")).toBeInTheDocument();
    });
  });

  it("shows only assigned gardens for operator", async () => {
    const { screen } = renderWithProviders(<Gardens />, {
      userRole: "operator",
      operatorGardens: ["garden-1"],
    });
    
    await waitFor(() => {
      expect(screen.queryByText("Garden 2")).not.toBeInTheDocument();
    });
  });
});
```

## Route Guard Testing

```typescript
describe("RequireDeployer", () => {
  it("allows deployer access", () => {
    const { screen } = renderWithProviders(
      <RequireDeployer><Protected /></RequireDeployer>,
      { userRole: "deployer" }
    );
    
    expect(screen.getByText("Protected Content")).toBeInTheDocument();
  });

  it("redirects operator", () => {
    const { history } = renderWithProviders(
      <RequireDeployer><Protected /></RequireDeployer>,
      { userRole: "operator" }
    );
    
    expect(history.location.pathname).toBe("/gardens");
  });
});
```

## Workflow Testing

```typescript
import { createGardenMachine } from "@green-goods/shared";
import { createActor } from "xstate";

describe("Garden Creation Workflow", () => {
  it("progresses through steps", () => {
    const actor = createActor(createGardenMachine);
    actor.start();

    actor.send({ type: "NEXT" });
    expect(actor.getSnapshot().value).toBe("step2");

    actor.send({ type: "SUBMIT", data: formData });
    expect(actor.getSnapshot().value).toBe("submitting");
  });
});
```

## Transaction Testing

```typescript
describe("Garden Operations", () => {
  it("adds gardener with toast feedback", async () => {
    const user = userEvent.setup();
    const { screen } = renderWithProviders(<GardenDetail />);

    await user.click(screen.getByText("Add Gardener"));
    await user.type(screen.getByLabelText("Address"), "0x123...");
    await user.click(screen.getByText("Add"));

    await waitFor(() => {
      expect(mockWriteContract).toHaveBeenCalled();
      expect(screen.getByText("Gardener added")).toBeInTheDocument();
    });
  });
});
```

## Mock Utilities

```typescript
// __tests__/utils/mockAuth.ts
export function createMockAuth(role: "deployer" | "operator" | "user") {
  return {
    authMode: "wallet",
    isAuthenticated: true,
    isReady: true,
    eoaAddress: "0x123...",
    role,
    isDeployer: role === "deployer",
    isOperator: role === "operator",
  };
}
```

## Test Providers

```typescript
// __tests__/utils/renderWithProviders.tsx
export function renderWithProviders(
  ui: React.ReactElement,
  { userRole = "deployer", operatorGardens = [] } = {}
) {
  const queryClient = new QueryClient({
    defaultOptions: { queries: { retry: false } },
  });

  return render(
    <QueryClientProvider client={queryClient}>
      <AuthContext.Provider value={createMockAuth(userRole)}>
        <RoleContext.Provider value={{ role: userRole, operatorGardens }}>
          <MemoryRouter>{ui}</MemoryRouter>
        </RoleContext.Provider>
      </AuthContext.Provider>
    </QueryClientProvider>
  );
}
```

## Integration Tests

```typescript
describe("Garden Management Flow", () => {
  it("admin creates garden and adds members", async () => {
    const user = userEvent.setup();
    const { screen } = renderWithProviders(<App />, { userRole: "deployer" });

    // Create garden
    await user.click(screen.getByText("Create Garden"));
    await user.type(screen.getByLabelText("Name"), "Test Garden");
    await user.click(screen.getByText("Create"));

    // Add gardener
    await user.click(screen.getByText("Add Gardener"));
    await user.type(screen.getByLabelText("Address"), "0x...");
    await user.click(screen.getByText("Add"));

    expect(screen.getByText("Test Garden")).toBeInTheDocument();
  });
});
```

## Reference

- Common patterns: `shared/.cursor/rules/testing-patterns.mdc`
- Test setup: `src/__tests__/setup.ts`
- Mock utilities: `src/__tests__/utils/`
