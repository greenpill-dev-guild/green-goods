---
description: Reown AppKit integration — wallet connection, configuration, fallback auth
globs:
  - "**/appkit*.ts"
  - "**/AppKitProvider.tsx"
alwaysApply: false
---

# AppKit Integration

Reown AppKit provides wallet connection UI for Green Goods. It serves as the fallback authentication method for operators and admins.

## Architecture

```
Passkey (Primary)     Wallet (Fallback)
      │                     │
      └──────┬──────────────┘
             │
      ┌──────┴──────┐
      │ AuthProvider │
      └──────┬──────┘
             │
      ┌──────┴──────┐
      │ AppKitProvider │
      └──────┬──────┘
             │
      ┌──────┴──────┐
      │ WagmiProvider │
      └─────────────┘
```

## Singleton Configuration

AppKit uses a singleton pattern. Configuration happens once at app startup:

```typescript
// packages/shared/src/config/appkit.ts
import { ensureAppKit } from "@green-goods/shared";

const { appKit, wagmiConfig } = ensureAppKit({
  projectId: import.meta.env.VITE_WALLETCONNECT_PROJECT_ID,
  metadata: {
    name: "Green Goods",
    description: "Start Bringing Your Impact Onchain",
    url: "https://www.greengoods.app",
    icons: ["https://www.greengoods.app/icon.png"],
  },
  defaultChainId: 84532, // Base Sepolia
});
```

**Key points:**
- `ensureAppKit()` is idempotent — safe to call multiple times
- WagmiConfig is generated by the WagmiAdapter
- Network switching is disabled (single chain per environment)

## Provider Setup

### Client App

```tsx
// packages/client/src/main.tsx
import { AppKitProvider, AuthProvider } from "@green-goods/shared";
import { QueryClient, QueryClientProvider } from "@tanstack/react-query";

const queryClient = new QueryClient();

function App() {
  return (
    <AppKitProvider
      projectId={import.meta.env.VITE_WALLETCONNECT_PROJECT_ID}
      metadata={{
        name: "Green Goods",
        description: "Start Bringing Your Impact Onchain",
        url: window.location.origin,
        icons: ["/icon.png"],
      }}
    >
      <QueryClientProvider client={queryClient}>
        <AuthProvider>
          {/* App content */}
        </AuthProvider>
      </QueryClientProvider>
    </AppKitProvider>
  );
}
```

### Admin App

```tsx
// packages/admin/src/main.tsx
import { AppKitProvider, AuthProvider } from "@green-goods/shared";

function AdminApp() {
  return (
    <AppKitProvider
      projectId={import.meta.env.VITE_WALLETCONNECT_PROJECT_ID}
      metadata={{
        name: "Green Goods Admin",
        description: "Garden Management Dashboard",
        url: window.location.origin,
        icons: ["/icon.png"],
      }}
    >
      <QueryClientProvider client={queryClient}>
        <AuthProvider>
          {/* Admin content */}
        </AuthProvider>
      </QueryClientProvider>
    </AppKitProvider>
  );
}
```

## Using AppKit Modal

```typescript
import { useAppKit } from "@green-goods/shared";

function WalletButton() {
  const { open } = useAppKit();

  return (
    <button onClick={() => open()}>
      Connect Wallet
    </button>
  );
}
```

## Chain Configuration

AppKit respects the environment chain:

```typescript
// Configured via environment variable
VITE_CHAIN_ID=84532  // Base Sepolia

// Never switch chains in-app
enableNetworkSwitch: false,
defaultNetwork: getChain(DEFAULT_CHAIN_ID),
```

**Supported chains:**
- Base Sepolia (84532) — Default for development
- Arbitrum One (42161) — Production
- Celo (42220) — Production

## Theme Customization

Green Goods brand colors are applied:

```typescript
themeVariables: {
  "--w3m-accent": "#367D42",           // Primary green
  "--w3m-border-radius-master": "12px", // Rounded corners
},
```

## Auth Mode Integration

AppKit provides wallet auth as fallback to passkeys:

```typescript
import { useAuth } from "@green-goods/shared";

function AuthButtons() {
  const { authMode, signOut } = useAuth();
  const { open } = useAppKit();

  if (authMode === "passkey") {
    return <button onClick={signOut}>Sign Out (Passkey)</button>;
  }

  if (authMode === "wallet") {
    return <button onClick={() => open()}>Wallet Connected</button>;
  }

  return (
    <div>
      <button onClick={createPasskey}>Create Passkey</button>
      <button onClick={() => open()}>Connect Wallet</button>
    </div>
  );
}
```

## Environment Variables

```bash
# Required for wallet connection
VITE_WALLETCONNECT_PROJECT_ID=your_project_id

# Get from https://cloud.reown.com
```

## Error Handling

```typescript
// Handle missing project ID gracefully
if (!projectId) {
  console.warn("[AppKit] VITE_WALLETCONNECT_PROJECT_ID not set. Wallet login will not work.");
}
```

## Anti-Patterns

### Never Create Multiple Instances

```typescript
// ❌ Wrong — creates duplicate instances
const appKit1 = createAppKit({ ... });
const appKit2 = createAppKit({ ... });

// ✅ Correct — use singleton
const { appKit } = ensureAppKit();
```

### Never Use Wallet Chain ID for Data

```typescript
// ❌ Wrong — wallet chain can differ
const { chainId } = useAccount();
const { data } = useWorks(gardenId, chainId);

// ✅ Correct — use environment chain
import { DEFAULT_CHAIN_ID } from "@green-goods/shared";
const { data } = useWorks(gardenId, DEFAULT_CHAIN_ID);
```

### Never Skip Provider Nesting

```typescript
// ❌ Wrong — AuthProvider needs AppKitProvider
<AuthProvider>
  <AppKitProvider>
    ...

// ✅ Correct — proper nesting
<AppKitProvider>
  <AuthProvider>
    ...
```

## Passkey Fallback Pattern

When passkey fails, offer wallet:

```typescript
async function handlePasskeyAuth() {
  try {
    await authenticatePasskey();
  } catch (error) {
    if (error.name === "NotAllowedError") {
      // User cancelled — offer wallet
      toast.info("Try connecting a wallet instead");
      open(); // Open AppKit modal
    }
  }
}
```

## Reference Files

- AppKit config: `packages/shared/src/config/appkit.ts`
- AppKit provider: `packages/shared/src/providers/AppKitProvider.tsx`
- Auth provider: `packages/shared/src/providers/Auth.tsx`
- Chain config: `packages/shared/src/config/chains.ts`
