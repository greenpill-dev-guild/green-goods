---
description: Shared package — common code for client and admin apps
globs:
  - "packages/shared/src/**/*"
alwaysApply: false
---

# Shared Package

Central code repository consumed by client and admin apps.

## What Lives Here

| Category | Location | Purpose |
|----------|----------|---------|
| **Hooks** | `src/hooks/` | All custom React hooks |
| **Providers** | `src/providers/` | Auth, JobQueue, Work, App |
| **Stores** | `src/stores/` | Zustand state management |
| **Modules** | `src/modules/` | Core business logic |
| **Workflows** | `src/workflows/` | XState machines |
| **Utils** | `src/utils/` | Utility functions |
| **Types** | `src/types/` | TypeScript definitions |
| **Config** | `src/config/` | App, chains, pimlico |
| **i18n** | `src/i18n/` | Translations (en, es, pt) |
| **Components** | `src/components/` | Toast, Spinner, StatusBadge |

## Critical Patterns

### TypeScript Strictness

**Never use `any` — use `unknown` for untrusted data:**

```typescript
// ✅ Forces type narrowing
function processApiResponse(data: unknown): Garden | null {
  if (isGarden(data)) return data;
  return null;
}

// ❌ Disables type safety
function processApiResponse(data: any): Garden {
  return data;  // No validation!
}
```

**Use discriminated unions for state:**

```typescript
// ✅ Type-safe state handling
type JobState =
  | { status: 'pending' }
  | { status: 'processing'; progress: number }
  | { status: 'completed'; result: Work }
  | { status: 'failed'; error: string };

// ❌ Stringly typed (error-prone)
type JobState = { status: string; data?: any };
```

**Use `as const` for literal types:**

```typescript
// ✅ Literal types preserved
export const JOB_TYPES = {
  SUBMIT_WORK: 'SUBMIT_WORK',
  APPROVE_WORK: 'APPROVE_WORK',
} as const;

type JobType = typeof JOB_TYPES[keyof typeof JOB_TYPES];
```

### Async Safety with AbortSignal

```typescript
// ✅ Cancellable queries
export function useWorks(gardenId: string, chainId: number) {
  return useQuery({
    queryKey: queryKeys.works.merged(gardenId, chainId),
    queryFn: ({ signal }) => fetchWorks(gardenId, chainId, signal),
  });
}

// ❌ Fire-and-forget (stale closures, memory leaks)
export function useWorks(gardenId: string, chainId: number) {
  return useQuery({
    queryFn: () => fetchWorks(gardenId, chainId),  // Can't cancel!
  });
}
```

### Explicit Exports Only

```typescript
// ✅ Correct
export { useAuth } from "./auth/useAuth";
export type { Garden } from "./types";

// ❌ Wrong — no wildcard exports
export * from "./auth";
```

### Import from Package Root

```typescript
// ✅ From client/admin
import { useAuth, useWorks } from '@green-goods/shared';
import type { Garden, Work } from '@green-goods/shared';

// ❌ Wrong — deep imports
import { useAuth } from '@green-goods/shared/src/hooks/auth/useAuth';
```

### Chain from Environment Only

```typescript
// ✅ Correct
import { DEFAULT_CHAIN_ID, useCurrentChain } from '@green-goods/shared';

// ❌ Wrong — never use wallet chain
const { chainId } = useAccount();
```

### Event-Driven Updates

```typescript
// ✅ Correct — react to events
useJobQueueEvents(['job:completed'], () => {
  queryClient.invalidateQueries({ queryKey: queryKeys.works.merged(gardenId, chainId) });
});

// ❌ Wrong — no polling
setInterval(() => refetch(), 5000);
```

### Centralized Query Keys

```typescript
import { queryKeys, queryInvalidation } from '@green-goods/shared';

// ✅ Correct — use centralized keys
queryClient.invalidateQueries({ queryKey: queryKeys.works.merged(gardenId, chainId) });

// ❌ Wrong — ad-hoc keys
queryClient.invalidateQueries({ queryKey: ['works', gardenId] });
```

### Internationalization (i18n) — **MANDATORY**

**CRITICAL:** Any new user-facing strings MUST be added to ALL THREE language files simultaneously.

Supported languages:
- English (en.json)
- Spanish (es.json)
- Portuguese (pt.json)

**Process:**
1. Add key to `src/i18n/en.json` with English text
2. Add same key to `src/i18n/es.json` with Spanish translation
3. Add same key to `src/i18n/pt.json` with Portuguese translation

```typescript
// ✅ Correct — use intl.formatMessage with i18n key
intl.formatMessage({
  id: "app.update.title",
  defaultMessage: "Refresh app"  // Fallback if key missing
})

// ❌ Wrong — hardcoded strings
<button>Refresh app</button>
```

**i18n Files:**
```json
// en.json
{
  "app.update.title": "Refresh app",
  "app.update.subtitle": "Use this if things look weird after an update."
}

// es.json
{
  "app.update.title": "Actualizar app",
  "app.update.subtitle": "Usa esto si algo se ve raro después de una actualización."
}

// pt.json
{
  "app.update.title": "Atualizar app",
  "app.update.subtitle": "Use se algo parecer estranho após uma atualização."
}
```

**Pre-commit checklist:**
- [ ] Added key to en.json
- [ ] Added key to es.json
- [ ] Added key to pt.json
- [ ] Verified JSON syntax (no trailing commas, valid escaping)
- [ ] Used semantic key naming (e.g., `app.feature.action`)

## Provider Hierarchy

Required nesting order:

```tsx
<WagmiProvider>
  <AppKitProvider>
    <AuthProvider>
      <AppProvider>
        <QueryClientProvider>
          <JobQueueProvider>
            <WorkProvider>
              {children}
            </WorkProvider>
          </JobQueueProvider>
        </QueryClientProvider>
      </AppProvider>
    </AuthProvider>
  </AppKitProvider>
</WagmiProvider>
```

## Deep Dive Rules

| Topic | Rule File |
|-------|-----------|
| Design System | `.cursor/rules/design-system.mdc` |
| Hook Architecture | `.cursor/rules/hook-architecture.mdc` |
| State Patterns | `.cursor/rules/state-patterns.mdc` |
| Testing | `.cursor/rules/testing-patterns.mdc` |
| AppKit | `.cursor/rules/appkit-integration.mdc` |
| Imports | `.cursor/rules/cross-package-imports.mdc` |

## Reference

- **AGENTS.md:** `/packages/shared/AGENTS.md`
- **Client:** `/packages/client/AGENTS.md`
- **Admin:** `/packages/admin/AGENTS.md`
