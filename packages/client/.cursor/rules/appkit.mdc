---
description: Reown AppKit integration patterns for Green Goods client
globs:
  - "**/*.{ts,tsx}"
alwaysApply: false
---

# Reown AppKit: Configuration & Usage

**Reown AppKit** provides wallet connection UI for Green Goods. It's used as a **fallback** authentication method for operators/admins who prefer traditional wallet connections over passkeys.

## Tech Stack

- **Primary Auth**: WebAuthn passkeys + Pimlico smart accounts (for gardeners)
- **Fallback Auth**: AppKit + Wagmi + EOA wallets (for operators)
- **UI Framework**: Vite + React (SPA, not Next.js)

---

## Critical Rules

### 1. Single Source of Truth for Wagmi Config

**ALWAYS** use the Wagmi config generated by `WagmiAdapter`:

```typescript
// ✅ CORRECT: Use AppKit's generated config
import { wagmiConfig } from "@/config/appkit";

<WagmiProvider config={wagmiConfig}>
  {children}
</WagmiProvider>
```

```typescript
// ❌ WRONG: Creating separate config causes connection state mismatches
import { createConfig } from "wagmi";
const wagmiConfig = createConfig({...}); // Don't do this!
```

**Why**: AppKit needs to share the same Wagmi instance with the rest of your app. Separate configs cause wallet connection states to be out of sync.

### 2. AppKit Initialization

Initialize AppKit **once** at the module level using a singleton pattern:

```typescript
// config/appkit.ts
let appKitInstance: ReturnType<typeof createAppKit> | null = null;

export const appKit =
  appKitInstance ||
  (appKitInstance = createAppKit({
    adapters: [wagmiAdapter],
    networks,
    projectId: projectId || "",
    metadata,
    features: { analytics: false },
    themeMode: "light",
    themeVariables: {
      "--w3m-accent": "#367D42",
      "--w3m-border-radius-master": "12px",
    },
  }));
```

**Why**: Prevents "WalletConnect Core is already initialized" warnings.

### 3. Use Wagmi Hooks, Not AppKit Hooks

For **Vite/React SPAs**, use Wagmi's native hooks:

```typescript
// ✅ CORRECT: Use wagmi hooks
import { useAccount } from "wagmi";
import { appKit } from "@/config/appkit";

function MyComponent() {
  const { address, isConnected } = useAccount();
  
  const handleOpenModal = () => {
    appKit.open(); // Trigger modal directly
  };
}
```

```typescript
// ❌ WRONG: AppKit React hooks cause "Cannot read properties of null" errors in SPAs
import { useAppKit, useAppKitAccount } from "@reown/appkit/react";

function MyComponent() {
  const { open } = useAppKit(); // ❌ Fails without proper context setup
  const { address } = useAppKitAccount(); // ❌ Fails in SPAs
}
```

**Why**: AppKit's React hooks require a specific provider setup that's designed for Next.js SSR. In SPAs, use Wagmi hooks which already work in our provider hierarchy.

### 4. Dynamic Metadata URL

Use dynamic URLs to avoid localhost/production mismatches:

```typescript
const metadata = {
  name: "Green Goods",
  description: "Start Bringing Biodiversity Onchain",
  url: import.meta.env.VITE_APP_URL || window.location.origin, // ✅ Dynamic
  icons: ["https://greengoods.app/icon.png"],
};
```

**Environment Variable**:
```bash
# .env
VITE_APP_URL="http://localhost:3001"  # Dev
# VITE_APP_URL="https://greengoods.app"  # Production
```

---

## Implementation Patterns

### Proper Config Structure

```typescript
// config/appkit.ts
import { createAppKit } from "@reown/appkit/react";
import { WagmiAdapter } from "@reown/appkit-adapter-wagmi";
import { baseSepolia, celo, arbitrum, type Chain } from "viem/chains";

const projectId = import.meta.env.VITE_WALLETCONNECT_PROJECT_ID;

if (!projectId) {
  console.warn("[AppKit] VITE_WALLETCONNECT_PROJECT_ID not set.");
}

const metadata = {
  name: "Green Goods",
  description: "Start Bringing Biodiversity Onchain",
  url: import.meta.env.VITE_APP_URL || window.location.origin,
  icons: ["https://greengoods.app/icon.png"],
};

// Define networks as non-empty array
export const networks: [Chain, ...Chain[]] = [baseSepolia, celo, arbitrum];

// Create WagmiAdapter
export const wagmiAdapter = new WagmiAdapter({
  networks,
  projectId: projectId || "",
});

// Export wagmiConfig generated by adapter
export const wagmiConfig = wagmiAdapter.wagmiConfig;

// Initialize AppKit (singleton)
let appKitInstance: ReturnType<typeof createAppKit> | null = null;

export const appKit =
  appKitInstance ||
  (appKitInstance = createAppKit({
    adapters: [wagmiAdapter],
    networks,
    projectId: projectId || "",
    metadata,
    features: { analytics: false },
    themeMode: "light",
    themeVariables: {
      "--w3m-accent": "#367D42", // Green Goods primary
      "--w3m-border-radius-master": "12px",
    },
  }));
```

### Provider Setup (SPA)

```typescript
// main.tsx
import { WagmiProvider } from "wagmi";
import { wagmiConfig } from "@/config/appkit"; // Import from appkit
import "@/config/appkit"; // Initialize AppKit

export const Root = () => (
  <WagmiProvider config={wagmiConfig}>
    <QueryClientProvider client={queryClient}>
      <AuthProvider>
        <App />
      </AuthProvider>
    </QueryClientProvider>
  </WagmiProvider>
);
```

**Note**: No need for:
- `cookieStorage` (client-only app)
- `ssr: true` (not using SSR)
- `PermissionlessProvider` (handled separately via AuthProvider)

### Opening Wallet Modal

```typescript
// views/Login/index.tsx
import { useAccount } from "wagmi";
import { appKit } from "@/config/appkit";

export function Login() {
  const { address, isConnected } = useAccount(); // ✅ Wagmi hook
  
  const handleWalletLogin = () => {
    appKit.open(); // ✅ Direct modal trigger
  };
  
  return (
    <button onClick={handleWalletLogin}>
      Login with wallet
    </button>
  );
}
```

### Syncing AppKit Connection to Auth Provider

```typescript
// Watch Wagmi connection and sync to custom auth provider
useEffect(() => {
  if (isConnected && address && !walletAddress) {
    const connector = getAccount(wagmiConfig).connector;
    if (connector) {
      connectWallet(connector).catch(console.error);
    }
  }
}, [isConnected, address, walletAddress, connectWallet]);
```

---

## Integration with Pimlico Smart Accounts

Green Goods uses **passkey-first authentication** with Pimlico. AppKit is the **secondary** option.

### Dual Provider Pattern

```typescript
// providers/auth.tsx
export type AuthMode = "passkey" | "wallet" | null;

interface AuthContextType {
  authMode: AuthMode;
  
  // Passkey state (Pimlico smart accounts)
  credential: P256Credential | null;
  smartAccountAddress: Hex | null;
  smartAccountClient: SmartAccountClient | null;
  
  // Wallet state (AppKit EOA)
  walletAddress: Hex | null;
  walletConnector: Connector | null;
  
  // Actions
  createPasskey: () => Promise<void>;
  connectWallet: (connector: Connector) => Promise<void>;
}
```

### When to Use Which

| Use Case | Authentication Method | Tool |
|----------|----------------------|------|
| Gardeners (mobile users) | Passkey (WebAuthn) | Pimlico smart accounts |
| Operators (desktop admins) | Wallet (EOA) | AppKit + Wagmi |
| First-time users | Passkey (default) | Biometric prompt |
| Power users | Wallet (optional) | MetaMask/WalletConnect |

---

## Troubleshooting

### Issue: "Cannot read properties of null (reading 'useMemo')"

**Cause**: Using AppKit React hooks (`useAppKit`, `useAppKitAccount`) in a SPA without proper context.

**Solution**: Use Wagmi hooks instead:
```typescript
// ❌ Remove
import { useAppKit, useAppKitAccount } from "@reown/appkit/react";

// ✅ Replace with
import { useAccount } from "wagmi";
import { appKit } from "@/config/appkit";
```

### Issue: "WalletConnect Core is already initialized"

**Cause**: AppKit being initialized multiple times due to module re-imports.

**Solution**: Use singleton pattern (already implemented in config).

### Issue: "Metadata URL differs from actual page URL"

**Cause**: Hardcoded production URL conflicts with localhost.

**Solution**: Use dynamic URL with environment variable (already implemented).

### Issue: Connection state mismatch between AppKit and app

**Cause**: Using separate Wagmi configs.

**Solution**: Import `wagmiConfig` from `@/config/appkit`, not from a separate config file.

---

## Environment Variables

Required in `.env`:

```bash
# WalletConnect Project ID (get from https://cloud.reown.com/)
VITE_WALLETCONNECT_PROJECT_ID="your-project-id"

# App URL (prevents metadata mismatch warnings)
VITE_APP_URL="http://localhost:3001"  # Dev
# VITE_APP_URL="https://greengoods.app"  # Production

# Pimlico API Key (for passkey smart accounts)
VITE_PIMLICO_API_KEY="your-pimlico-key"
```

---

## Differences from Next.js Setup

Green Goods uses **Vite/React (SPA)**, not Next.js. Key differences:

| Feature | Next.js (Official Docs) | Green Goods (Vite SPA) |
|---------|------------------------|------------------------|
| Env vars | `process.env.NEXT_PUBLIC_*` | `import.meta.env.VITE_*` |
| Storage | `cookieStorage` for SSR | Not needed (client-only) |
| SSR flag | `ssr: true` | Not needed |
| React hooks | `useAppKit`, `useAppKitAccount` | Use Wagmi hooks instead |
| Context | `ContextProvider` with cookies | Standard WagmiProvider |
| Hydration | `cookieToInitialState` | Not needed |

---

## Testing

### Mock AppKit in Tests

```typescript
// __tests__/views/Login.test.tsx
vi.mock("@/config/appkit", () => ({
  appKit: {
    open: vi.fn(),
  },
  wagmiConfig: mockWagmiConfig,
}));

it("should trigger AppKit modal on wallet login click", async () => {
  const { appKit } = await import("@/config/appkit");
  render(<Login />);
  
  await user.click(screen.getByText(/Login with wallet/i));
  
  expect(appKit.open).toHaveBeenCalled();
});
```

---

## Migration from Separate Wagmi Config

If you have an existing `wagmi.ts` file:

**Before**:
```typescript
// config/wagmi.ts
export const wagmiConfig = createConfig({...});

// main.tsx
import { wagmiConfig } from "@/config/wagmi";
```

**After**:
```typescript
// config/appkit.ts
export const wagmiConfig = wagmiAdapter.wagmiConfig;

// main.tsx
import { wagmiConfig } from "@/config/appkit";

// config/wagmi.ts (deprecated, re-exports for compatibility)
export { wagmiConfig } from "./appkit";
```

---

## Reference Links

- [AppKit Docs](https://reown.com/appkit)
- [AppKit GitHub](https://github.com/reown-com/appkit)
- [Wagmi Docs](https://wagmi.sh)
- [Pimlico Docs](https://docs.pimlico.io)
- [Viem Docs](https://viem.sh)

---

## Checklist

When integrating AppKit:

- [ ] Single Wagmi config from WagmiAdapter (no separate `createConfig`)
- [ ] Singleton pattern for AppKit initialization
- [ ] Use Wagmi hooks (`useAccount`), not AppKit hooks
- [ ] Dynamic metadata URL with `window.location.origin` fallback
- [ ] Environment variable `VITE_WALLETCONNECT_PROJECT_ID` configured
- [ ] Environment variable `VITE_APP_URL` configured
- [ ] Green Goods theme variables applied
- [ ] Import AppKit early in `main.tsx` (before rendering)
- [ ] Wallet connection synced to auth provider
- [ ] Passkey authentication remains primary method
