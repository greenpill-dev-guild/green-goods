---
description: Modal and drawer patterns ‚Äî ModalDrawer, ConfirmDrawer, ImagePreviewDialog, Radix Dialog standard
globs:
  - "**/Modal/**/*.tsx"
  - "**/Drawer/**/*.tsx"
  - "**/Dialog/**/*.tsx"
alwaysApply: false
---

# Modal & Drawer Components

Patterns for modals, drawers, dialogs, and popovers.

## When to Use What

### Native Popover (`popover` attribute)

**Use for non-modal, transient UI:**
- **Tooltips** - Address displays, info hints (use `popover="hint"`)
- **Dropdowns** - Notifications, menus, filters (use `popover="auto"`)
- **Simple overlays** - No form submission or complex interaction

**Benefits:**
- Browser-optimized top layer (no z-index management)
- Built-in light dismiss (click outside, Esc key)
- Automatic keyboard navigation
- Lighter weight than custom solutions

```typescript
// Tooltip example
<button popovertarget="address-tooltip">{display}</button>
<div id="address-tooltip" popover="hint">
  {fullAddress}
</div>

// Dropdown example
<button popovertarget="notifications">üîî</button>
<div id="notifications" popover="auto">
  <NotificationList />
</div>
```

### Radix Dialog (Standard for Complex Modals)

**Use for modal interactions that require:**
- **Form submission** - AddMemberModal, CreateGardenModal
- **Confirmation flows** - ConfirmDrawer, DeleteConfirmation
- **Multi-step workflows** - Onboarding, guided setup
- **Background should be inert** - Block interaction with page content

**Benefits:**
- Complete accessibility (ARIA, focus management, screen readers)
- Animation support with Radix primitives
- Portal management
- Composition with Radix Trigger, Close, etc.

```typescript
import * as Dialog from "@radix-ui/react-dialog";

<Dialog.Root>
  <Dialog.Trigger>Add Member</Dialog.Trigger>
  <Dialog.Portal>
    <Dialog.Overlay className="fixed inset-0 bg-black/60 backdrop-blur-sm" />
    <Dialog.Content className="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2">
      <Dialog.Title>Add Member</Dialog.Title>
      <form onSubmit={handleSubmit}>
        {/* Form fields */}
      </form>
    </Dialog.Content>
  </Dialog.Portal>
</Dialog.Root>
```

### Decision Tree

```
Is it a tooltip or simple hint?
  ‚Üí YES: Use popover="hint"
  
Is it a dropdown menu or notification list?
  ‚Üí YES: Use popover="auto"
  
Does it need form submission or confirmation?
  ‚Üí YES: Use Radix Dialog
  
Does it need multi-step interaction?
  ‚Üí YES: Use Radix Dialog
  
Should the background be inert (modal)?
  ‚Üí YES: Use Radix Dialog
  
Otherwise:
  ‚Üí Use popover="auto" (simpler)
```

## ModalDrawer

Responsive modal/drawer with optional tabs:

```typescript
<ModalDrawer
  isOpen={isOpen}
  onClose={onClose}
  header={{
    title: "Work Dashboard",
    description: "Sync status and pending items",
    actions: <SyncAllButton />,
  }}
  tabs={[
    { id: "pending", label: "Pending", count: pendingCount },
    { id: "completed", label: "Completed", count: completedCount },
  ]}
  activeTab={activeTab}
  onTabChange={setActiveTab}
  maxHeight="95vh"
>
  {renderTabContent()}
</ModalDrawer>
```

## ConfirmDrawer

Confirmation dialog for actions:

```typescript
<ConfirmDrawer
  isOpen={isOpen}
  onClose={onClose}
  title="Confirm Approval"
  description="Are you sure you want to approve this work?"
  confirmLabel="Approve"
  confirmVariant="primary"
  onConfirm={handleConfirm}
  isLoading={isSubmitting}
/>
```

## ImagePreviewDialog

Full-screen image preview with zoom:

```typescript
<ImagePreviewDialog
  isOpen={isOpen}
  onClose={onClose}
  images={mediaUrls}
  initialIndex={0}
/>
```

**Features:**
- Keyboard navigation (arrows, +/-, Escape)
- Pinch-to-zoom on touch devices
- Mouse wheel zoom
- Drag panning
- Download button

## Backdrop Pattern

```typescript
<div
  className="fixed inset-0 bg-overlay backdrop-blur-sm z-[7777]"
  onClick={onClose}
>
  <div
    className="bg-bg-white rounded-t-3xl shadow-2xl"
    onClick={(e) => e.stopPropagation()}
  >
    {/* Content */}
  </div>
</div>
```

## Focus Management

```typescript
useEffect(() => {
  if (!isOpen) return;

  // Focus first focusable element
  const firstFocusable = containerRef.current?.querySelector(
    "button, input, [tabindex]:not([tabindex='-1'])"
  ) as HTMLElement;
  firstFocusable?.focus();

  // Trap focus
  const handleKeyDown = (e: KeyboardEvent) => {
    if (e.key === "Tab") {
      trapFocus(e);
    }
    if (e.key === "Escape") {
      onClose();
    }
  };

  document.addEventListener("keydown", handleKeyDown);
  return () => document.removeEventListener("keydown", handleKeyDown);
}, [isOpen]);
```

## Scroll Lock

```typescript
useEffect(() => {
  if (isOpen) {
    document.body.style.overflow = "hidden";
  }
  return () => {
    document.body.style.overflow = "";
  };
}, [isOpen]);
```

## Animation

```typescript
<div
  className={cn(
    "transform transition-transform duration-300",
    isOpen ? "translate-y-0" : "translate-y-full"
  )}
>
```

## Responsive Behavior

```typescript
// Drawer on mobile, modal on desktop
<div
  className={cn(
    "fixed inset-x-0 bottom-0 rounded-t-3xl",
    "lg:inset-auto lg:top-1/2 lg:left-1/2 lg:-translate-x-1/2 lg:-translate-y-1/2",
    "lg:rounded-2xl lg:max-w-lg"
  )}
>
```

## Accessibility (WCAG 2.1 AA)

**All modals and dialogs MUST be fully accessible.** Follow these patterns:

### ARIA Attributes (MANDATORY)

```typescript
// ‚úÖ Correct ‚Äî proper ARIA for modal dialog
<Dialog.Content
  role="dialog"
  aria-modal="true"
  aria-labelledby={titleId}
  aria-describedby={descriptionId}
>
  <Dialog.Title id={titleId}>Add Member</Dialog.Title>
  <Dialog.Description id={descriptionId}>
    Enter the wallet address of the new member.
  </Dialog.Description>
  {/* Content */}
</Dialog.Content>

// ‚ùå Wrong ‚Äî missing ARIA attributes
<div className="modal">
  <h2>Add Member</h2>
  {/* No accessibility */}
</div>
```

### Alert Dialogs

```typescript
// For confirmation dialogs with destructive actions
<Dialog.Content
  role="alertdialog"
  aria-modal="true"
  aria-labelledby={titleId}
  aria-describedby={descriptionId}
>
  <Dialog.Title id={titleId}>Delete Garden?</Dialog.Title>
  <Dialog.Description id={descriptionId}>
    This action cannot be undone. All data will be permanently removed.
  </Dialog.Description>
  <div className="flex gap-3">
    <Dialog.Close asChild>
      <button>Cancel</button>
    </Dialog.Close>
    <button onClick={handleDelete}>Delete</button>
  </div>
</Dialog.Content>
```

### Focus Management (MANDATORY)

```typescript
function AccessibleModal({ isOpen, onClose, children, titleId }: Props) {
  const modalRef = useRef<HTMLDivElement>(null);
  const previousFocus = useRef<HTMLElement | null>(null);

  useEffect(() => {
    if (isOpen) {
      // Store current focus to restore later
      previousFocus.current = document.activeElement as HTMLElement;

      // Focus first focusable element in modal
      const firstFocusable = modalRef.current?.querySelector<HTMLElement>(
        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
      );
      firstFocusable?.focus();
    }

    return () => {
      // Restore focus when modal closes
      if (previousFocus.current && !isOpen) {
        previousFocus.current.focus();
      }
    };
  }, [isOpen]);

  return (
    <div
      ref={modalRef}
      role="dialog"
      aria-modal="true"
      aria-labelledby={titleId}
    >
      {children}
    </div>
  );
}
```

### Focus Trap (MANDATORY for Modals)

```typescript
function useFocusTrap(containerRef: RefObject<HTMLElement>, isActive: boolean) {
  useEffect(() => {
    if (!isActive || !containerRef.current) return;

    const container = containerRef.current;
    const focusableElements = container.querySelectorAll<HTMLElement>(
      'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
    );

    const firstFocusable = focusableElements[0];
    const lastFocusable = focusableElements[focusableElements.length - 1];

    const handleKeyDown = (e: KeyboardEvent) => {
      if (e.key !== "Tab") return;

      if (e.shiftKey) {
        // Shift+Tab: if on first element, wrap to last
        if (document.activeElement === firstFocusable) {
          e.preventDefault();
          lastFocusable?.focus();
        }
      } else {
        // Tab: if on last element, wrap to first
        if (document.activeElement === lastFocusable) {
          e.preventDefault();
          firstFocusable?.focus();
        }
      }
    };

    container.addEventListener("keydown", handleKeyDown);
    return () => container.removeEventListener("keydown", handleKeyDown);
  }, [containerRef, isActive]);
}
```

### Keyboard Navigation

```typescript
// Required keyboard support for all modals
const handleKeyDown = (e: KeyboardEvent) => {
  switch (e.key) {
    case "Escape":
      // Always close on Escape
      onClose();
      break;
    case "Tab":
      // Focus trap handles this
      break;
    case "Enter":
      // Submit form if applicable (handled by form)
      break;
  }
};

// For image preview dialogs
const handleImageKeyDown = (e: KeyboardEvent) => {
  switch (e.key) {
    case "ArrowLeft":
      goToPrevious();
      break;
    case "ArrowRight":
      goToNext();
      break;
    case "Escape":
      onClose();
      break;
    case "+":
    case "=":
      zoomIn();
      break;
    case "-":
      zoomOut();
      break;
  }
};
```

### Screen Reader Announcements

```typescript
// Announce modal opening/closing
function ModalAnnouncement({ isOpen, title }: { isOpen: boolean; title: string }) {
  return (
    <div
      role="status"
      aria-live="polite"
      aria-atomic="true"
      className="sr-only"
    >
      {isOpen && `${title} dialog opened`}
    </div>
  );
}

// Announce loading states within modals
function ModalWithLoading({ isLoading }: { isLoading: boolean }) {
  return (
    <Dialog.Content aria-busy={isLoading}>
      {isLoading && (
        <div role="status" aria-live="polite" className="sr-only">
          Processing your request...
        </div>
      )}
      {/* Content */}
    </Dialog.Content>
  );
}
```

### Background Inertness

```typescript
// ‚úÖ Correct ‚Äî Radix handles this automatically with Portal
<Dialog.Portal>
  <Dialog.Overlay />
  <Dialog.Content>
    {/* Background is automatically inert */}
  </Dialog.Content>
</Dialog.Portal>

// For custom modals, use inert attribute
useEffect(() => {
  if (isOpen) {
    // Make background content inert (not focusable, not announced)
    const mainContent = document.getElementById("main-content");
    mainContent?.setAttribute("inert", "");
    mainContent?.setAttribute("aria-hidden", "true");
  }
  return () => {
    const mainContent = document.getElementById("main-content");
    mainContent?.removeAttribute("inert");
    mainContent?.removeAttribute("aria-hidden");
  };
}, [isOpen]);
```

### Reduced Motion Support

```typescript
// Respect user's motion preferences
const prefersReducedMotion = window.matchMedia(
  "(prefers-reduced-motion: reduce)"
).matches;

<div
  className={cn(
    "transform",
    prefersReducedMotion
      ? "" // No animation
      : "transition-transform duration-300",
    isOpen ? "translate-y-0" : "translate-y-full"
  )}
>
```

```css
/* CSS approach (preferred) */
@media (prefers-reduced-motion: reduce) {
  [data-radix-dialog-content],
  [data-radix-dialog-overlay] {
    animation-duration: 0.01ms !important;
    transition-duration: 0.01ms !important;
  }
}
```

### Modal Accessibility Checklist

- [ ] `role="dialog"` or `role="alertdialog"` present
- [ ] `aria-modal="true"` set
- [ ] `aria-labelledby` points to visible title
- [ ] `aria-describedby` points to description (if present)
- [ ] Focus moves to modal on open
- [ ] Focus is trapped within modal
- [ ] Focus returns to trigger element on close
- [ ] Escape key closes modal
- [ ] Background content is inert
- [ ] Reduced motion preferences respected
- [ ] Loading states announced to screen readers
- [ ] Close button has accessible name

### Accessible Close Button

```typescript
// ‚úÖ Correct ‚Äî accessible close button
<Dialog.Close asChild>
  <button
    aria-label="Close dialog"
    className="absolute top-4 right-4 p-2"
  >
    <RiCloseLine className="h-6 w-6" aria-hidden="true" />
  </button>
</Dialog.Close>

// ‚ùå Wrong ‚Äî icon-only button without label
<button onClick={onClose}>
  <RiCloseLine />
</button>
```

### Touch Target Size

```typescript
// Ensure touch targets are at least 44x44px
<Dialog.Close asChild>
  <button className="min-h-[44px] min-w-[44px] p-2 -m-2">
    <RiCloseLine className="h-6 w-6" aria-hidden="true" />
    <span className="sr-only">Close</span>
  </button>
</Dialog.Close>
```

## Anti-Patterns

```typescript
// ‚ùå Wrong ‚Äî missing backdrop click handler
<div className="fixed inset-0">
  <Modal />
</div>

// ‚úÖ Correct ‚Äî backdrop closes modal
<div className="fixed inset-0" onClick={onClose}>
  <div onClick={(e) => e.stopPropagation()}>
    <Modal />
  </div>
</div>
```

```typescript
// ‚ùå Wrong ‚Äî missing focus trap
<Modal>
  <button>Action</button>
</Modal>

// ‚úÖ Correct ‚Äî focus trapped
<Modal>
  <FocusTrap>
    <button>Action</button>
  </FocusTrap>
</Modal>
```

```typescript
// ‚ùå Wrong ‚Äî no ARIA attributes
<div className="modal-overlay">
  <div className="modal-content">
    <h2>Title</h2>
    <p>Description</p>
  </div>
</div>

// ‚úÖ Correct ‚Äî proper ARIA structure
<div
  role="dialog"
  aria-modal="true"
  aria-labelledby="modal-title"
  aria-describedby="modal-desc"
>
  <h2 id="modal-title">Title</h2>
  <p id="modal-desc">Description</p>
</div>
```

## Popover Types Reference

Per [web.dev/learn/css/popover-and-dialog](https://web.dev/learn/css/popover-and-dialog):

### Auto Popovers (`popover="auto"`)

**Behavior:**
- Closes other auto popovers when opened
- Supports light dismiss (click outside, Esc key)
- Can be nested in a stack
- Opening closes all hint popovers

**Use cases:**
- Notification dropdowns
- Menu lists
- Filter panels

### Hint Popovers (`popover="hint"`)

**Behavior:**
- Multiple can be open simultaneously
- Light dismiss support
- Opening does NOT close auto popovers
- Lower priority than auto popovers

**Use cases:**
- Tooltips
- Contextual help text
- Info icons

### Manual Popovers (`popover="manual"`)

**Behavior:**
- Must be explicitly closed (no light dismiss)
- Multiple can be open
- Full control over open/close behavior

**Use cases:**
- Custom popover logic (rare)
- Use Radix Dialog instead for most modal cases

## Popover Animations

Popovers support CSS transitions via `:popover-open` pseudo-class:

```css
/* Opening animation */
[popover]:popover-open {
  opacity: 1;
  transform: scale(1);
  transition: opacity 0.2s, transform 0.2s, 
              overlay 0.2s allow-discrete, 
              display 0.2s allow-discrete;
}

@starting-style {
  [popover]:popover-open {
    opacity: 0;
    transform: scale(0.95);
  }
}

/* Closing animation */
[popover] {
  opacity: 0;
  transform: scale(0.95);
  transition: opacity 0.2s, transform 0.2s;
}
```

## Reference Files

### Dialogs (Radix Standard)
- Hero install instructions: `src/components/Layout/Hero.tsx` (Radix Dialog)
- Custom drawers to migrate: `src/components/Dialogs/ModalDrawer.tsx`
- Confirmation drawer: `src/components/Dialogs/ConfirmDrawer.tsx`
- Image preview: `src/components/Dialogs/ImagePreviewDialog.tsx`

### Popovers (Native)
- Tooltip example: `packages/admin/src/components/AddressDisplay.tsx`
- Notification dropdown: `src/components/Navigation/TopNav.tsx`
- Popover styles: `src/styles/utilities.css`

### Admin Package
- Members modal: `packages/admin/src/components/Garden/MembersModal.tsx`
- Add member modal: `packages/admin/src/components/Garden/AddMemberModal.tsx`
