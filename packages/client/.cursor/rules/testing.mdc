---
description: Client-specific testing patterns
globs:
  - "packages/client/src/__tests__/**"
alwaysApply: false
---

# Client Testing

Client-specific test patterns. Common patterns are in `shared/.cursor/rules/testing-patterns.mdc`.

## Visual Reference

See [E2E Test Flow](docs/developer/architecture/diagrams.md#e2e-test-flow) for the Playwright test execution lifecycle.

## Test Structure

```
src/__tests__/
├── components/         # Component unit tests
├── views/              # View integration tests
├── routes/             # Route guard tests
├── integration/        # Multi-component flows
├── offline-test-helpers.ts
└── setupTests.ts
```

## Coverage Targets

| Area | Target |
|------|--------|
| **Critical paths** | 80%+ |
| **Overall** | 70%+ |
| **Offline queue** | 80%+ |
| **Auth flows** | 100% |

## Component Testing

```typescript
import { render, screen } from "@testing-library/react";
import userEvent from "@testing-library/user-event";

describe("WorkCard", () => {
  it("displays work details", () => {
    render(<WorkCard work={mockWork} />);
    expect(screen.getByText("Plant Trees")).toBeInTheDocument();
  });

  it("calls onClick when clicked", async () => {
    const onClick = vi.fn();
    const user = userEvent.setup();
    
    render(<WorkCard work={mockWork} onClick={onClick} />);
    await user.click(screen.getByRole("button"));
    
    expect(onClick).toHaveBeenCalled();
  });
});
```

## View Testing

```typescript
import { render, screen, waitFor } from "@testing-library/react";
import { MemoryRouter } from "react-router-dom";

describe("Garden View", () => {
  it("displays garden details", async () => {
    render(
      <MemoryRouter initialEntries={["/home/0x123"]}>
        <TestProviders>
          <Routes>
            <Route path="/home/:id" element={<Garden />} />
          </Routes>
        </TestProviders>
      </MemoryRouter>
    );

    await waitFor(() => {
      expect(screen.getByText("Community Garden")).toBeInTheDocument();
    });
  });
});
```

## Offline Testing

```typescript
import { jobQueue, jobQueueDB } from "@green-goods/shared";

describe("Offline Work Submission", () => {
  beforeEach(async () => {
    await jobQueueDB.clear();
  });

  it("queues work when offline", async () => {
    vi.spyOn(navigator, "onLine", "get").mockReturnValue(false);

    const { result } = renderHook(() => useWorkMutation(), {
      wrapper: TestProviders,
    });

    await act(async () => {
      await result.current.mutateAsync(mockDraft);
    });

    const stats = await jobQueue.getStats();
    expect(stats.pending).toBe(1);
  });
});
```

## Auth Mocking

```typescript
const mockAuth = {
  authMode: "passkey" as const,
  isAuthenticated: true,
  isReady: true,
  smartAccountClient: mockSmartAccountClient,
  loginWithPasskey: vi.fn(),
  signOut: vi.fn(),
};

vi.mock("@green-goods/shared", async () => {
  const actual = await vi.importActual("@green-goods/shared");
  return {
    ...actual,
    useAuth: () => mockAuth,
  };
});
```

## Test Providers

```typescript
// __tests__/test-utils.tsx
export function TestProviders({ children }: { children: React.ReactNode }) {
  const queryClient = new QueryClient({
    defaultOptions: { queries: { retry: false } },
  });

  return (
    <QueryClientProvider client={queryClient}>
      <AuthContext.Provider value={mockAuth}>
        <MemoryRouter>{children}</MemoryRouter>
      </AuthContext.Provider>
    </QueryClientProvider>
  );
}
```

## E2E with Playwright

Critical flows to test:

1. Login → Create work → Offline save → Reconnect → Sync
2. Operator approval flow
3. PWA install flow

```bash
# Run E2E tests
bunx playwright test

# Visual mode
bunx playwright test --ui
```

## Anti-Patterns

```typescript
// ❌ Wrong — testing implementation
expect(component.state.isLoading).toBe(false);

// ✅ Correct — testing behavior
expect(screen.queryByRole("progressbar")).not.toBeInTheDocument();
```

```typescript
// ❌ Wrong — arbitrary waits
await new Promise((r) => setTimeout(r, 1000));

// ✅ Correct — wait for condition
await waitFor(() => {
  expect(screen.getByText("Success")).toBeInTheDocument();
});
```

## Reference

- Common patterns: `shared/.cursor/rules/testing-patterns.mdc`
- Test setup: `src/__tests__/setupTests.ts`
- Offline helpers: `src/__tests__/offline-test-helpers.ts`
