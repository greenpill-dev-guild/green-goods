---
description: Authentication patterns — passkey-first, WebAuthn, Pimlico, smart accounts, wallet fallback
globs:
  - "packages/shared/src/providers/Auth.tsx"
  - "packages/shared/src/hooks/auth/**"
  - "packages/shared/src/modules/auth/**"
  - "packages/client/src/routes/RequireAuth.tsx"
  - "packages/client/src/routes/RequireInstalled.tsx"
alwaysApply: false
---

# Authentication & Account Abstraction

Green Goods uses **passkey-first authentication** with WebAuthn credentials and Kernel smart accounts via Pimlico. Wallet connection provides fallback for operators and admins.

## Unified Auth Architecture

The auth system uses a single `AuthProvider` (XState-based) that supports both passkey and wallet authentication modes.

### Storage Keys (Only 2)

```typescript
// packages/shared/src/modules/auth/session.ts
export const PASSKEY_STORAGE_KEY = "greengoods_passkey_credential";  // WebAuthn credential
export const AUTH_MODE_STORAGE_KEY = "greengoods_auth_mode";         // "passkey" | "wallet"
```

### Core API

```typescript
import { useAuth } from '@green-goods/shared/hooks';

const {
  loginWithPasskey,   // Create/authenticate passkey
  loginWithWallet,    // Open wallet modal  
  signOut,            // Clear all auth

  authMode,           // "passkey" | "wallet" | null
  isAuthenticated,
  isReady,
  eoaAddress,         // Wallet address (wallet mode)
  smartAccountAddress, // Smart account address (passkey mode)
  smartAccountClient,  // Smart account client (passkey mode)
} = useAuth();
```

## Provider Hierarchy

```tsx
// packages/client/src/main.tsx
<AppErrorBoundary>
  <AppKitProvider>        {/* WagmiProvider */}
    <AuthProvider>        {/* Unified XState auth - passkey + wallet */}
      <AppProvider>       {/* QueryClient + IntlProvider */}
        <App />
      </AppProvider>
    </AuthProvider>
  </AppKitProvider>
</AppErrorBoundary>
```

## Authentication Modes

```typescript
export type AuthMode = 'passkey' | 'wallet' | null;
```

### Passkey Mode (Primary)

**For:** Gardeners, general users
**Tech:** WebAuthn + viem/account-abstraction + Kernel + Pimlico
**UX:** Biometric authentication, no seed phrases, sponsored transactions

### Wallet Mode (Fallback)

**For:** Operators, admins, power users
**Tech:** Wagmi + Reown AppKit + MetaMask/WalletConnect
**UX:** Traditional wallet connection

## Login Flow Implementation

```typescript
// packages/client/src/views/Login/index.tsx
export function Login() {
  const {
    loginWithPasskey,
    loginWithWallet,
    isAuthenticating,
    isAuthenticated,
    isReady,
  } = useAuth();

  const handlePasskeyLogin = async () => {
    const session = await loginWithPasskey?.();
    // Auto-redirect handled by isAuthenticated check
  };

  const handleWalletLogin = () => {
    loginWithWallet?.();  // Opens AppKit modal
  };

  if (!isReady) return <LoadingScreen />;
  if (isAuthenticated) return <Navigate to="/home" />;

  return (
    <Splash
      login={handlePasskeyLogin}
      isLoggingIn={isAuthenticating}
      secondaryAction={{ label: "Login with wallet", onSelect: handleWalletLogin }}
    />
  );
}
```

## Auth Mode Branching for Transactions

```typescript
const { authMode, smartAccountClient } = useAuth();

if (authMode === 'wallet') {
  // Direct wallet submission
  const hash = await submitWorkDirectly(draft, gardenAddress, actionUID);
} else {
  // Passkey mode - use job queue
  const { txHash, jobId } = await submitWorkToQueue(draft, gardenAddress, actionUID);
  
  if (smartAccountClient) {
    await processWorkJobInline(jobId, chainId, smartAccountClient);
  }
}
```

## Route Guards

```typescript
// packages/client/src/routes/RequireAuth.tsx
export default function RequireAuth() {
  const { isAuthenticated, isReady } = useAuth();
  const location = useLocation();

  if (!isReady) return null;

  if (!isAuthenticated) {
    const redirectTo = encodeURIComponent(location.pathname + location.search);
    return <Navigate to={`/login?redirectTo=${redirectTo}`} replace />;
  }

  return <Outlet />;
}
```

## Anti-Patterns

### ❌ Don't skip isReady check

```typescript
// Wrong
const { smartAccountClient } = useAuth();
await smartAccountClient.sendTransaction({/*...*/});

// Correct
const { smartAccountClient, isReady } = useAuth();
if (!isReady || !smartAccountClient) return;
await smartAccountClient.sendTransaction({/*...*/});
```

### ❌ Don't use wallet chain ID

```typescript
// Wrong - wallet may be on wrong chain
const { chainId } = useAccount();

// Correct - use environment chain
import { DEFAULT_CHAIN_ID } from '@green-goods/shared';
```

## Testing Authentication

```typescript
// Mock auth for testing
vi.mock('@green-goods/shared/hooks', () => ({
  useAuth: () => ({
    authMode: 'passkey',
    isAuthenticated: true,
    isReady: true,
    loginWithPasskey: vi.fn(),
    loginWithWallet: vi.fn(),
    signOut: vi.fn(),
  }),
}));
```

## Reference Files

**Provider:**
- `packages/shared/src/providers/Auth.tsx` — Unified XState auth provider

**Session:**
- `packages/shared/src/modules/auth/session.ts` — Storage utilities (2 keys only)
- `packages/shared/src/modules/auth/passkey.ts` — WebAuthn credential management

**Hooks:**
- `packages/shared/src/hooks/auth/useAuth.ts` — Universal auth hook
- `packages/shared/src/hooks/auth/useUser.ts` — User info hook

**Route Guards:**
- `packages/client/src/routes/RequireAuth.tsx`
- `packages/client/src/routes/RequireInstalled.tsx`

**Login:**
- `packages/client/src/views/Login/index.tsx`
