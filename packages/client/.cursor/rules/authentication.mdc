---
description: Authentication patterns — passkey-first, WebAuthn, Pimlico, smart accounts, wallet fallback
globs:
  - "packages/client/src/views/Login/**"
  - "packages/client/src/routes/RequireAuth.tsx"
alwaysApply: false
---

# Authentication

Green Goods uses **passkey-first authentication** with WebAuthn and Kernel smart accounts. Wallet connection is fallback for operators/admins.

## Visual Reference

See [Auth Flow Diagram](docs/developer/architecture/diagrams.md#auth-flow) for the complete passkey vs wallet branching logic.

## Auth Modes

| Mode | Users | Technology | UX |
|------|-------|------------|-----|
| **Passkey** | Gardeners | WebAuthn + Kernel + Pimlico | Biometric, no seed phrases |
| **Wallet** | Operators, admins | Wagmi + AppKit | Traditional wallet |

## Storage Keys

```typescript
// packages/shared/src/modules/auth/session.ts
PASSKEY_STORAGE_KEY = "greengoods_passkey_credential"  // WebAuthn credential
AUTH_MODE_STORAGE_KEY = "greengoods_auth_mode"         // "passkey" | "wallet"
USERNAME_STORAGE_KEY = "greengoods_username"           // Pimlico server username
RP_ID_STORAGE_KEY = "greengoods_rp_id"                 // Relying Party ID (Android)
```

**RP ID is critical for Android:** The RP ID stored during registration must match during authentication. Android is strict about this.

## Using Auth

```typescript
import { useAuth } from "@green-goods/shared";

const {
  authMode,           // "passkey" | "wallet" | null
  isAuthenticated,
  isReady,
  loginWithPasskey,
  loginWithWallet,
  signOut,
  smartAccountClient, // Passkey mode only
  smartAccountAddress,// Passkey mode only
  eoaAddress,         // Wallet mode only
} = useAuth();
```

## Login Flow

```typescript
function Login() {
  const { loginWithPasskey, loginWithWallet, isAuthenticated, isReady } = useAuth();

  if (!isReady) return <LoadingScreen />;
  if (isAuthenticated) return <Navigate to="/home" />;

  return (
    <Splash
      login={() => loginWithPasskey?.()}
      secondaryAction={{ label: "Wallet", onSelect: () => loginWithWallet?.() }}
    />
  );
}
```

## Auth Mode Branching

```typescript
const { authMode, smartAccountClient } = useAuth();

if (authMode === "wallet") {
  // Direct wallet transaction
  await submitWorkDirectly(draft, gardenAddress, actionUID);
} else {
  // Passkey — use job queue
  const { txHash, jobId } = await submitWorkToQueue(draft, gardenAddress, actionUID);
  if (smartAccountClient) {
    await processWorkJobInline(jobId, chainId, smartAccountClient);
  }
}
```

## Route Guards

```typescript
// RequireAuth.tsx
export default function RequireAuth() {
  const { isAuthenticated, isReady } = useAuth();

  if (!isReady) return null;
  if (!isAuthenticated) {
    return <Navigate to="/login" replace />;
  }

  return <Outlet />;
}
```

## Provider Hierarchy

```tsx
<AppKitProvider>
  <QueryClientProvider>
    <AuthProvider>       {/* XState auth machine */}
      <AppProvider>
        <App />
      </AppProvider>
    </AuthProvider>
  </QueryClientProvider>
</AppKitProvider>
```

## Anti-Patterns

```typescript
// ❌ Wrong — missing isReady check
const { smartAccountClient } = useAuth();
await smartAccountClient.sendTransaction({...});

// ✅ Correct — guard with isReady
const { smartAccountClient, isReady } = useAuth();
if (!isReady || !smartAccountClient) return;
await smartAccountClient.sendTransaction({...});
```

```typescript
// ❌ Wrong — using wallet chain
const { chainId } = useAccount();

// ✅ Correct — use environment chain
import { DEFAULT_CHAIN_ID } from "@green-goods/shared";
```

## Testing

```typescript
vi.mock("@green-goods/shared", () => ({
  useAuth: () => ({
    authMode: "passkey",
    isAuthenticated: true,
    isReady: true,
    smartAccountClient: mockClient,
    loginWithPasskey: vi.fn(),
    signOut: vi.fn(),
  }),
}));
```

## Reference

- Auth Provider: `packages/shared/src/providers/Auth.tsx`
- Session utilities: `packages/shared/src/modules/auth/session.ts`
- Passkey config: `packages/shared/src/config/passkeyServer.ts`
- AppKit integration: `shared/.cursor/rules/appkit-integration.mdc`
