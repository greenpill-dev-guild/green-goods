---
description: Offline-first architecture — job queue patterns for client
globs:
  - "packages/client/src/views/**"
  - "packages/client/src/components/**"
alwaysApply: false
---

# Offline-First Architecture

Client-specific patterns for using the offline job queue system.

**Core modules live in `@green-goods/shared`.** See `shared/.cursor/rules/state-patterns.mdc` for job queue internals.

## Visual Reference

See [Work Submission Flow](docs/developer/architecture/diagrams.md#work-submission) for the complete offline → online → indexed sequence.

## Core Principle

**Event-driven, no polling:**

```typescript
// ✅ Correct — react to events
import { useJobQueueEvents, queryKeys } from "@green-goods/shared";

useJobQueueEvents(["job:completed"], () => {
  queryClient.invalidateQueries({ queryKey: queryKeys.works.merged(gardenId, chainId) });
});

// ❌ Wrong — no setInterval
setInterval(() => queryClient.invalidateQueries(), 5000);
```

## Submitting Work Offline

```typescript
import { submitWorkToQueue, jobQueue } from "@green-goods/shared";

const handleSubmit = async () => {
  // 1. Validate
  const errors = validateWorkDraft(draft, gardenAddress, actionUID, images);
  if (errors.length > 0) {
    toast.error(errors[0]);
    return;
  }

  // 2. Add to queue (persists to IndexedDB)
  const { txHash, jobId } = await submitWorkToQueue(
    draft,
    gardenAddress,
    actionUID,
    actions,
    DEFAULT_CHAIN_ID,
    images
  );

  // 3. Auto-process if client available
  if (smartAccountClient) {
    try {
      await processWorkJobInline(jobId, chainId, smartAccountClient);
    } catch {
      // Job remains queued for later
    }
  }

  // 4. Navigate with offline tx hash
  navigate(`/home`);
  sessionStorage.setItem("openWorkDashboard", "true");
};
```

## Media URL Management

```typescript
import { mediaResourceManager } from "@green-goods/shared";

// Create tracked URLs (stable across re-renders)
const url = mediaResourceManager.getOrCreateUrl(file, "work-draft");

// Cleanup on unmount
useEffect(() => {
  return () => mediaResourceManager.cleanupUrls("work-draft");
}, []);
```

**Tracking IDs:**
- `work-draft` — Work form images
- `job-{jobId}` — Job-specific images

## Listening for Job Events

```typescript
import { useJobQueueEvents, jobQueueEventBus } from "@green-goods/shared";

// React hook for components
useJobQueueEvents(["job:completed", "job:failed"], (event) => {
  if (event.type === "job:completed") {
    toast.success("Work submitted!");
  }
});

// Direct subscription in providers
const unsubscribe = jobQueueEventBus.on("job:processing", ({ jobId }) => {
  toast.loading("Uploading...", { id: jobId });
});
```

## Queue Statistics

```typescript
import { usePendingWorksCount, useQueueStatistics } from "@green-goods/shared";

const { data: pendingCount } = usePendingWorksCount();
const { data: stats } = useQueueStatistics();
// stats = { pending, synced, failed }
```

## Work Dashboard

The WorkDashboard modal shows pending and completed work:

```typescript
<WorkDashboardIcon pendingCount={pendingCount} />

// Auto-open after submission
useEffect(() => {
  if (sessionStorage.getItem("openWorkDashboard")) {
    sessionStorage.removeItem("openWorkDashboard");
    setIsOpen(true);
  }
}, []);
```

## Offline Indicator

```typescript
import { useOffline } from "@green-goods/shared";

function OfflineBanner() {
  const isOffline = useOffline();

  if (!isOffline) return null;

  return (
    <div className="bg-warning-lighter text-warning-dark px-4 py-2">
      You're offline. Work will sync when connected.
    </div>
  );
}
```

## Sync Triggers

Jobs sync automatically on:
1. **Online event** — Browser reconnects
2. **Inline processing** — Smart account client available
3. **Service worker** — Background sync message
4. **Manual flush** — User action from WorkDashboard

## Work Merging

Merge online (blockchain) and offline (local) work:

```typescript
import { useMyMergedWorks } from "@green-goods/shared";

const { data: works } = useMyMergedWorks(gardenId, chainId);
// Returns combined list with offline works marked
```

## Toast Patterns

Use consistent toast IDs for job status updates:

```typescript
// Loading → Success/Error replacement
toast.loading("Uploading work...", { id: `job-${jobId}` });
// Later:
toast.success("Work uploaded!", { id: `job-${jobId}` });
// Or:
toast.error("Upload failed", { id: `job-${jobId}` });
```

## Anti-Patterns

```typescript
// ❌ Creating orphan blob URLs
const url = URL.createObjectURL(file);
setImageUrl(url);
// Never revoked → memory leak

// ✅ Use MediaResourceManager
const url = mediaResourceManager.getOrCreateUrl(file, "tracking-id");

// ❌ Polling for updates
setInterval(() => refetch(), 5000);

// ✅ Event-driven
useJobQueueEvents(["job:completed"], refetch);

// ❌ Empty sync toasts
toast.success("Synced!"); // Even when 0 items

// ✅ Guard empty syncs
if (pendingCount > 0) {
  toast.success(`Synced ${count} items`);
}
```

## Query Key Usage

Always use centralized keys:

```typescript
import { queryKeys } from "@green-goods/shared";

// ✅ Correct
queryClient.invalidateQueries({ queryKey: queryKeys.works.merged(gardenId, chainId) });
queryClient.invalidateQueries({ queryKey: queryKeys.queue.stats() });

// ❌ Wrong — ad-hoc keys
queryClient.invalidateQueries({ queryKey: ["works", gardenId] });
```

## Reference

- Job Queue module: `packages/shared/src/modules/job-queue/`
- Work submission: `packages/shared/src/modules/work/`
- JobQueueProvider: `packages/shared/src/providers/JobQueue.tsx`
- State patterns: `shared/.cursor/rules/state-patterns.mdc`
