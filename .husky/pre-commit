#!/usr/bin/env sh
set -eu

# Enable pipefail only if supported (dash doesn't support it)
(set -o pipefail) 2>/dev/null && set -o pipefail

# Add common package manager bin paths to PATH
export PATH="$HOME/.bun/bin:$HOME/.local/bin:$PATH"

# Only try nvm when running in bash (nvm isn't POSIX-sh safe)
if [ -n "${BASH_VERSION-}" ] && [ -f .nvmrc ]; then
  export NVM_DIR="${NVM_DIR:-$HOME/.nvm}"
  if [ -s "$NVM_DIR/nvm.sh" ]; then
    . "$NVM_DIR/nvm.sh"
    nvm use --silent >/dev/null 2>&1 || true
  fi
fi

# Run lint-staged (bun first, npm fallback)
if command -v bun >/dev/null 2>&1; then
  bunx lint-staged
elif command -v npm >/dev/null 2>&1; then
  npx lint-staged
else
  echo "Error: Neither bun nor npm found. Install bun: https://bun.sh"
  exit 1
fi
